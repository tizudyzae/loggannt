<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Logile Rota Viewer — HTML Demo</title>
  <style>
    :root {
      --page-bg:#fff;
      --ink:#111;
      --muted:#555;
      --grid:#d4d4d4;
      --axis:#888;
      --accent:#4a4a4a;
      --sheet-bg:#fff;
      --sheet-border:#000;
      --sheet-header-band:#efefef;
      --sheet-title-size:26px;
      --sheet-range-size:22px;
      --sheet-code-size:21px;
      --sheet-date-size:16px;
      --sheet-footer-size:12px;
      --column-header-size:12px;
      --column-header-color:#111111;
      --row-label-size:12px;
      --bar-label-size:11px;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:0;font:12px/1.35 "Arial","Helvetica Neue",Helvetica,sans-serif;color:var(--ink);background:var(--page-bg)}
    h1{font-size:26px;margin:0;font-weight:600;color:var(--ink)}
    p{color:var(--muted);margin:6px 0 20px}
    .wrap{max-width:1200px;margin:0 auto;padding:24px 32px;width:100%;display:flex;flex-direction:column;gap:24px}
    .layout{display:flex;flex-wrap:wrap;gap:24px;align-items:flex-start}
    .side-panel{flex:0 0 320px;min-width:260px;display:flex;flex-direction:column;gap:16px}
    .main-panel{flex:1 1 0%;min-width:280px;display:flex;flex-direction:column;gap:20px}
    .controls{display:flex;flex-direction:column;gap:12px;align-items:stretch;border:1px solid #cfcfcf;padding:16px 18px;border-radius:10px;background:#fafafa;box-shadow:0 2px 6px rgba(0,0,0,.05);[...]
    .btn{appearance:none;border:1px solid #2d4a83;border-radius:4px;padding:9px 14px;background:linear-gradient(180deg,#4867a9,#324a7a);color:#fff;font-weight:600;cursor:pointer;letter-spacing:.2p[...]  
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <h1>Logile rota viewer</h1>
      <p>Upload your weekly export to explore a mobile-friendly schedule and generate printable PDF sheets. Preview every day, focus on individual colleagues, and share polished reports in a few clicks.</p>
      <!-- Upload CSV moved to top for prominence -->
      <input type="file" id="fileInput" accept=".csv,text/csv" hidden>
      <div style="margin-top:12px">
        <button class="btn" id="btnUpload" type="button">Upload CSV</button>
      </div>
    </header>

    <div class="layout">
      <aside class="side-panel">
        <div class="controls">
          <div class="side" style="display:flex;flex-direction:column;gap:12px">
            <!-- Keep original export button as the week-export implementation target but hidden; visible export control will appear with PDF preview -->
            <button class="btn" id="btnExport" style="background:linear-gradient(180deg,#f59e0b,#d97706);display:none">Export PDF</button>

            <!-- Colleague selection (renamed and includes All colleagues option) -->
            <div class="panel panel-static">
              <div class="ctrl">
                <label style="font-weight:600;color:var(--muted)">Colleague</label>
                <select id="selColleague" disabled>
                  <option value="ALL">All colleagues</option>
                </select>
              </div>
            </div>

            <!-- Hidden legacy individual export button preserved for backwards compatibility with script wiring -->
            <button class="btn" id="btnExportIndividual" style="display:none" disabled>Export individual PDF</button>

            <!-- Appearance & Layout hidden for now -->
            <details class="panel" hidden>
              <summary>Appearance &amp; Layout</summary>
              <div class="panel-body">
                <!-- existing appearance controls remain here but hidden via the details element -->
                <div class="ctrl-grid">
                  <label class="ctrl">
                    <span>Sheet title</span>
                    <input type="text" id="inpTitle" value="Daily Colleague Summary">
                  </label>
                  <label class="ctrl">
                    <span>Subtitle override</span>
                    <input type="text" id="inpSubtitle" placeholder="Leave blank to auto-fill">
                  </label>
                  <label class="ctrl">
                    <span>Static code</span>
                    <input type="text" id="inpStaticCode" value="7774">
                  </label>
                  <label class="ctrl">
                    <span>Footer template</span>
                    <input type="text" id="inpFooter" value="Page {page} of {total}">
                    <small>Use {page}, {total}, {date}, {label}</small>
                  </label>
                  <label class="ctrl">
                    <span>Footer note</span>
                    <input type="text" id="inpFooterNote" placeholder="Optional text shown under chart">
                  </label>
                </div>
                <!-- other appearance controls omitted for brevity but remain in file originally -->
              </div>
            </details>

          </div>
        </div>
      </aside>
      <main class="main-panel">
        <div class="viewer">
          <div class="viewer-tabs" role="tablist" aria-label="Preview modes">
            <button class="viewer-tab active" id="tabSchedule" type="button" role="tab" aria-selected="true" aria-controls="viewSchedule" data-view="schedule">Schedule view</button>
            <button class="viewer-tab" id="tabPdf" type="button" role="tab" aria-selected="false" aria-controls="viewPdf" data-view="pdf">PDF preview</button>
          </div>
          <section id="viewSchedule" class="view-panel active" role="tabpanel" aria-labelledby="tabSchedule">
            <div id="scheduleView" class="schedule-view"></div>
          </section>
          <section id="viewPdf" class="view-panel" role="tabpanel" aria-labelledby="tabPdf">
            <!-- Export options for PDF — displayed above the preview when PDF tab is active -->
            <div id="pdfControls" style="display:none;border:1px solid #cfd5e2;border-radius:6px;background:#fff;padding:12px;margin-bottom:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label style="font-weight:600;color:var(--muted)">Export</label>
              <button class="btn" id="btnExportPrimary" style="background:linear-gradient(180deg,#f59e0b,#d97706)">Export PDF</button>
              <div style="color:var(--muted);font-size:13px">(Produces week PDF when "All colleagues" selected, or individual PDF when a single colleague is selected.)</div>
            </div>

            <div class="sheets" id="sheets"></div>
          </section>
        </div>
        <div class="footer">Client‑side only. Uses pdf-lib to turn the SVG output into shareable landscape PDFs.</div>
      </main>
    </div>
    <textarea id="input" hidden></textarea>
  </div>

  <script src="pdf-lib.min.js"></script>
  <script>
    // DOM adjustments and wiring to implement layout changes without touching the main rendering logic.
    (function(){
      // Move existing upload button into header if not already (handled in markup) — ensure file input exists
      const fileInput=document.getElementById('fileInput');
      const btnUpload=document.getElementById('btnUpload');

      // Ensure colleague select has an "All colleagues" option and expose old id alias for compatibility
      const sel=document.getElementById('selColleague');
      if(sel){
        // add All colleagues if missing
        if(!Array.from(sel.options).some(o=>o.value==='ALL')){
          const opt=document.createElement('option');opt.value='ALL';opt.textContent='All colleagues';sel.insertBefore(opt,sel.firstChild);
        }
        // Backwards compatibility: some scripts may expect selIndividual id — create a reference on window
        window.selIndividual = sel; // scripts that reference variable selIndividual will work
        window.selColleague = sel;
      }

      // Ensure legacy buttons exist
      const legacyExport=document.getElementById('btnExport');
      const legacyExportIndividual=document.getElementById('btnExportIndividual');

      // Show/hide pdfControls when PDF tab selected
      const tabPdf=document.getElementById('tabPdf');
      const tabSchedule=document.getElementById('tabSchedule');
      const pdfControls=document.getElementById('pdfControls');
      const sheets=document.getElementById('sheets');

      function activateTab(tabId){
        document.querySelectorAll('.viewer-tab').forEach(btn=>{
          const is=(btn.id===tabId);
          btn.classList.toggle('active',is);
          btn.setAttribute('aria-selected',is?"true":"false");
          const view=btn.getAttribute('data-view');
          const panel=document.getElementById(view==='pdf'?'viewPdf':'viewSchedule');
          if(panel) panel.classList.toggle('active',is);
        });
        // toggle export controls visibility
        const activeIsPdf = tabId==='tabPdf';
        if(pdfControls) pdfControls.style.display = activeIsPdf ? 'flex' : 'none';
      }

      if(tabPdf){
        tabPdf.addEventListener('click',()=>activateTab('tabPdf'));
      }
      if(tabSchedule){
        tabSchedule.addEventListener('click',()=>activateTab('tabSchedule'));
      }

      // Wire primary export button to call the appropriate (legacy) export action
      const btnPrimary=document.getElementById('btnExportPrimary');
      if(btnPrimary){
        btnPrimary.addEventListener('click',()=>{
          const selEl=window.selColleague || window.selIndividual || document.getElementById('selColleague');
          const val = selEl?selEl.value:'ALL';
          if(val==='ALL' || !val){
            // trigger week export (legacy btnExport)
            if(legacyExport) legacyExport.click();
            else alert('Week export not available');
          } else {
            // set up legacy selection expected by individual export code — many parts of the code reference selIndividual value or selection index
            try{
              // If existing code expects a selectedIndex or value on selIndividual, ensure it's set
              if(window.selIndividual){
                window.selIndividual.value = val;
              }
              if(legacyExportIndividual){
                legacyExportIndividual.click();
              } else {
                alert('Individual export not available');
              }
            }catch(e){
              console.error(e);
              alert('Export failed: '+e.message);
            }
          }
        });
      }

    })();

    // ---------- Utilities ----------
    const pad2=n=>String(n).padStart(2,'0');
    const toMin=(h,m)=>parseInt(h,10)*60+parseInt(m,10);
    const fmtHM=mins=>{const m=((mins%1440)+1440)%1440;const h=Math.floor(m/60), mm=m%60;return `${pad2(h)}:${pad2(mm)}`};
    const fmtHMDisplay=mins=>{
      if(Number.isNaN(mins)) return '';
      const total=((mins%1440)+1440)%1440;
      const hours=Math.floor(total/60);
      const minutes=total%60;
      const suffix=hours>=12?'pm':'am';
      const hour12=(hours%12)||12;
      const minutePart=minutes===0?'':`:${pad2(minutes)}`;
      return `${hour12}${minutePart}${suffix}`;
    };

    function cleanColleagueName(raw){
      if(typeof raw!=='string') return '';
      const trimmed=raw.trim();
      if(!trimmed) return '';
      const noId=trimmed.replace(/\s*\([^)]*\)\s*/g,' ').trim();
      if(!noId) return trimmed;
      const parts=noId.split(/\s+/);
      return parts.length?parts[parts.length-1]:trimmed;
    }

    function getRowDisplayName(row,index){
      const fallbackLabel=`Colleague ${index}`;
      if(!row) return fallbackLabel;
      const cleaned=(row.name||'').trim();
      if(cleaned) return cleaned;
      const fromRaw=cleanColleagueName(row.rawName||'');
      if(fromRaw) return fromRaw;
      const stripped=(row.rawName||'').replace(/\s*\([^)]*\)\s*/g,' ').trim();
      return stripped||fallbackLabel;
    }

    const SPECIAL_NAME_COLOR='#0d9488';

    function isNathanName(name){
      if(!name) return false;
      const normalized=String(name).toLowerCase().replace(/[^a-z\s]/g,' ');
      if(!normalized.trim()) return false;
      const tokens=normalized.split(/\s+/).filter(Boolean);
      return tokens.some(token=>token.startsWith('nathan') || token.startsWith('nathen') || token.startsWith('nate'));
    }

    const STATIC_CODE='7774';
    const DAY_NAME_MAP={sun:'Sunday',mon:'Monday',tue:'Tuesday',wed:'Wednesday',thu:'Thursday',fri:'Friday',sat:'Saturday'};
    const MONTH_NAMES=['January','February','March','April','May','June','July','August','September','October','November','December'];

    function ordinal(n){
      const rem10=n%10;
      const rem100=n%100;
      if(rem10===1 && rem100!==11) return `${n}st`;
      if(rem10===2 && rem100!==12) return `${n}nd`;
      if(rem10===3 && rem100!==13) return `${n}rd`;
      return `${n}th`;
    }

    function parseDayHeader(label){
      if(!label) return null;
      const match=label.match(/([A-Za-z]{3,})\s*\(?\s*(\d{1,2})\/(\d{1,2})(?:(?:\/(\d{2,4}))?);\s*\)?/);
      if(!match) return null;
      const [,dayPart,dayStr,monthStr,yearStr]=match;
      const dayNum=parseInt(dayStr,10);
      const monthNum=parseInt(monthStr,10);
      if(Number.isNaN(dayNum) || Number.isNaN(monthNum)) return null;
      const key=dayPart.slice(0,3).toLowerCase();
      const dayName=DAY_NAME_MAP[key] || dayPart;
      let year=undefined;
      if(yearStr){
        const yr=parseInt(yearStr,10);
        if(!Number.isNaN(yr)){
          year=yearStr.length===2?2000+yr:yr;
        }
      }
      return {dayName,day:dayNum,month:monthNum,year};
    }

    function formatFullDayLabel(label){
      const parsed=parseDayHeader(label);
      if(!parsed) return label;
      const monthName=MONTH_NAMES[parsed.month-1] || '';
      const pieces=[parsed.dayName || '', ordinal(parsed.day), monthName];
      if(parsed.year) pieces.push(parsed.year);
      return pieces.filter(Boolean).join(' ');
    }

    function formatShortDayLabel(label){
      const parsed=parseDayHeader(label);
      if(!parsed) return label || '';
      const abbrev=(parsed.dayName||'').slice(0,3);
      const parts=[];
      if(abbrev) parts.push(abbrev);
      if(Number.isFinite(parsed.day) && Number.isFinite(parsed.month)){parts.push(`${pad2(parsed.day)}/${pad2(parsed.month)}`);}
      if(parsed.year && !parts.length){parts.push(String(parsed.year));}
      return parts.length?parts.join(' '):(label||'');
    }

    function formatDuration(mins){
      if(!Number.isFinite(mins) || mins<=0) return '';
      const total=Math.round(mins);
      const hours=Math.floor(total/60);
      const minutes=total%60;
      const pieces=[];
      if(hours>0) pieces.push(`${hours}h`);
      if(minutes>0) pieces.push(`${minutes}m`);
      return pieces.join(' ');
    }

    function formatRangeDate(part){
      if(!part) return '';
      const day=pad2(part.day);
      const month=pad2(part.month);
      return `${day}/${month}${part.year?`/${part.year}`:''}`;
    }

    function buildDateRangeLabel(model){
      if(model && typeof model.sub==='string'){const match=model.sub.match(/Date\s*range\s*:\s*(.+)/i);if(match) return `Date range: ${match[1].trim()}`;}
      if(!model || !Array.isArray(model.dayHeaders) || !model.dayHeaders.length) return '';
      const parsed=model.dayHeaders.map(parseDayHeader).filter(Boolean);
      if(!parsed.length) return '';
      const start=parsed[0];
      const end=parsed[parsed.length-1];
      const startStr=formatRangeDate(start);
      const endStr=formatRangeDate(end);
      if(!startStr && !endStr) return '';
      if(startStr && endStr) return `Date range: ${startStr} - ${endStr}`;
      return `Date range: ${startStr || endStr}`;
    }

    const DEFAULT_LAYOUT={
      title:'Daily Colleague Summary',
      subtitleOverride:'',
      staticCode:STATIC_CODE,
      footerTemplate:'Page {page} of {total}',
      footerNote:'',
      rowHeight:28,
      chartWidth:1150,
      nameColumnWidth:140,
      headerHeight:36,
      padding:14,
      titleSize:26,
      subtitleSize:22,
      codeSize:21,
      dateSize:16,
      footerSize:12,
      columnHeaderSize:12,
      rowLabelSize:12,
      barLabelSize:11,
      barColor:'#4b4b4b',
      barLabelColor:'#ffffff',
      headerBandColor:'#efefef',
      gridColor:'#bfbfbf',
      minorGridColor:'#e5e5e5',
      axisColor:'#111111',
      columnHeaderColor:'#111111',
      rowLabelColor:'#111111',
      sheetBackground:'#ffffff',
      sheetBorder:'#000000',
      pageBackground:'#ffffff',
    };

    let currentLayout={...DEFAULT_LAYOUT};

    function readControlValue(id){
      const el=document.getElementById(id);
      return el?el.value:'';
    }

    function readNumberValue(id,fallback){
      const raw=readControlValue(id);
      const num=parseFloat(raw);
      return Number.isFinite(num)?num:fallback;
    }

    function getLayoutSettings(){n... (truncated for brevity)
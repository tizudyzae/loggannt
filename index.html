<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Colleague Summary — HTML Demo</title>
  <style>
    :root {
      --page-bg:#fff; --ink:#111; --muted:#555; --grid:#d4d4d4; --axis:#888; --accent:#4a4a4a;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:32px;font:12px/1.35 "Arial","Helvetica Neue",Helvetica,sans-serif;color:var(--ink);background:var(--page-bg)}
    h1{font-size:26px;margin:0;font-weight:600;color:var(--ink)}
    p{color:var(--muted);margin:6px 0 20px}
    .wrap{max-width:1200px;margin:0 auto}
    .controls{display:grid;gap:12px;grid-template-columns:2fr minmax(220px,1fr);align-items:start;border:1px solid #cfcfcf;padding:16px 18px;border-radius:6px;background:#fafafa;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    textarea{width:100%;height:200px;resize:vertical;color:var(--ink);background:#fff;border:1px solid #cfcfcf;border-radius:4px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .btn{appearance:none;border:1px solid #2d4a83;border-radius:4px;padding:9px 14px;background:linear-gradient(180deg,#4867a9,#324a7a);color:#fff;font-weight:600;cursor:pointer;letter-spacing:.2px}
    .btn[disabled]{opacity:.65;cursor:not-allowed}
    .btn:active{transform:translateY(1px)}
    .side{display:flex;flex-direction:column;gap:10px;min-width:220px}
    .row{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
    .meta{
      margin:24px 0 18px;
      display:flex;
      justify-content:space-between;
      gap:16px;
      border-bottom:3px solid #000;
      padding-bottom:10px;
      font-family:"Arial","Helvetica Neue",Helvetica,sans-serif;
    }
    .meta-primary{font-size:22px;font-weight:700;letter-spacing:.3px}
    .meta-secondary{font-size:14px;color:var(--muted)}
    .sheets{display:flex;flex-direction:column;gap:28px}
    .sheet{padding:18px;background:#fff;border:1px solid #000;box-shadow:0 4px 10px rgba(0,0,0,.08)}
    .sheet-heading{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px;border-bottom:1px solid #bfbfbf;padding-bottom:6px}
    .sheet-heading h2{margin:0;font-size:18px;font-weight:700;text-transform:uppercase;letter-spacing:.4px}
    .sheet-heading .subline{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px}
    .sheet svg{width:100%;height:auto;display:block}
    .axislabel{fill:#000;font-size:11px;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
    .colheader{fill:#000;font-size:12px;font-weight:700;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif;text-transform:uppercase}
    .rowlabel{fill:#000;font-size:12px;dominant-baseline:middle;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
    .gridline{stroke:#d0d0d0;stroke-width:1}
    .gridline-minor{stroke:#ededed;stroke-width:.6}
    .divider{stroke:#000;stroke-width:1.2}
    .bar{fill:#7b7b7b}
    .barlabel{fill:#fff;font-size:11px;font-weight:700;dominant-baseline:middle;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
    .footer{margin-top:24px;color:var(--muted);font-size:12px;text-align:center}
    .switch{position:relative;display:inline-block;width:46px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#cfd5e2;border-radius:999px;border:1px solid #a3afc5}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:2px;background:white;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.25)}
    input:checked + .slider{background:#6aa871;border-color:#4e8d58}
    input:checked + .slider:before{transform:translateX(20px)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Daily Colleague Summary</h1>
    <p>Paste your raw export and hit <b>Render</b>. By default we show <b>Whole Shift</b> ranges; if a day has none, we can <i>fallback</i> to the first <code>SCH:</code> range so you still see coverage.</p>

    <div class="controls">
      <textarea id="input"></textarea>
      <div class="side">
        <button class="btn" id="btnRender">Render</button>
        <button class="btn" id="btnExport" style="background:linear-gradient(180deg,#f59e0b,#d97706)">Export PDF</button>
        <div class="row">
          <label class="switch"><input type="checkbox" id="chkFallback" checked><span class="slider"></span></label>
          <span>Use <b>SCH:</b> when no <b>Whole&nbsp;Shift</b> found</span>
        </div>
        <div class="row">
          <label class="switch"><input type="checkbox" id="chkSplit" checked><span class="slider"></span></label>
          <span>Split bars at midnight</span>
        </div>
      </div>
    </div>

    <div class="meta">
      <div id="metaTitle" class="meta-primary"></div>
      <div id="metaSub" class="meta-secondary"></div>
    </div>
    <div class="sheets" id="sheets"></div>
      <div class="footer">Client‑side only. Uses pdf-lib to turn the SVG output into shareable landscape PDFs.</div>
  </div>

  <script src="pdf-lib.min.js"></script>
  <script>
    // ---------- Utilities ----------
    const pad2=n=>String(n).padStart(2,'0');
    const toMin=(h,m)=>parseInt(h,10)*60+parseInt(m,10);
    const fmtHM=mins=>{const m=((mins%1440)+1440)%1440;const h=Math.floor(m/60), mm=m%60;return `${pad2(h)}:${pad2(mm)}`};
    const fmtHMDisplay=mins=>{
      if(Number.isNaN(mins)) return '';
      const total=((mins%1440)+1440)%1440;
      const hours=Math.floor(total/60);
      const minutes=total%60;
      const suffix=hours>=12?'pm':'am';
      const hour12=(hours%12)||12;
      const minutePart=minutes===0?'':`:${pad2(minutes)}`;
      return `${hour12}${minutePart}${suffix}`;
    };

    // ---------- Parsing ----------
    function parseExport(text){
      text=text.replace(/^\"|\"$/g,'').replace(/\r/g,'');
      const lines=text.split('\n').map(x=>x.trim()).filter(Boolean);
      const headerIdx=lines.findIndex(l=>l.startsWith('Employee,'));
      if(headerIdx===-1) throw new Error('Header row starting with "Employee," not found.');
      const title=lines[0]||''; const sub=lines[1]||'';
      const header=lines[headerIdx].split(',');
      const dayHeaders=header.slice(1,8); // Sun..Sat
      const rows=[];
      for(let i=headerIdx+1;i<lines.length;i++){
        const parts=lines[i].split(',');
        if(parts.length<8) continue;
        const name=parts[0].trim();
        const days=parts.slice(1,8);
        rows.push({name,days});
      }
      return {title,sub,dayHeaders,rows};
    }

    function pickRange(cell,{fallbackSCH}){
      if(!cell) return null;
      // Prefer Whole Shift
      let m=cell.match(/Whole\s*Shift:\s*(\d{1,2}):(\d{1,2})\s*-\s*(\d{1,2}):(\d{1,2})/i);
      if(!m && fallbackSCH){
        m=cell.match(/SCH:\s*(\d{1,2}):(\d{1,2})\s*-\s*(\d{1,2}):(\d{1,2})/i);
      }
      if(!m) return null;
      let s=toMin(m[1],m[2]), e=toMin(m[3],m[4]);
      if(e<s) e+=1440; // overnight
      return {start:s,end:e};
    }

    function segmentsForRange(range,splitMidnight){
      if(!range) return [];
      const segments=[];
      let start=Math.max(0,Math.min(1440,range.start));
      let end=Math.max(0,range.end);
      if(splitMidnight && end>1440){
        segments.push({start,end:1440});
        let remaining=end-1440;
        while(remaining>0){
          const segEnd=Math.min(remaining,1440);
          if(segEnd>0) segments.push({start:0,end:segEnd});
          remaining-=1440;
        }
        return segments;
      }
      end=Math.min(end,1440);
      if(end<=start) return [];
      return [{start,end}];
    }

    function buildPerDay(model,opts){
      return model.dayHeaders.map((_,dayIdx)=>{
        return model.rows.map(row=>{
          const cell=row.days[dayIdx];
          const rng=pickRange(cell,opts);
          return {name:row.name, range:rng, segments:segmentsForRange(rng,opts.splitMidnight)};
        });
      });
    }

    const SVG_STYLE_BLOCK = `
      .axislabel{fill:#111;font-size:11px;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
      .colheader{fill:#111;font-size:12px;font-weight:700;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif;text-transform:uppercase}
      .rowlabel{fill:#111;font-size:12px;dominant-baseline:middle;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
      .gridline{stroke:#bfbfbf;stroke-width:1}
      .gridline-minor{stroke:#e5e5e5;stroke-width:.6}
      .divider{stroke:#000;stroke-width:1.2}
      .headerband{fill:#efefef}
      .tick-major{stroke:#000;stroke-width:1}
      .tick-minor{stroke:#555;stroke-width:.4}
      .bar{fill:#4b4b4b}
      .barlabel{fill:#fff;font-size:11px;font-weight:700;dominant-baseline:middle;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
    `;

    // ---------- Layout & Draw ----------
    function drawDayCard(container,label,rows){
      const P=14,W=1150,rowH=28,leftAxis=240,innerW=W-leftAxis-P*2;
      const headerHeight=36;
      const visibleRows=rows.filter(r=>r.range);
      const bodyRows=visibleRows.length?visibleRows:[{name:'No scheduled colleagues',range:null,segments:[]}];
      const bodyHeight=rowH*bodyRows.length;
      const H=P+headerHeight+bodyHeight+P;
      const svgNS='http://www.w3.org/2000/svg';
      const svg=document.createElementNS(svgNS,'svg');
      svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
      svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
      svg.setAttribute('font-family','Arial, "Helvetica Neue", Helvetica, sans-serif');

      const style=document.createElementNS(svgNS,'style');
      style.textContent=SVG_STYLE_BLOCK;
      svg.appendChild(style);

      const bg=document.createElementNS(svgNS,'rect');
      bg.setAttribute('x',0);bg.setAttribute('y',0);bg.setAttribute('width',W);bg.setAttribute('height',H);bg.setAttribute('fill','#fff');
      svg.appendChild(bg);

      const border=document.createElementNS(svgNS,'rect');
      border.setAttribute('x',0);border.setAttribute('y',0);border.setAttribute('width',W);border.setAttribute('height',H);
      border.setAttribute('fill','none');border.setAttribute('stroke','#000');border.setAttribute('stroke-width','1');
      svg.appendChild(border);

      const headerBand=document.createElementNS(svgNS,'rect');
      headerBand.setAttribute('x',P);headerBand.setAttribute('y',P);
      headerBand.setAttribute('width',W-P*2);headerBand.setAttribute('height',headerHeight);
      headerBand.setAttribute('class','headerband');
      svg.appendChild(headerBand);

      const columnDivider=document.createElementNS(svgNS,'line');
      columnDivider.setAttribute('x1',P+leftAxis);
      columnDivider.setAttribute('y1',P);
      columnDivider.setAttribute('x2',P+leftAxis);
      columnDivider.setAttribute('y2',H-P);
      columnDivider.setAttribute('class','divider');
      svg.appendChild(columnDivider);

      const headerLine=document.createElementNS(svgNS,'line');
      headerLine.setAttribute('x1',P);headerLine.setAttribute('y1',P+headerHeight);
      headerLine.setAttribute('x2',W-P);headerLine.setAttribute('y2',P+headerHeight);
      headerLine.setAttribute('class','divider');
      svg.appendChild(headerLine);

      const headerTop=P;
      const headerBottom=P+headerHeight;
      const headerTextBaseline=headerTop+18;
      const axisY=headerTop+headerHeight*0.75;
      const minorTickBottom=headerTop+headerHeight*(2/3);

      const nameHeader=document.createElementNS(svgNS,'text');
      nameHeader.setAttribute('x',P+6);nameHeader.setAttribute('y',headerTextBaseline);
      nameHeader.setAttribute('class','colheader');
      nameHeader.textContent='Colleague Names';
      svg.appendChild(nameHeader);

      const timeHeader=document.createElementNS(svgNS,'text');
      timeHeader.setAttribute('x',P+leftAxis+6);
      timeHeader.setAttribute('y',headerTextBaseline);
      timeHeader.setAttribute('class','colheader');
      timeHeader.textContent='Time';
      svg.appendChild(timeHeader);

      const toX=m=>P+leftAxis+(m/1440)*innerW;
      for(let minute=0;minute<=1440;minute+=15){
        const x=toX(minute);
        const isHour=minute%60===0;
        if(minute<1440){
          const tick=document.createElementNS(svgNS,'line');
          tick.setAttribute('x1',x);
          tick.setAttribute('y1',headerTop);
          tick.setAttribute('x2',x);
          tick.setAttribute('y2',isHour?headerBottom:minorTickBottom);
          tick.setAttribute('class',isHour?'tick-major':'tick-minor');
          svg.appendChild(tick);
        }
        if(isHour && minute<1440){
          const axisText=document.createElementNS(svgNS,'text');
          const labelMinute=Math.min(minute+30,1440);
          axisText.setAttribute('x',toX(labelMinute));
          axisText.setAttribute('y',axisY);
          axisText.setAttribute('text-anchor','middle');
          axisText.setAttribute('class','axislabel');
          axisText.textContent=fmtHMDisplay(minute);
          svg.appendChild(axisText);
        }

        if(minute>0 && minute<1440){
          const vline=document.createElementNS(svgNS,'line');
          vline.setAttribute('x1',x);
          vline.setAttribute('y1',headerTop);
          vline.setAttribute('x2',x);
          vline.setAttribute('y2',H-P);
          vline.setAttribute('class',isHour?'gridline':'gridline-minor');
          svg.appendChild(vline);
        }
      }

      const bodyTop=headerBottom;
      bodyRows.forEach((row,idx)=>{
        const y=bodyTop+idx*rowH;
        if(idx>0){
          const baseline=document.createElementNS(svgNS,'line');
          baseline.setAttribute('x1',P);
          baseline.setAttribute('y1',y);
          baseline.setAttribute('x2',W-P);
          baseline.setAttribute('y2',y);
          baseline.setAttribute('class','gridline');
          svg.appendChild(baseline);
        }

        const name=document.createElementNS(svgNS,'text');
        name.setAttribute('x',P+6);
        name.setAttribute('y',y+rowH/2);
        name.setAttribute('class','rowlabel');
        name.textContent=row.name;
        svg.appendChild(name);

        if(row.range){
          const labelText=`${fmtHMDisplay(row.range.start)} - ${fmtHMDisplay(row.range.end)}`;
          row.segments.forEach((seg,segIdx)=>{
            const segY=y+4;
            const segHeight=rowH-8;
            const rect=document.createElementNS(svgNS,'rect');
            rect.setAttribute('x',toX(seg.start));
            rect.setAttribute('y',segY);
            rect.setAttribute('width',Math.max(2,toX(seg.end)-toX(seg.start)));
            rect.setAttribute('height',segHeight);
            rect.setAttribute('class','bar');
            svg.appendChild(rect);

            if(segIdx===0){
              const label=document.createElementNS(svgNS,'text');
              label.setAttribute('x',toX(seg.start)+4);
              label.setAttribute('y',segY+segHeight/2+1);
              label.setAttribute('class','barlabel');
              label.textContent=labelText;
              svg.appendChild(label);
            }
          });
        }
      });

      const finalLine=document.createElementNS(svgNS,'line');
      finalLine.setAttribute('x1',P);
      finalLine.setAttribute('y1',bodyTop+bodyRows.length*rowH);
      finalLine.setAttribute('x2',W-P);
      finalLine.setAttribute('y2',bodyTop+bodyRows.length*rowH);
      finalLine.setAttribute('class','divider');
      svg.appendChild(finalLine);

      const section=document.createElement('section');
      section.className='sheet';
      const heading=document.createElement('div');
      heading.className='sheet-heading';
      const h2=document.createElement('h2'); h2.textContent=label; heading.appendChild(h2);
      const activeCount=visibleRows.length;
      const sub=document.createElement('div'); sub.className='subline'; sub.textContent=`${activeCount} shift${activeCount===1?'':'s'}`; heading.appendChild(sub);
      section.appendChild(heading);
      section.appendChild(svg);
      container.appendChild(section);
      return {svg};
    }

    // ---------- Render / Export ----------
    let lastModel=null,lastPerDay=null;

    function render(text){
      const opts={fallbackSCH:document.getElementById('chkFallback').checked, splitMidnight:document.getElementById('chkSplit').checked};
      let model; try{ model=parseExport(text);}catch(e){ alert(e.message); return; }
      const perDay=buildPerDay(model,opts);
      lastModel=model; lastPerDay=perDay;

      document.getElementById('metaTitle').textContent=model.title || '';
      document.getElementById('metaSub').textContent=model.sub || '';
      const sheets=document.getElementById('sheets'); sheets.innerHTML='';
      model.dayHeaders.forEach((label,i)=>{
        drawDayCard(sheets,label,perDay[i]);
      });
    }

    async function svgToPngDataUrl(svg,{scale=2}={}){
      const clone=svg.cloneNode(true);
      const vb=(clone.getAttribute('viewBox')||'').trim().split(/\s+/).map(Number);
      let width,height;
      if(vb.length===4 && vb.every(v=>!Number.isNaN(v))){
        width=vb[2]; height=vb[3];
      }else{
        width=svg.clientWidth||900;
        height=svg.clientHeight||600;
      }
      const serializer=new XMLSerializer();
      const svgString=serializer.serializeToString(clone);
      const blob=new Blob([svgString],{type:'image/svg+xml'});
      const url=URL.createObjectURL(blob);
      try{
        const img=new Image();
        img.src=url;
        await new Promise((resolve,reject)=>{
          img.onload=()=>resolve();
          img.onerror=()=>reject(new Error('Unable to rasterize SVG.'));
        });
        const canvas=document.createElement('canvas');
        canvas.width=width*scale;
        canvas.height=height*scale;
        const ctx=canvas.getContext('2d');
        ctx.setTransform(scale,0,0,scale,0,0);
        ctx.drawImage(img,0,0,width,height);
        return canvas.toDataURL('image/png');
      }finally{
        URL.revokeObjectURL(url);
      }
    }

    function sanitizeFileName(name){
      return name.replace(/[^\w\d\-_]+/g,'_').replace(/_+/g,'_').replace(/^_|_$/g,'') || 'gantt';
    }

    async function exportPDF(){
      const btn=document.getElementById('btnExport');
      if(btn.disabled) return;
      if(!lastModel){
        const t=document.getElementById('input').value.trim();
        if(!t) return;
        render(t);
        if(!lastModel) return;
      }
      if(!window.PDFLib){
        alert('PDF generator failed to load. Please refresh and try again.');
        return;
      }
      const originalLabel=btn.textContent;
      btn.disabled=true;
      btn.textContent='Exporting…';
      try{
        const {PDFDocument, StandardFonts, rgb}=window.PDFLib;
        const pdfDoc=await PDFDocument.create();
        const font=await pdfDoc.embedFont(StandardFonts.Helvetica);
        const margin=24;
        const titleSize=20;
        const subSize=11;
        const titleGap=10;
        const pageSize=[842,595];
        const titleText=lastModel.title || 'Schedule';
        for(let i=0;i<lastModel.dayHeaders.length;i++){
          const label=lastModel.dayHeaders[i];
          const tmp=document.createElement('div');
          const {svg}=drawDayCard(tmp,label,lastPerDay[i]);
          const pngDataUrl=await svgToPngDataUrl(svg,{scale:2});
          const pngImage=await pdfDoc.embedPng(pngDataUrl);
          const page=pdfDoc.addPage(pageSize);
          const pageWidth=page.getWidth();
          const pageHeight=page.getHeight();
          const titleBaseline=pageHeight-margin-titleSize;
          page.drawText(`${titleText} — ${label}`,{x:margin,y:titleBaseline,size:titleSize,font,color:rgb(0.1,0.12,0.16)});
          const subBaseline=titleBaseline-subSize-6;
          const shiftCount=lastPerDay[i].filter(r=>r.range).length;
          const subText=`${shiftCount} shift${shiftCount===1?'':'s'}`;
          page.drawText(subText,{x:margin,y:subBaseline,size:subSize,font,color:rgb(0.35,0.4,0.45)});
          const availableWidth=pageWidth-margin*2;
          const availableHeight=subBaseline-titleGap-margin;
          let targetWidth=availableWidth;
          let targetHeight=pngImage.height*(targetWidth/pngImage.width);
          if(targetHeight>availableHeight){
            targetHeight=availableHeight;
            targetWidth=pngImage.width*(targetHeight/pngImage.height);
          }
          const imageX=margin+(availableWidth-targetWidth)/2;
          const imageTop=subBaseline-titleGap;
          const imageY=Math.max(margin,imageTop-targetHeight);
          page.drawImage(pngImage,{x:imageX,y:imageY,width:targetWidth,height:targetHeight});
        }
        const pdfBytes=await pdfDoc.save();
        const blob=new Blob([pdfBytes],{type:'application/pdf'});
        const url=URL.createObjectURL(blob);
        const link=document.createElement('a');
        link.href=url;
        link.download=`${sanitizeFileName(titleText)}.pdf`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        setTimeout(()=>URL.revokeObjectURL(url),5000);
      }catch(err){
        console.error(err);
        alert(`Failed to export PDF: ${err.message}`);
      }finally{
        btn.disabled=false;
        btn.textContent=originalLabel;
      }
    }

    // ---------- Sample & Wire-up ----------
    document.getElementById('btnRender').addEventListener('click',()=>{
      const text=document.getElementById('input').value.trim();
      if(!text){ alert('Paste an export into the text area before rendering.'); return; }
      render(text);
    });
    document.getElementById('btnExport').addEventListener('click',()=>{ exportPDF(); });
    document.getElementById('chkFallback').addEventListener('change',()=>{
      const text=document.getElementById('input').value.trim();
      if(text) render(text);
    });
    document.getElementById('chkSplit').addEventListener('change',()=>{
      const text=document.getElementById('input').value.trim();
      if(text) render(text);
    });

    // First paint
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('input').value='';
    });
  </script>
</body>
</html>

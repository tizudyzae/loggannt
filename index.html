<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weekly Shift Gantt — HTML Demo</title>
  <style>
    :root {
      --bg: #0b0c0f; --panel: #141821; --ink: #e8eef8; --muted: #a9b3c7;
      --grid: #2a3242; --shadow: 0 10px 24px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.25);
      --bar1:#79d2a6; --bar2:#f8c36a; --bar3:#e393ff; --bar4:#ff8f8f; --bar5:#8fd0ff; --bar6:#a3f59b; --bar7:#ffd27f;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:24px;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;color:var(--ink);background:radial-gradient(1200px 800px at 10% -10%,#142033 0%,#0b0c0f 55%)}
    h1{font-size:20px;margin:0 0 10px;font-weight:700}
    h2{font-size:16px;margin:0 0 8px;font-weight:700;color:var(--ink)}
    p{color:var(--muted);margin:6px 0 14px}
    .wrap{max-width:1200px;margin:0 auto}
    .controls{display:grid;gap:10px;grid-template-columns:1fr auto;align-items:start;background:var(--panel);border:1px solid #223;border-radius:14px;padding:14px;box-shadow:var(--shadow)}
    textarea{width:100%;height:200px;resize:vertical;color:var(--ink);background:#0f1219;border:1px solid #223;border-radius:10px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:linear-gradient(180deg,#2b5cff,#1b47d8);color:#fff;font-weight:650;cursor:pointer;box-shadow:var(--shadow)}
    .btn:active{transform:translateY(1px)}
    .side{display:flex;flex-direction:column;gap:10px;min-width:220px}
    .row{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
    .charts{margin-top:16px;display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(360px,1fr))}
    .daycard{background:var(--panel);border:1px solid #223;border-radius:14px;padding:12px;box-shadow:var(--shadow);overflow:hidden}
    .subline{color:var(--muted);font-size:12px}
    .chartbox{width:100%;aspect-ratio:16/10;background:#0f1219;border:1px solid #223;border-radius:12px;overflow:hidden;position:relative}
    svg{width:100%;height:100%;display:block}
    .gridline{stroke:var(--grid);stroke-width:1}
    .axislabel{fill:var(--muted);font-size:11px}
    .emplabel{fill:var(--ink);font-size:12px;dominant-baseline:middle}
    .bar{rx:6;ry:6}
    .tooltip{position:absolute;pointer-events:none;background:#000;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;opacity:0;transform:translate(-50%,-120%);white-space:nowrap;border:1px solid #333}
    .footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
    .switch{position:relative;display:inline-block;width:46px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#334;border-radius:999px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s}
    input:checked + .slider{background:#29b475}
    input:checked + .slider:before{transform:translateX(22px)}

    /* PRINT */
    @media print{
      @page{size:A4 landscape;margin:10mm}
      body{background:white!important}
      .controls,.footer,#tooltip,#meta{display:none!important}
      .charts{display:block}
      .print-page{page-break-after:always;break-after:page}
      .print-title{font-size:16px;color:#000;margin:0 0 8px}
      .print-sub{font-size:12px;color:#333;margin:0 0 6px}
      .chartbox{border:0;border-radius:0}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Weekly Shift Gantt — HTML Demo</h1>
    <p>Paste your raw export and hit <b>Render</b>. By default we show <b>Whole Shift</b> ranges; if a day has none, we can <i>fallback</i> to the first <code>SCH:</code> range so you still see coverage.</p>

    <div class="controls">
      <textarea id="input"></textarea>
      <div class="side">
        <button class="btn" id="btnRender">Render</button>
        <button class="btn" id="btnExport" style="background:linear-gradient(180deg,#f59e0b,#d97706)">Export PDF</button>
        <div class="row">
          <label class="switch"><input type="checkbox" id="chkFallback" checked><span class="slider"></span></label>
          <span>Use <b>SCH:</b> when no <b>Whole&nbsp;Shift</b> found</span>
        </div>
        <div class="row">
          <label class="switch"><input type="checkbox" id="chkSplit" checked><span class="slider"></span></label>
          <span>Split bars at midnight</span>
        </div>
      </div>
    </div>

    <div id="meta" class="row" style="margin-top:8px"></div>
    <div class="charts" id="charts"></div>
    <div class="footer">Client‑side only. No libraries. SVG output; print to get one PDF page per day.</div>
  </div>

  <div id="tooltip" class="tooltip"></div>
  <div id="printArea" style="display:none"></div>

  <script>
    // ---------- Utilities ----------
    const DAY_COLORS=["var(--bar1)","var(--bar2)","var(--bar3)","var(--bar4)","var(--bar5)","var(--bar6)","var(--bar7)"];
    const pad2=n=>String(n).padStart(2,'0');
    const toMin=(h,m)=>parseInt(h,10)*60+parseInt(m,10);
    const fmtHM=mins=>{const m=((mins%1440)+1440)%1440;const h=Math.floor(m/60), mm=m%60;return `${pad2(h)}:${pad2(mm)}`};

    // ---------- Parsing ----------
    function parseExport(text){
      text=text.replace(/^\"|\"$/g,'').replace(/\r/g,'');
      const lines=text.split('\n').map(x=>x.trim()).filter(Boolean);
      const headerIdx=lines.findIndex(l=>l.startsWith('Employee,'));
      if(headerIdx===-1) throw new Error('Header row starting with "Employee," not found.');
      const title=lines[0]||''; const sub=lines[1]||'';
      const header=lines[headerIdx].split(',');
      const dayHeaders=header.slice(1,8); // Sun..Sat
      const rows=[];
      for(let i=headerIdx+1;i<lines.length;i++){
        const parts=lines[i].split(',');
        if(parts.length<8) continue;
        const name=parts[0].trim();
        const days=parts.slice(1,8);
        rows.push({name,days});
      }
      return {title,sub,dayHeaders,rows};
    }

    function pickRange(cell,{fallbackSCH}){
      if(!cell) return null;
      // Prefer Whole Shift
      let m=cell.match(/Whole\s*Shift:\s*(\d{1,2}):(\d{1,2})\s*-\s*(\d{1,2}):(\d{1,2})/i);
      if(!m && fallbackSCH){
        m=cell.match(/SCH:\s*(\d{1,2}):(\d{1,2})\s*-\s*(\d{1,2}):(\d{1,2})/i);
      }
      if(!m) return null;
      let s=toMin(m[1],m[2]), e=toMin(m[3],m[4]);
      if(e<s) e+=1440; // overnight
      return {start:s,end:e};
    }

    function buildPerDay(model,opts){
      const perDay=model.dayHeaders.map(()=>[]);
      model.rows.forEach(r=>{
        r.days.forEach((cell,idx)=>{
          const rng=pickRange(cell,opts);
          if(rng) perDay[idx].push({name:r.name, ...rng});
        });
      });
      return perDay;
    }

    // ---------- Layout & Draw ----------
    function layout(items){
      const sorted=items.slice().sort((a,b)=>a.start-b.start);
      const lanes=[]; const placed=[];
      for(const it of sorted){
        let lane=lanes.findIndex(end=>it.start>=end);
        if(lane===-1){lane=lanes.length;lanes.push(-1)}
        lanes[lane]=it.end; placed.push({...it,lane});
      }
      return placed;
    }

    function splitAtMidnight(it){
      // returns one or two segments within [0,1440)
      const start=it.start%1440; const end=it.end%1440; const segments=[];
      if(it.end<=1440 && end>=start){ segments.push([start,end]); }
      else { segments.push([start,1440]); segments.push([0,end]); }
      return segments;
    }

    function drawDayCard(container,label,items,color,{splitMidnight}){
      const placed=layout(items);
      const P=14,W=900,rowH=24,leftAxis=130,innerW=W-leftAxis-P*2-10;
      const H=Math.max(140, 40+placed.length*28);
      const svgNS='http://www.w3.org/2000/svg';
      const svg=document.createElementNS(svgNS,'svg');
      svg.setAttribute('viewBox',`0 0 ${W} ${H}`);

      // grid
      for(let h=0;h<=24;h++){
        const x=P+leftAxis+(h/24)*innerW;
        const line=document.createElementNS(svgNS,'line');
        line.setAttribute('x1',x);line.setAttribute('y1',10);line.setAttribute('x2',x);line.setAttribute('y2',H-10);line.setAttribute('class','gridline');
        svg.appendChild(line);
        const t=document.createElementNS(svgNS,'text');
        t.setAttribute('x',x);t.setAttribute('y',20);t.setAttribute('text-anchor','middle');t.setAttribute('class','axislabel');t.textContent=pad2(h);
        svg.appendChild(t);
      }

      const tooltip=document.getElementById('tooltip');
      const toX=m=>P+leftAxis+(m/1440)*innerW;
      const y0=34;
      placed.forEach((it,i)=>{
        const y=y0+i*rowH;
        const name=document.createElementNS(svgNS,'text');
        name.setAttribute('x',P+4);name.setAttribute('y',y+rowH/2);name.setAttribute('class','emplabel');name.textContent=it.name;svg.appendChild(name);
        const durMins=it.end-it.start; const hours=(durMins/60).toFixed(2);
        const segs=splitMidnight && (it.end%1440 < it.start%1440 || it.end>1440) ? splitAtMidnight(it): [[it.start%1440,it.end%1440]];
        segs.forEach(([s,e])=>{
          const r=document.createElementNS(svgNS,'rect');
          r.setAttribute('x',toX(s)); r.setAttribute('y',y+3);
          r.setAttribute('width',Math.max(4,toX(e)-toX(s))); r.setAttribute('height',rowH-6);
          r.setAttribute('fill',color); r.setAttribute('class','bar');
          r.addEventListener('mouseenter',ev=>{tooltip.textContent=`${it.name} — ${fmtHM(it.start)}–${fmtHM(it.end)} (${hours} h)`;const b=ev.currentTarget.getBoundingClientRect();tooltip.style.left=(b.left+b.width/2)+'px';tooltip.style.top=b.top+'px';tooltip.style.opacity=1});
          r.addEventListener('mouseleave',()=>tooltip.style.opacity=0);
          svg.appendChild(r);
        });
      });

      const card=document.createElement('div'); card.className='daycard';
      const h2=document.createElement('h2'); h2.textContent=label; card.appendChild(h2);
      const sub=document.createElement('div'); sub.className='subline'; sub.textContent=`${items.length} shift${items.length===1?'':'s'}`; card.appendChild(sub);
      const box=document.createElement('div'); box.className='chartbox'; box.appendChild(svg); card.appendChild(box);
      container.appendChild(card);
      return {svg};
    }

    // ---------- Render / Export ----------
    let lastModel=null,lastPerDay=null,lastOpts={fallbackSCH:true,splitMidnight:true};

    function render(text){
      const opts={fallbackSCH:document.getElementById('chkFallback').checked, splitMidnight:document.getElementById('chkSplit').checked};
      let model; try{ model=parseExport(text);}catch(e){ alert(e.message); return; }
      const perDay=buildPerDay(model,opts);
      lastModel=model; lastPerDay=perDay; lastOpts=opts;

      document.getElementById('meta').textContent=`${model.title} — ${model.sub}`;
      const charts=document.getElementById('charts'); charts.innerHTML='';
      model.dayHeaders.forEach((label,i)=>{
        const color=DAY_COLORS[i%DAY_COLORS.length];
        drawDayCard(charts,label,perDay[i],color,opts);
      });
    }

    function exportPDF(){
      if(!lastModel){ const t=document.getElementById('input').value.trim(); if(!t) return; render(t); }
      const printArea=document.getElementById('printArea'); printArea.innerHTML=''; printArea.style.display='block';
      lastModel.dayHeaders.forEach((label,i)=>{
        const page=document.createElement('div'); page.className='print-page';
        const tt=document.createElement('div'); tt.className='print-title'; tt.textContent=`${lastModel.title} — ${label}`; page.appendChild(tt);
        const ss=document.createElement('div'); ss.className='print-sub'; ss.textContent=`${lastPerDay[i].length} shifts`; page.appendChild(ss);
        const tmp=document.createElement('div');
        const {svg}=drawDayCard(tmp,label,lastPerDay[i],DAY_COLORS[i%DAY_COLORS.length],lastOpts);
        page.appendChild(svg);
        printArea.appendChild(page);
      });
      window.print(); setTimeout(()=>{printArea.innerHTML=''; printArea.style.display='none';},100);
    }

    // ---------- Sample & Wire-up ----------
    document.getElementById('btnRender').addEventListener('click',()=>{
      const text=document.getElementById('input').value.trim();
      if(!text){ alert('Paste an export into the text area before rendering.'); return; }
      render(text);
    });
    document.getElementById('btnExport').addEventListener('click',exportPDF);
    document.getElementById('chkFallback').addEventListener('change',()=>{
      const text=document.getElementById('input').value.trim();
      if(text) render(text);
    });
    document.getElementById('chkSplit').addEventListener('change',()=>{
      const text=document.getElementById('input').value.trim();
      if(text) render(text);
    });

    // First paint
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('input').value='';
    });
  </script>
</body>
</html>

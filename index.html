<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>CSV Rota Viewer</title>
  <style>
    :root {
      --page-bg:#0d1829;
      --ink:#061626;
      --muted:#516275;
      --grid:#d0dde7;
      --axis:#7c8d9b;
      --accent:#00a6d6;
      --accent-strong:#0083a8;
      --accent-soft:#d2f2ff;
      --focus:#00b2a9;
      --surface:#ffffff;
      --surface-soft:#f5f7fb;
      --border:#d6e1ea;
      --sheet-bg:#fff;
      --sheet-border:#13394a;
      --sheet-header-band:#e1eef5;
      --sheet-title-size:26px;
      --sheet-range-size:22px;
      --sheet-code-size:21px;
      --sheet-date-size:16px;
      --sheet-footer-size:12px;
      --column-header-size:12px;
      --column-header-color:#01263a;
      --row-label-size:12px;
      --bar-label-size:11px;
    }
    *{box-sizing:border-box}
    [hidden]{display:none !important}
    body{margin:0;padding:0;font:14px/1.5 "Averta Std","Nunito Sans","Helvetica Neue",Helvetica,Arial,sans-serif;color:var(--ink);background:radial-gradient(circle at top,var(--accent-soft),transparent 35%),var(--page-bg);min-height:100vh}
    .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    h1{font-size:34px;margin:0;font-weight:700;color:var(--ink);letter-spacing:-.01em}
    p{color:var(--muted);margin:8px 0 24px;font-size:16px;max-width:60ch}
    .wrap{max-width:1200px;margin:0 auto;padding:32px 36px 56px;width:100%;display:flex;flex-direction:column;gap:32px}
    .page-header{border-radius:28px;background:var(--surface);padding:32px 36px;box-shadow:0 16px 40px rgba(6,28,46,.12);display:flex;flex-wrap:wrap;gap:28px;align-items:flex-start}
    .page-header h1{font-size:clamp(28px,4vw,40px);margin:6px 0 0;color:var(--ink)}
    .page-header p{margin:12px 0 0;color:var(--muted);font-size:16px;max-width:60ch}
    .layout{display:flex;flex-direction:column;gap:28px}
    .side-panel{display:flex;flex-direction:column;gap:20px}
    .main-panel{display:flex;flex-direction:column;gap:24px}
    .controls{display:flex;flex-direction:column;gap:16px;align-items:stretch;border:1px solid rgba(6,28,46,.08);padding:26px 28px;border-radius:28px;background:var(--surface);box-shadow:0 20px 45px rgba(5,22,38,.1);width:100%}
    .control-btn{width:100%}
    .control-hint{margin:0;font-size:12px;color:var(--muted);background:var(--surface-soft);padding:12px 14px;border-radius:12px}
    .settings-toggle{position:fixed;top:20px;left:20px;width:48px;height:48px;border-radius:50%;border:1px solid var(--border);background:var(--surface);color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;box-shadow:0 14px 30px rgba(9,42,58,.12);transition:transform .2s ease,box-shadow .2s ease,background .2s ease;color .2s ease;z-index:2000}
    .settings-toggle:hover{transform:translateY(-1px);box-shadow:0 18px 36px rgba(9,42,58,.16);background:var(--surface-soft)}
    .settings-toggle:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .settings-toggle[disabled]{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
    .panel-title{margin:0;font-size:18px;font-weight:700;color:var(--ink)}
    .settings-panel{position:fixed;top:84px;left:20px;width:320px;max-width:calc(100% - 40px);z-index:1990}
    .settings-panel .panel-title{margin-bottom:4px}
    .settings-panel .control-hint{background:transparent;padding:0;margin-bottom:8px}
    .saved-week-select{display:flex;flex-direction:column;gap:6px}
    .saved-week-select select{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;font:14px/1.5 "Averta Std","Nunito Sans","Helvetica Neue",Helvetica,Arial,sans-serif;color:var(--ink);box-shadow:0 6px 12px rgba(9,42,58,.06)}
    .saved-week-select select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,123,195,.18)}
    .saved-week-meta{font-size:12px;color:var(--muted);margin:0}
    .saved-week-actions{display:flex;flex-wrap:wrap;gap:8px}
    .saved-week-actions .btn{flex:1 1 auto}
    .btn{appearance:none;border-radius:999px;padding:11px 18px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;letter-spacing:.15px;border:1px solid var(--accent);box-shadow:0 10px 20px rgba(0,123,195,.18);transition:background .2s ease,border-color .2s ease,box-shadow .2s ease,transform .1s ease}
    .btn:hover{background:var(--accent-strong);border-color:var(--accent-strong);box-shadow:0 12px 24px rgba(0,92,145,.22)}
    .btn:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .btn[disabled]{opacity:.55;cursor:not-allowed;box-shadow:none;background:#8fa3b3;border-color:#8fa3b3}
    .btn:active{transform:translateY(1px)}
    .btn-secondary{background:#00b2a9;border-color:#00b2a9;box-shadow:0 10px 20px rgba(0,178,169,.18)}
    .btn-secondary:hover{background:#00948c;border-color:#00948c;box-shadow:0 12px 24px rgba(0,148,140,.22)}
    .side{display:flex;flex-direction:column;gap:12px;min-width:240px}
    .side>.btn{width:100%}
    .panel{border:1px solid var(--border);border-radius:22px;background:var(--surface);box-shadow:0 14px 30px rgba(9,42,58,.08);padding:0;overflow:hidden}
    .panel[hidden]{display:none !important;margin:0 !important;padding:0 !important;border:0}
    .panel summary{cursor:pointer;list-style:none;font-weight:700;color:var(--ink);padding:18px 24px;font-size:15px;display:flex;align-items:center;justify-content:space-between;background:var(--surface);transition:background .2s ease,color .2s ease}
    .panel summary::-webkit-details-marker{display:none}
    .panel summary::after{content:'▾';font-size:13px;color:var(--muted);transition:transform .2s ease,color .2s ease}
    .panel[open] summary{background:var(--surface-soft)}
    .panel[open] summary::after{transform:rotate(180deg);color:var(--accent)}
    .panel-body{padding:0 24px 24px;display:grid;gap:16px;background:var(--surface-soft)}
    .panel.panel-static{padding:24px 28px;display:grid;gap:16px}
    .panel.panel-static .btn{width:100%}
    .ctrl-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    .ctrl{display:flex;flex-direction:column;gap:6px;font-size:13px;color:var(--muted)}
    .ctrl input,.ctrl select{padding:9px 11px;border:1px solid var(--border);border-radius:12px;font:14px/1.5 "Averta Std","Nunito Sans","Helvetica Neue",Helvetica,Arial,sans-serif;color:var(--ink);background:#fff;transition:border-color .2s ease,box-shadow .2s ease}
    #selIndividual[multiple]{min-height:160px;padding:12px;border-radius:16px}
    .ctrl input:focus,.ctrl select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,123,195,.2)}
    .ctrl input[type="color"]{padding:0;height:40px;border-radius:12px;overflow:hidden}
    .ctrl small{color:var(--muted);font-size:12px}
    .ctrl-inline{display:flex;gap:10px;align-items:center;font-size:13px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
    .selection-actions{display:flex;flex-direction:column;gap:10px}
    .selection-actions .btn{width:100%}
    .viewer{display:flex;flex-direction:column;gap:20px}
    .viewer-tabs{display:flex;gap:12px;flex-wrap:nowrap;background:var(--surface);padding:12px;border-radius:24px;box-shadow:0 14px 30px rgba(9,42,58,.08);position:sticky;top:0;z-index:10}
    .viewer-tab{appearance:none;border:1px solid rgba(0,0,0,.04);border-radius:999px;padding:clamp(10px,2vw,14px) clamp(12px,5vw,24px);font-size:clamp(12px,3vw,15px);font-weight:700;background:transparent;color:var(--muted);cursor:pointer;transition:all .2s ease;box-shadow:none;flex:1 1 0;min-width:0;text-align:center;white-space:nowrap}
    .viewer-tab:hover{color:var(--accent)}
    .viewer-tab.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 10px 20px rgba(0,123,195,.18)}
    .view-panel{display:none}
    .view-panel.active{display:block}
    .pdf-toolbar{display:flex;flex-wrap:wrap;align-items:center;gap:16px;margin-bottom:16px;padding:20px 22px;border:1px solid var(--border);border-radius:24px;background:var(--surface);box-shadow:0 18px 36px rgba(7,45,65,.08)}
    .pdf-toolbar .btn{flex:0 0 auto}
    .pdf-toolbar-hint{margin:0;font-size:13px;color:var(--muted);max-width:480px}
    .schedule-view{display:flex;flex-direction:column;gap:24px}
    .line-view{display:flex;flex-direction:column;gap:18px}
    .line-controls{display:flex;flex-wrap:wrap;gap:14px}
    .line-controls .ctrl{min-width:180px;flex:1 1 160px}
    .line-controls .ctrl span{font-weight:600;color:var(--ink)}
    .line-window-hint{margin:0;font-size:12px;color:var(--muted);max-width:320px}
    .line-presets{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .line-preset-btn{appearance:none;border-radius:999px;border:1px solid var(--border);background:var(--surface-soft);color:var(--muted);font-weight:600;padding:8px 16px;font-size:13px;cursor:pointer;transition:background .2s ease,color .2s ease,border-color .2s ease,box-shadow .2s ease}
    .line-preset-btn:hover{background:var(--accent-soft);color:var(--accent)}
    .line-preset-btn:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .line-preset-btn[disabled]{opacity:.5;cursor:not-allowed;box-shadow:none}
    .line-preset-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 10px 20px rgba(0,123,195,.18)}
    .line-day-summary{font-size:16px;font-weight:600;color:var(--muted)}
    .line-chart-shell{position:relative;border:1px solid var(--border);border-radius:24px;background:var(--surface);box-shadow:0 18px 36px rgba(7,45,65,.08);padding:24px;display:flex;flex-direction:column;gap:18px;--line-axis-height:36px;--line-track-gap:12px;touch-action:pan-y}
    .line-chart-shell[hidden]{display:none !important}
    .line-chart-axis{position:relative;height:var(--line-axis-height)}
    .line-axis-tick{position:absolute;bottom:0;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:6px;font-size:12px;color:var(--muted);white-space:nowrap}
    .line-axis-tick::before{content:"";width:1px;height:16px;background:var(--grid);display:block}
    .line-axis-label{padding:2px 8px;border-radius:999px;background:var(--surface-soft);font-weight:600;color:var(--muted);box-shadow:0 6px 14px rgba(7,45,65,.08)}
    .line-chart-rows{display:flex;flex-direction:column;gap:var(--line-track-gap)}
    .line-row{display:flex;flex-direction:column;gap:0}
    .line-row.highlight .line-row-track{border-color:#0d9488;box-shadow:inset 0 0 0 1px rgba(13,148,136,.35)}
    .line-row-track{position:relative;height:52px;border:1px solid var(--border);border-radius:18px;background:var(--surface-soft);overflow:visible}
    .line-track-marker{position:absolute;top:0;bottom:0;width:0;border-left:1px solid var(--grid);opacity:.5;pointer-events:none}
    .line-track-marker.minor{opacity:.25}
    .line-bar{position:absolute;top:50%;transform:translateY(-50%);height:36px;border-radius:18px;background:var(--accent);display:flex;align-items:center;justify-content:center;padding:0 24px;box-shadow:0 12px 24px rgba(0,123,195,.2);color:#fff;min-width:6px;z-index:1}
    .line-bar.highlight{background:#0d9488;box-shadow:0 12px 24px rgba(13,148,136,.18)}
    .line-bar.thin{padding:0 12px}
    .line-bar-name{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.85);color:var(--ink);padding:4px 10px;border-radius:999px;font-size:13px;font-weight:700;white-space:nowrap;box-shadow:0 8px 16px rgba(9,42,58,.12)}
    .line-bar.thin .line-bar-name{display:none}
    .line-bar-time{position:absolute;top:50%;transform:translateY(-50%);font-size:12px;font-weight:700;color:#fff;padding:3px 8px;border-radius:12px;white-space:nowrap;--line-time-shift:0px;z-index:2;pointer-events:none}
    .line-bar-time.start{left:-10px;transform:translate(calc(-100% + var(--line-time-shift,0px)),-50%);background:#059669}
    .line-bar-time.end{right:-10px;transform:translate(calc(100% - var(--line-time-shift,0px)),-50%);background:#dc2626}
    .line-bar-time.clipped{opacity:1}
    .line-bar-time.bumped{top:50%;transform:translateY(-50%);box-shadow:0 6px 16px rgba(9,42,58,.16)}
    .line-bar-time.start.bumped{transform:translate(calc(-100% + var(--line-time-shift,0px)),-50%)}
    .line-bar-time.end.bumped{transform:translate(calc(100% - var(--line-time-shift,0px)),-50%)}
    .line-chart-empty{border:1px dashed var(--border);border-radius:18px;padding:18px;color:var(--muted);font-size:14px;text-align:center;background:var(--surface-soft)}
    .line-view-placeholder{border:1px dashed var(--border);border-radius:24px;padding:28px;text-align:center;color:var(--muted);background:var(--surface);font-size:15px;box-shadow:0 18px 36px rgba(7,45,65,.08)}
    .line-week-individual{border:1px solid var(--border);border-radius:24px;background:var(--surface);box-shadow:0 18px 36px rgba(7,45,65,.08);padding:24px;display:flex;flex-direction:column;gap:16px}
    .line-week-individual-title{margin:0;font-size:20px;font-weight:700;color:var(--ink)}
    .line-week-individual-subtitle{margin:0;font-size:14px;color:var(--muted)}
    .line-week-rows{display:flex;flex-direction:column;gap:14px}
    .line-week-row{display:flex;flex-direction:column;gap:8px;border:1px solid var(--border);border-radius:18px;padding:14px 16px;background:var(--surface-soft)}
    .line-week-row.highlight{border-color:#00b2a9;background:rgba(0,178,169,.08)}
    .line-week-row-header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .line-week-row-day{font-weight:700;color:var(--ink);font-size:15px}
    .line-week-row-time{font-size:13px;color:var(--muted);text-align:right}
    .line-week-row-duration{font-size:12px;color:var(--muted);font-weight:600}
    .line-week-row-off{font-size:13px;font-weight:700;color:#a4161a}
    .line-week-bar-track{position:relative;height:36px;border-radius:999px;background:var(--surface);border:1px solid var(--border);overflow:hidden}
    .line-week-bar{position:absolute;top:4px;bottom:4px;border-radius:999px;background:var(--accent);box-shadow:0 10px 20px rgba(0,123,195,.18)}
    .line-week-bar.highlight{background:#0d9488}
    .line-week-bar-label{position:absolute;top:50%;left:10px;transform:translateY(-50%);font-size:12px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.2)}
    .line-week-track-hint{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}
    .schedule-week{display:flex;flex-direction:column;gap:18px}
    .schedule-week-heading{display:flex;flex-direction:column;gap:4px}
    .schedule-week-title{font-size:20px;font-weight:700;color:var(--ink)}
    .schedule-week-range{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .schedule-header{display:flex;flex-direction:column;gap:10px}
    .schedule-range{font-size:16px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.1em}
    .schedule-days{display:grid;gap:20px}
    .schedule-day-card{border:1px solid var(--border);border-radius:24px;background:var(--surface);box-shadow:0 18px 36px rgba(7,45,65,.08);overflow:hidden;transition:transform .2s ease,box-shadow .2s ease}
    .schedule-day-card:hover{transform:translateY(-2px);box-shadow:0 22px 44px rgba(7,45,65,.12)}
    .schedule-day-card summary{cursor:pointer;list-style:none;padding:24px 28px;display:flex;justify-content:space-between;align-items:center;gap:12px;font-weight:700;color:var(--ink);background:linear-gradient(90deg,var(--surface) 0%,var(--surface-soft) 100%)}
    .schedule-day-card summary::-webkit-details-marker{display:none}
    .schedule-day-card summary::after{content:'▾';font-size:14px;color:var(--muted);transition:transform .2s ease,color .2s ease}
    .schedule-day-card[open] summary::after{transform:rotate(180deg);color:var(--accent)}
    .schedule-day-summary-text{display:flex;flex-direction:column;gap:6px}
    .schedule-day-card.today{border-color:var(--accent);box-shadow:0 24px 48px rgba(0,123,195,.12)}
    .schedule-day-card.today summary{background:linear-gradient(90deg,var(--accent-soft) 0%,var(--surface) 100%)}
    .schedule-day-card.today .schedule-day-title{color:var(--accent-strong)}
    .schedule-day-card.today .schedule-day-today-badge{display:inline-flex;align-items:center;justify-content:center;padding:4px 10px;border-radius:999px;background:var(--accent);color:#fff;font-size:11px;font-weight:700;letter-spacing:.3px;text-transform:uppercase}
    .schedule-day-header{display:flex;flex-direction:column;gap:6px}
    .schedule-day-title{font-size:22px;font-weight:700;color:var(--ink)}
    .schedule-day-subtitle{font-size:14px;color:var(--muted)}
    .schedule-day-content{padding:0 28px 28px;display:flex;flex-direction:column;gap:16px;background:var(--surface)}
    .schedule-shifts{display:flex;flex-direction:column;gap:12px}
    .shift-card{border:1px solid transparent;border-radius:16px;padding:16px 18px;display:flex;justify-content:space-between;align-items:center;gap:16px;background:var(--surface-soft);transition:box-shadow .2s ease,border-color .2s ease,background .2s ease,transform .2s ease}
    .shift-card:hover{transform:translateX(2px);box-shadow:0 14px 30px rgba(9,42,58,.08)}
    .shift-card.highlight{border-color:#00b2a9;background:rgba(0,178,169,.1)}
    .shift-card.selected{border-color:var(--accent);background:rgba(0,123,195,.12)}
    .shift-card.highlight.selected{border-color:#008f88;background:rgba(0,178,169,.18)}
    .shift-card .shift-name{font-weight:700;color:var(--ink);font-size:16px}
    .shift-card .shift-time{font-size:14px;color:var(--muted);display:flex;flex-direction:column;align-items:flex-end;gap:4px;text-align:right}
    .shift-card .shift-duration{font-size:13px;color:var(--muted);font-weight:600}
    .shift-card .shift-split{font-size:12px;color:var(--muted)}
    .no-shifts{border:1px dashed var(--border);border-radius:18px;padding:18px;color:var(--muted);text-align:center;font-size:14px;background:var(--surface-soft)}
    .empty-state{border:1px dashed var(--border);border-radius:24px;padding:32px;text-align:center;color:var(--muted);background:var(--surface);font-size:16px;box-shadow:0 18px 36px rgba(7,45,65,.08)}
    .empty-state strong{display:block;font-size:20px;color:var(--ink);margin-bottom:8px}
    .schedule-individual{border:1px solid var(--border);border-radius:24px;padding:24px 28px;background:var(--surface);box-shadow:0 18px 36px rgba(7,45,65,.08);display:flex;flex-direction:column;gap:20px}
    .schedule-individual-title{margin:0;font-size:22px;font-weight:700;color:var(--ink)}
    .individual-list{display:flex;flex-direction:column;gap:12px}
    .individual-item{border:1px solid transparent;border-radius:18px;padding:16px 18px;display:flex;justify-content:space-between;align-items:flex-start;gap:16px;background:var(--surface-soft);transition:box-shadow .2s ease,border-color .2s ease,background .2s ease,transform .2s ease}
    .individual-item:hover{transform:translateX(2px);box-shadow:0 14px 30px rgba(9,42,58,.08)}
    .individual-item.highlight{border-color:#00b2a9;background:rgba(0,178,169,.1)}
    .individual-item-day{font-weight:700;color:var(--ink);font-size:16px}
    .individual-item-time{font-size:14px;color:var(--muted);text-align:right;display:flex;flex-direction:column;gap:4px}
    .individual-item-duration{font-size:13px;color:var(--muted);font-weight:600}
    .individual-item-segments{font-size:12px;color:var(--muted)}
    .individual-item-off{color:#a4161a;font-weight:700}
    .individual-summary{border:1px solid var(--border);border-radius:24px;padding:24px 28px;background:var(--surface);box-shadow:0 18px 36px rgba(7,45,65,.08);display:flex;flex-direction:column;gap:16px}
    .individual-summary h2{margin:0;font-size:22px;font-weight:700;color:var(--ink)}
    .individual-summary p{margin:0;font-size:14px;color:var(--muted)}
    .individual-summary ul{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px}
    .individual-summary li{display:flex;justify-content:space-between;align-items:center;font-size:14px;padding:10px 0;border-bottom:1px solid var(--border)}
    .individual-summary li:last-child{border-bottom:none}
    .individual-summary .day-label{font-weight:700;color:var(--ink)}
    .individual-summary .day-time{color:var(--muted);font-size:14px;text-align:right}
    .individual-summary .day-off{color:#a4161a;font-weight:700}
    .btn-clear-selection{align-self:flex-start;margin-top:4px;padding:8px 14px;border:1px solid transparent;border-radius:999px;background:transparent;font-size:14px;font-weight:700;color:var(--accent);cursor:pointer;transition:all .2s ease}
    .btn-clear-selection:hover{background:var(--accent-soft);color:var(--accent-strong)}
    .btn-clear-selection:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .sheets{display:flex;flex-direction:column;gap:32px}
    .sheet{
      padding:24px;
      background:var(--sheet-bg);
      border:1px solid var(--sheet-border);
      border-radius:24px;
      box-shadow:0 24px 48px rgba(3,34,48,.14);
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .sheet-header{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:12px;
      padding-bottom:8px;
      border-bottom:1px solid rgba(19,57,74,.12);
    }
    .sheet-title{font-size:var(--sheet-title-size);font-weight:700;color:var(--ink);letter-spacing:-.01em}
    .sheet-range{font-size:var(--sheet-range-size);color:var(--muted);font-weight:600}
    .sheet-code{font-size:var(--sheet-code-size);font-weight:700;color:var(--ink);margin-top:8px}
    .sheet-date{font-size:var(--sheet-date-size);font-weight:700;color:var(--ink)}
    .sheet svg{width:100%;height:auto;display:block}
    .sheet-footer{margin-top:auto;font-size:var(--sheet-footer-size);color:var(--muted);text-align:right}
    .sheet-footnote{font-size:var(--sheet-footer-size);color:var(--muted);text-align:right;white-space:pre-wrap}
    .sheet-week-heading{font-size:18px;font-weight:700;color:var(--ink);margin:12px 0 8px}
    .axislabel{fill:#02293e;font-size:12px;font-family:"Averta Std","Nunito Sans","Helvetica Neue",Helvetica,Arial,sans-serif}
    .colheader{fill:var(--column-header-color,#02293e);font-size:var(--column-header-size,12px);font-weight:700;font-family:"Averta Std","Nunito Sans","Helvetica Neue",Helvetica,Arial,sans-serif;text-transform:uppercase;letter-spacing:.08em}
    .rowlabel{fill:var(--row-label-color,#02293e);font-size:var(--row-label-size,12px);dominant-baseline:middle;font-family:"Averta Std","Nunito Sans","Helvetica Neue",Helvetica,Arial,sans-serif}
    .gridline{stroke:var(--grid);stroke-width:1}
    .gridline-minor{stroke:#edf3f8;stroke-width:.6}
    .divider{stroke:#02293e;stroke-width:1.2}
    .bar{fill:#19649b}
    .barlabel{fill:#fff;font-size:var(--bar-label-size,11px);font-weight:700;dominant-baseline:middle;font-family:"Averta Std","Nunito Sans","Helvetica Neue",Helvetica,Arial,sans-serif}
    .mobile-hint{display:flex;align-items:center;gap:12px;padding:18px 20px;border-radius:20px;background:rgba(255,255,255,.7);box-shadow:0 12px 28px rgba(4,24,44,.12);font-size:14px;color:var(--muted)}
    .mobile-hint strong{color:var(--ink)}
    .mobile-hint-text{flex:1;display:flex;gap:8px;align-items:center}
    .mobile-hint-close{appearance:none;border:none;background:rgba(0,0,0,.06);color:var(--ink);width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:18px;line-height:1;display:flex;align-items:center;justify-content:center;transition:background .2s ease,color .2s ease}
    .mobile-hint-close:hover{background:rgba(0,0,0,.12);color:var(--accent)}
    .mobile-hint-close:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .appearance-controls{display:flex;flex-direction:column;gap:12px}
    .appearance-grid{display:flex;flex-direction:column;gap:10px}
    .appearance-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border:1px solid rgba(6,28,46,.1);border-radius:16px;background:var(--surface-soft)}
    .appearance-label{display:flex;flex-direction:column;font-weight:700;color:var(--ink);gap:2px;font-size:13px}
    .appearance-label small{font-size:11px;font-weight:600;color:var(--muted)}
    .appearance-color-input{width:52px;height:36px;border-radius:12px;border:1px solid var(--border);padding:0;background:#fff;cursor:pointer}
    .appearance-color-input:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .appearance-color-input:disabled{opacity:.5;cursor:not-allowed}
    .appearance-hint{margin-top:4px}
    .footer{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:960px){
      .wrap{padding:24px}
      .page-header{padding:28px;border-radius:28px}
      .side-panel{position:static}
      .viewer-tabs{justify-content:flex-start;position:static}
    }
    @media (max-width:640px){
      body{font-size:13px}
      .wrap{padding:20px}
      .page-header{padding:24px;border-radius:24px}
      .page-header h1{font-size:28px}
      .page-header p{font-size:15px}
      .page-header-cta{flex-direction:column}
      .controls{padding:22px;border-radius:24px}
      .pdf-toolbar{padding:18px;border-radius:20px}
      .schedule-day-card summary{padding:20px}
      .schedule-day-content{padding:0 20px 20px}
      .shift-card{flex-direction:column;align-items:flex-start}
      .shift-card .shift-time{text-align:left;align-items:flex-start}
      .individual-item{flex-direction:column;align-items:flex-start}
      .individual-item-time{text-align:left;align-items:flex-start}
    }
  </style>
</head>
<body>
  <button class="settings-toggle" id="btnToggleSettings" type="button" aria-label="Show settings panel" aria-expanded="false">⚙️</button>
  <div class="panel panel-static settings-panel" id="savedWeeksPanel" hidden aria-hidden="true">
    <h2 class="panel-title">Saved weeks</h2>
    <p class="control-hint">Upload new schedules and manage the saved weeks stored on this device.</p>
    <input type="file" id="fileInput" accept=".csv,text/csv" class="visually-hidden">
    <div class="saved-week-actions">
      <button class="btn btn-secondary" id="btnUpload" type="button">Upload CSV</button>
    </div>
    <div class="saved-week-actions">
      <button class="btn btn-secondary" id="btnForgetWeek" type="button">Forget selected week</button>
      <button class="btn btn-secondary" id="btnClearWeeks" type="button">Clear saved weeks</button>
    </div>
    <div id="appearanceControls" class="appearance-controls" hidden aria-hidden="true" role="group"></div>
  </div>
  <div class="wrap">
    <header class="page-header">
      <div>
        <h1>CSV Rota Viewer</h1>
        <p>Load an exported rota CSV to review weekly coverage, timelines, and printable PDFs—all processed locally in your browser. Start by uploading your latest file with the controls on the left.</p>
      </div>
    </header>

    <div class="mobile-hint" id="mobileHint" aria-live="polite">
      <div class="mobile-hint-text">
        <strong>Quick tip:</strong>
        <span>Add this page to your home screen for an app-like experience. All controls stay within thumb reach and the reports stay untouched.</span>
      </div>
      <button class="mobile-hint-close" id="btnDismissHint" type="button" aria-label="Dismiss quick tip">×</button>
    </div>

    <div class="layout">
      <aside class="side-panel">
        <div class="controls">
          <label class="saved-week-select" for="savedWeekSelect">
            <span>Saved week</span>
            <select id="savedWeekSelect" disabled></select>
          </label>
          <p class="saved-week-meta" id="savedWeekMeta" hidden></p>
          <label class="ctrl" for="selIndividual" id="reportScopeControl" hidden aria-hidden="true">
            <span>Report scope</span>
            <select id="selIndividual" multiple disabled aria-describedby="reportScopeHint">
              <option value="all">All colleagues</option>
            </select>
          </label>
          <div class="selection-actions" id="selectionActions" hidden aria-hidden="true">
            <button class="btn btn-secondary" id="btnManagementShortcut" type="button">Management</button>
            <button class="btn btn-secondary" id="btnClearSelection" type="button">Clear selection</button>
          </div>
          <p class="control-hint" id="reportScopeHint" hidden aria-hidden="true">Select one or more colleagues to focus every preview and export.</p>
        </div>
      </aside>
      <main class="main-panel">
        <div class="viewer" id="viewerContainer" hidden aria-hidden="true">
          <div class="viewer-tabs" role="tablist" aria-label="Preview modes" hidden aria-hidden="true">
            <button class="viewer-tab active" id="tabSchedule" type="button" role="tab" aria-selected="true" aria-controls="viewSchedule" data-view="schedule">Schedule view</button>
            <button class="viewer-tab" id="tabLine" type="button" role="tab" aria-selected="false" aria-controls="viewLine" data-view="line">Line view</button>
            <button class="viewer-tab" id="tabPdf" type="button" role="tab" aria-selected="false" aria-controls="viewPdf" data-view="pdf">PDF preview</button>
          </div>
          <section id="viewSchedule" class="view-panel active" role="tabpanel" aria-labelledby="tabSchedule">
            <div id="scheduleView" class="schedule-view"></div>
          </section>
          <section id="viewLine" class="view-panel" role="tabpanel" aria-labelledby="tabLine">
            <div id="lineView" class="line-view">
              <div class="line-controls" id="lineControls" role="region" aria-label="Line view controls" hidden aria-hidden="true">
                <label class="ctrl" for="lineDaySelect">
                  <span>Day</span>
                  <select id="lineDaySelect" disabled></select>
                </label>
              <p class="control-hint line-window-hint" id="lineWindowHint">Pinch to zoom the visible hours and drag the timeline to pan.</p>
            </div>
            <div class="line-day-summary" id="lineDaySummary" hidden></div>
            <div class="line-week-individual" id="lineIndividualWeek" hidden aria-hidden="true"></div>
            <div class="line-presets" id="linePresetButtons" hidden aria-hidden="true">
              <button class="line-preset-btn" type="button" data-start="300" data-end="870" aria-label="Show 5:00am to 2:30pm">Morning</button>
                <button class="line-preset-btn" type="button" data-start="540" data-end="1080" aria-label="Show 9:00am to 6:00pm">Midday</button>
                <button class="line-preset-btn" type="button" data-start="810" data-end="1380" aria-label="Show 1:30pm to 11:00pm">Evening</button>
              </div>
              <div class="line-chart-shell" id="lineChartShell" hidden aria-hidden="true">
                <div class="line-chart-axis" id="lineChartAxis"></div>
                <div class="line-chart-rows" id="lineChartRows"></div>
              </div>
              <div class="line-view-placeholder" id="lineViewEmpty" hidden>
                <strong>Upload a rota</strong>Load a CSV to explore a condensed timeline of each colleague&#39;s shifts.
              </div>
            </div>
          </section>
          <section id="viewPdf" class="view-panel" role="tabpanel" aria-labelledby="tabPdf">
            <div class="pdf-toolbar" role="region" aria-label="PDF export options">
              <button class="btn btn-secondary" id="btnExport" type="button" disabled>Export PDF</button>
              <p class="pdf-toolbar-hint">Exports the weekly overview or the selected colleague.</p>
            </div>
            <div class="sheets" id="sheets"></div>
          </section>
        </div>
        <div class="footer">Client-side only: all rota data stays on your device, is processed locally in the browser (including any cached copies stored via localStorage), and is never sent to a server. Built with pdf-lib to convert the SVG output into shareable landscape PDFs. This workflow is designed to help you meet GDPR obligations because no personal data leaves your device; please ensure you have authority to handle any rota data you load.</div>
      </main>
    </div>
    <textarea id="input" hidden></textarea>
  </div>

  <script src="pdf-lib.min.js"></script>
  <script>
    // ---------- Utilities ----------
    const pad2=n=>String(n).padStart(2,'0');
    const toMin=(h,m)=>parseInt(h,10)*60+parseInt(m,10);
    const fmtHM=mins=>{const m=((mins%1440)+1440)%1440;const h=Math.floor(m/60), mm=m%60;return `${pad2(h)}:${pad2(mm)}`};
    const fmtHMDisplay=mins=>{
      if(Number.isNaN(mins)) return '';
      const total=((mins%1440)+1440)%1440;
      const hours=Math.floor(total/60);
      const minutes=total%60;
      const suffix=hours>=12?'pm':'am';
      const hour12=(hours%12)||12;
      const minutePart=minutes===0?'':`:${pad2(minutes)}`;
      return `${hour12}${minutePart}${suffix}`;
    };

    function cleanColleagueName(raw){
      if(typeof raw!=='string') return '';
      const trimmed=raw.trim();
      if(!trimmed) return '';
      const noId=trimmed.replace(/\s*\([^)]*\)\s*/g,' ').trim();
      if(!noId) return trimmed;
      const parts=noId.split(/\s+/);
      return parts.length?parts[parts.length-1]:trimmed;
    }

    function getRowDisplayName(row,index){
      const fallbackLabel=`Colleague ${index}`;
      if(!row) return fallbackLabel;
      const cleaned=(row.name||'').trim();
      if(cleaned) return cleaned;
      const fromRaw=cleanColleagueName(row.rawName||'');
      if(fromRaw) return fromRaw;
      const stripped=(row.rawName||'').replace(/\s*\([^)]*\)\s*/g,' ').trim();
      return stripped||fallbackLabel;
    }

    function resolveDisplayNameForIndex(model,index){
      if(!model || !Array.isArray(model.rows) || !Number.isInteger(index)) return `Colleague ${index+1}`;
      const record=lastIndividuals.find(rec=>rec.index===index);
      if(record && record.displayName) return record.displayName;
      const row=model.rows[index];
      return getRowDisplayName(row,index+1);
    }

    const SPECIAL_NAME_COLOR='#0d9488';
    const MANAGEMENT_SHORTCUT_NAMES=['samantha','elizabeth','joshua','laura','nathan'];

    function isNathanName(name){
      if(!name) return false;
      const normalized=String(name).toLowerCase().replace(/[^a-z\s]/g,' ');
      if(!normalized.trim()) return false;
      const tokens=normalized.split(/\s+/).filter(Boolean);
      return tokens.some(token=>token.startsWith('nathan') || token.startsWith('nathen') || token.startsWith('nate'));
    }

    const STATIC_CODE='7774';
    const DAY_NAME_MAP={sun:'Sunday',mon:'Monday',tue:'Tuesday',wed:'Wednesday',thu:'Thursday',fri:'Friday',sat:'Saturday'};
    const MONTH_NAMES=['January','February','March','April','May','June','July','August','September','October','November','December'];

    function sanitizeFileName(name,defaultName='schedule'){
      if(typeof name!=='string') return defaultName;
      const trimmed=name.trim();
      if(!trimmed) return defaultName;
      const normalized=trimmed
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9 _-]+/gi,'')
        .trim()
        .replace(/\s+/g,'_');
      if(!normalized) return defaultName;
      return normalized.slice(0,120);
    }

    function ordinal(n){
      const rem10=n%10;
      const rem100=n%100;
      if(rem10===1 && rem100!==11) return `${n}st`;
      if(rem10===2 && rem100!==12) return `${n}nd`;
      if(rem10===3 && rem100!==13) return `${n}rd`;
      return `${n}th`;
    }

    function parseDayHeader(label){
      if(!label) return null;
      const match=label.match(/([A-Za-z]{3,})\s*\(?\s*(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\s*\)?/);
      if(!match) return null;
      const [,dayPart,dayStr,monthStr,yearStr]=match;
      const dayNum=parseInt(dayStr,10);
      const monthNum=parseInt(monthStr,10);
      if(Number.isNaN(dayNum) || Number.isNaN(monthNum)) return null;
      const key=dayPart.slice(0,3).toLowerCase();
      const dayName=DAY_NAME_MAP[key] || dayPart;
      let year=undefined;
      if(yearStr){
        const yr=parseInt(yearStr,10);
        if(!Number.isNaN(yr)){
          year=yearStr.length===2?2000+yr:yr;
        }
      }
      return {dayName,day:dayNum,month:monthNum,year};
    }

    function extractYearFromLabel(text){
      if(typeof text!=='string' || !text.trim()) return null;
      const matches=Array.from(text.matchAll(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/g));
      if(matches.length){
        const last=matches[matches.length-1];
        const rawYear=parseInt(last[3],10);
        if(!Number.isNaN(rawYear)){
          return last[3].length===2?2000+rawYear:rawYear;
        }
      }
      const standalone=text.match(/\b(20\d{2})\b/);
      if(standalone){
        const year=parseInt(standalone[1],10);
        if(!Number.isNaN(year)) return year;
      }
      return null;
    }

    function isTodayDate(part,fallbackYear){
      if(!part) return false;
      const today=new Date();
      const todayDay=today.getDate();
      const todayMonth=today.getMonth()+1;
      const todayYear=today.getFullYear();
      const resolvedYear=Number.isInteger(part.year)?part.year:(Number.isInteger(fallbackYear)?fallbackYear:null);
      if(resolvedYear!==null && resolvedYear!==todayYear) return false;
      return part.day===todayDay && part.month===todayMonth;
    }

    function formatFullDayLabel(label){
      const parsed=parseDayHeader(label);
      if(!parsed) return label;
      const monthName=MONTH_NAMES[parsed.month-1] || '';
      const pieces=[parsed.dayName || '', ordinal(parsed.day), monthName];
      if(parsed.year) pieces.push(parsed.year);
      return pieces.filter(Boolean).join(' ');
    }

    function formatShortDayLabel(label){
      const parsed=parseDayHeader(label);
      if(!parsed) return label || '';
      const abbrev=(parsed.dayName||'').slice(0,3);
      const parts=[];
      if(abbrev) parts.push(abbrev);
      if(Number.isFinite(parsed.day) && Number.isFinite(parsed.month)){
        parts.push(`${pad2(parsed.day)}/${pad2(parsed.month)}`);
      }
      if(parsed.year && !parts.length){
        parts.push(String(parsed.year));
      }
      return parts.length?parts.join(' '):(label||'');
    }

    function formatDuration(mins){
      if(!Number.isFinite(mins) || mins<=0) return '';
      const total=Math.round(mins);
      const hours=Math.floor(total/60);
      const minutes=total%60;
      const pieces=[];
      if(hours>0) pieces.push(`${hours}h`);
      if(minutes>0) pieces.push(`${minutes}m`);
      return pieces.join(' ');
    }

    function formatRangeDate(part){
      if(!part) return '';
      const day=pad2(part.day);
      const month=pad2(part.month);
      return `${day}/${month}${part.year?`/${part.year}`:''}`;
    }

    function buildDateRangeLabel(model){
      if(model && typeof model.sub==='string'){
        const match=model.sub.match(/Date\s*range\s*:\s*(.+)/i);
        if(match) return `Date range: ${match[1].trim()}`;
      }
      if(!model || !Array.isArray(model.dayHeaders) || !model.dayHeaders.length) return '';
      const parsed=model.dayHeaders.map(parseDayHeader).filter(Boolean);
      if(!parsed.length) return '';
      const start=parsed[0];
      const end=parsed[parsed.length-1];
      const startStr=formatRangeDate(start);
      const endStr=formatRangeDate(end);
      if(!startStr && !endStr) return '';
      if(startStr && endStr) return `Date range: ${startStr} - ${endStr}`;
      return `Date range: ${startStr || endStr}`;
    }

    const STORAGE_KEY='loggannt.rotas.v1';
    const STORAGE_SELECTION_KEY='loggannt.rotas.selection';
    const STORAGE_COLOR_KEY='loggannt.rotas.colors';
    const STORAGE_HOME_TIP_KEY='loggannt.rotas.homeTipDismissed';
    const MAX_STORED_WEEKS=4;

    function sanitizeModelForStorage(model){
      if(!model || typeof model!=='object'){
        return {title:'',sub:'',dayHeaders:[],rows:[]};
      }
      const title=typeof model.title==='string'?model.title:'';
      const sub=typeof model.sub==='string'?model.sub:'';
      const dayHeaders=Array.isArray(model.dayHeaders)?model.dayHeaders.map(header=>String(header||'')):[];
      const rows=Array.isArray(model.rows)?model.rows.map(row=>{
        const days=Array.isArray(row && row.days)?row.days.map(cell=>String(cell||'')):[];
        return {
          name:row && typeof row.name==='string'?row.name:'',
          rawName:row && typeof row.rawName==='string'?row.rawName:'',
          days,
        };
      }):[];
      return {title,sub,dayHeaders,rows};
    }

    function cloneStoredModel(model){
      if(!model || typeof model!=='object'){
        return {title:'',sub:'',dayHeaders:[],rows:[]};
      }
      return {
        title:typeof model.title==='string'?model.title:'',
        sub:typeof model.sub==='string'?model.sub:'',
        dayHeaders:Array.isArray(model.dayHeaders)?model.dayHeaders.map(header=>String(header||'')):[],
        rows:Array.isArray(model.rows)?model.rows.map(row=>({
          name:row && typeof row.name==='string'?row.name:'',
          rawName:row && typeof row.rawName==='string'?row.rawName:'',
          days:Array.isArray(row && row.days)?row.days.map(cell=>String(cell||'')):[],
        })) : [],
      };
    }

    function hashWeekKey(value){
      const text=String(value||'');
      let hash=0;
      for(let i=0;i<text.length;i++){
        hash=(hash*31+text.charCodeAt(i))|0;
      }
      return `wk-${Math.abs(hash)}`;
    }

    function dateFromParts(part,fallbackYear){
      if(!part || !Number.isInteger(part.day) || !Number.isInteger(part.month)) return null;
      const year=Number.isInteger(part.year)?part.year:(Number.isInteger(fallbackYear)?fallbackYear:null);
      if(year===null) return null;
      const date=new Date(year,part.month-1,part.day);
      if(Number.isNaN(date.getTime())) return null;
      return date;
    }

    function resolveFallbackYear(parsedHeaders,model){
      const withYear=parsedHeaders.find(info=>info && Number.isInteger(info.year));
      if(withYear) return withYear.year;
      const fromSub=extractYearFromLabel(model && model.sub);
      if(Number.isInteger(fromSub)) return fromSub;
      const fromTitle=extractYearFromLabel(model && model.title);
      if(Number.isInteger(fromTitle)) return fromTitle;
      return null;
    }

    function findTodayDayIndex(dayHeaders,model){
      if(!Array.isArray(dayHeaders) || !dayHeaders.length) return -1;
      const parsed=dayHeaders.map(parseDayHeader);
      if(!parsed.length) return -1;
      const fallbackYear=resolveFallbackYear(parsed,model||{});
      for(let i=0;i<parsed.length;i+=1){
        if(isTodayDate(parsed[i],fallbackYear)){
          return i;
        }
      }
      return -1;
    }

    function deriveWeekMetadata(model){
      const dayHeaders=Array.isArray(model && model.dayHeaders)?model.dayHeaders:[];
      const parsed=dayHeaders.map(parseDayHeader);
      const fallbackYear=resolveFallbackYear(parsed,model||{});
      const firstIdx=parsed.findIndex(part=>part && Number.isInteger(part.day) && Number.isInteger(part.month));
      let lastIdx=-1;
      for(let i=parsed.length-1;i>=0;i--){
        const part=parsed[i];
        if(part && Number.isInteger(part.day) && Number.isInteger(part.month)){
          lastIdx=i;
          break;
        }
      }
      const firstPart=firstIdx>=0?parsed[firstIdx]:null;
      const lastPart=lastIdx>=0?parsed[lastIdx]:null;
      const startDate=dateFromParts(firstPart,fallbackYear);
      const endDate=dateFromParts(lastPart,fallbackYear);
      const startIso=startDate?startDate.toISOString().slice(0,10):null;
      const endIso=endDate?endDate.toISOString().slice(0,10):null;
      const rangeLabel=buildDateRangeLabel(model);
      let label='';
      if(firstIdx>=0){
        label=`Week of ${formatFullDayLabel(dayHeaders[firstIdx])}`;
      }else if(rangeLabel){
        label=rangeLabel;
      }else if(model && typeof model.title==='string' && model.title.trim()){
        label=model.title.trim();
      }else{
        label='Saved rota';
      }
      const fingerprint=[model && model.title?model.title:'',model && model.sub?model.sub:'',dayHeaders.join('|')].join('::');
      const id=startIso?`week-${startIso}`:hashWeekKey(fingerprint);
      return {id,label,startIso,endIso,displayRange:rangeLabel||''};
    }

    const DEFAULT_LAYOUT={
      title:'Daily Colleague Summary',
      subtitleOverride:'',
      staticCode:STATIC_CODE,
      footerTemplate:'Page {page} of {total}',
      footerNote:'',
      rowHeight:28,
      chartWidth:1150,
      nameColumnWidth:140,
      headerHeight:36,
      padding:14,
      titleSize:26,
      subtitleSize:22,
      codeSize:21,
      dateSize:16,
      footerSize:12,
      columnHeaderSize:12,
      rowLabelSize:12,
      barLabelSize:11,
      barColor:'#4b4b4b',
      barLabelColor:'#ffffff',
      headerBandColor:'#efefef',
      gridColor:'#bfbfbf',
      minorGridColor:'#e5e5e5',
      axisColor:'#111111',
      columnHeaderColor:'#111111',
      rowLabelColor:'#111111',
      sheetBackground:'#ffffff',
      sheetBorder:'#000000',
      pageBackground:'#ffffff',
    };

    let currentLayout={...DEFAULT_LAYOUT};

    function readControlValue(id){
      const el=document.getElementById(id);
      return el?el.value:'';
    }

    function readNumberValue(id,fallback){
      const raw=readControlValue(id);
      const num=parseFloat(raw);
      return Number.isFinite(num)?num:fallback;
    }

    function getLayoutSettings(){
      const layout={...DEFAULT_LAYOUT};
      layout.title=readControlValue('inpTitle')||DEFAULT_LAYOUT.title;
      layout.subtitleOverride=readControlValue('inpSubtitle').trim();
      const staticCode=readControlValue('inpStaticCode').trim();
      layout.staticCode=staticCode||DEFAULT_LAYOUT.staticCode;
      layout.footerTemplate=readControlValue('inpFooter')||DEFAULT_LAYOUT.footerTemplate;
      layout.footerNote=readControlValue('inpFooterNote').trim();
      layout.rowHeight=readNumberValue('inpRowHeight',DEFAULT_LAYOUT.rowHeight);
      layout.chartWidth=readNumberValue('inpChartWidth',DEFAULT_LAYOUT.chartWidth);
      layout.nameColumnWidth=DEFAULT_LAYOUT.nameColumnWidth;
      layout.headerHeight=readNumberValue('inpHeaderHeight',DEFAULT_LAYOUT.headerHeight);
      layout.padding=readNumberValue('inpPadding',DEFAULT_LAYOUT.padding);
      layout.titleSize=readNumberValue('inpTitleSize',DEFAULT_LAYOUT.titleSize);
      layout.subtitleSize=DEFAULT_LAYOUT.subtitleSize;
      layout.codeSize=DEFAULT_LAYOUT.codeSize;
      layout.dateSize=readNumberValue('inpDateSize',DEFAULT_LAYOUT.dateSize);
      layout.footerSize=readNumberValue('inpFooterSize',DEFAULT_LAYOUT.footerSize);
      layout.columnHeaderSize=readNumberValue('inpColumnHeaderSize',DEFAULT_LAYOUT.columnHeaderSize);
      layout.rowLabelSize=readNumberValue('inpRowLabelSize',DEFAULT_LAYOUT.rowLabelSize);
      layout.barLabelSize=readNumberValue('inpBarLabelSize',DEFAULT_LAYOUT.barLabelSize);
      layout.barColor=readControlValue('inpBarColor')||DEFAULT_LAYOUT.barColor;
      layout.barLabelColor=readControlValue('inpBarLabelColor')||DEFAULT_LAYOUT.barLabelColor;
      layout.headerBandColor=readControlValue('inpHeaderBandColor')||DEFAULT_LAYOUT.headerBandColor;
      layout.gridColor=readControlValue('inpGridColor')||DEFAULT_LAYOUT.gridColor;
      layout.minorGridColor=readControlValue('inpMinorGridColor')||DEFAULT_LAYOUT.minorGridColor;
      layout.axisColor=readControlValue('inpAxisColor')||DEFAULT_LAYOUT.axisColor;
      layout.columnHeaderColor=readControlValue('inpColumnHeaderColor')||DEFAULT_LAYOUT.columnHeaderColor;
      layout.rowLabelColor=readControlValue('inpRowLabelColor')||DEFAULT_LAYOUT.rowLabelColor;
      layout.sheetBackground=readControlValue('inpSheetBgColor')||DEFAULT_LAYOUT.sheetBackground;
      layout.sheetBorder=readControlValue('inpSheetBorderColor')||DEFAULT_LAYOUT.sheetBorder;
      layout.pageBackground=readControlValue('inpPageBgColor')||DEFAULT_LAYOUT.pageBackground;
      return layout;
    }

    function applyLayoutCssVariables(style,layout){
      if(!style || typeof style.setProperty!=='function') return;
      style.setProperty('--page-bg',layout.pageBackground);
      style.setProperty('--sheet-bg',layout.sheetBackground);
      style.setProperty('--sheet-border',layout.sheetBorder);
      style.setProperty('--sheet-header-band',layout.headerBandColor);
      style.setProperty('--sheet-title-size',`${layout.titleSize}px`);
      style.setProperty('--sheet-range-size',`${layout.subtitleSize}px`);
      style.setProperty('--sheet-code-size',`${layout.codeSize}px`);
      style.setProperty('--sheet-date-size',`${layout.dateSize}px`);
      style.setProperty('--sheet-footer-size',`${layout.footerSize}px`);
      style.setProperty('--column-header-size',`${layout.columnHeaderSize}px`);
      style.setProperty('--column-header-color',layout.columnHeaderColor);
      style.setProperty('--row-label-size',`${layout.rowLabelSize}px`);
      style.setProperty('--bar-label-size',`${layout.barLabelSize}px`);
      style.setProperty('--bar-color',layout.barColor);
      style.setProperty('--bar-label-color',layout.barLabelColor);
      style.setProperty('--header-band-color',layout.headerBandColor);
      style.setProperty('--grid-color',layout.gridColor);
      style.setProperty('--minor-grid-color',layout.minorGridColor);
      style.setProperty('--axis-color',layout.axisColor);
      style.setProperty('--row-label-color',layout.rowLabelColor);
    }

    function applyLayoutToElement(element,layout){
      if(!element) return;
      applyLayoutCssVariables(element.style,layout);
    }

    function applyLayoutToDocument(layout){
      applyLayoutCssVariables(document.documentElement.style,layout);
    }

    function buildSvgStyleBlock(theme){
      const axis=theme.axisColor;
      const columnHeaderColor=theme.columnHeaderColor || axis;
      const columnHeaderSize=theme.columnHeaderSize || DEFAULT_LAYOUT.columnHeaderSize;
      const axisLabelSize=Math.max(10,Math.round((theme.axisLabelSize||columnHeaderSize*0.9)));
      const rowLabelColor=theme.rowLabelColor || DEFAULT_LAYOUT.rowLabelColor;
      const rowLabelSize=theme.rowLabelSize || DEFAULT_LAYOUT.rowLabelSize;
      const barLabelColor=theme.barLabelColor || DEFAULT_LAYOUT.barLabelColor;
      const barLabelSize=theme.barLabelSize || DEFAULT_LAYOUT.barLabelSize;
      return `
      .axislabel{fill:${axis};font-size:${axisLabelSize}px;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
      .colheader{fill:${columnHeaderColor};font-size:${columnHeaderSize}px;font-weight:700;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif;text-transform:uppercase}
      .rowlabel{fill:${rowLabelColor};font-size:${rowLabelSize}px;dominant-baseline:middle;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
      .gridline{stroke:${theme.gridColor};stroke-width:1}
      .gridline-minor{stroke:${theme.minorGridColor};stroke-width:.6}
      .divider{stroke:${theme.sheetBorder};stroke-width:1.2}
      .headerband{fill:${theme.headerBandColor}}
      .tick-major{stroke:${axis};stroke-width:1}
      .tick-minor{stroke:${axis};stroke-width:.4;opacity:.5}
      .bar{fill:${theme.barColor}}
      .barlabel{fill:${barLabelColor};font-size:${barLabelSize}px;font-weight:700;dominant-baseline:middle;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
      `;
    }

    function formatFooterText(template,ctx){
      if(!template) return '';
      return template
        .replace(/\{page\}/gi,String(ctx.pageNumber||''))
        .replace(/\{total\}/gi,String(ctx.totalPages||''))
        .replace(/\{date\}/gi,ctx.formattedDate||'')
        .replace(/\{label\}/gi,ctx.label||'');
    }

    // ---------- Parsing ----------
    function parseExport(text){
      text=text.replace(/^\"|\"$/g,'').replace(/\r/g,'');
      const lines=text.split('\n').map(x=>x.trim()).filter(Boolean);
      const headerIdx=lines.findIndex(l=>l.startsWith('Employee,'));
      if(headerIdx===-1) throw new Error('Header row starting with "Employee," not found.');
      const title=lines[0]||''; const sub=lines[1]||'';
      const header=lines[headerIdx].split(',');
      const dayHeaders=header.slice(1,8); // Sun..Sat
      const rows=[];
      for(let i=headerIdx+1;i<lines.length;i++){
        const parts=lines[i].split(',');
        if(parts.length<8) continue;
        const rawName=(parts[0]||'').trim();
        const name=cleanColleagueName(rawName);
        const days=parts.slice(1,8);
        rows.push({name,rawName,days});
      }
      return {title,sub,dayHeaders,rows};
    }

    function pickRange(cell,{fallbackSCH}){
      if(!cell) return null;
      // Prefer Whole Shift
      let m=cell.match(/Whole\s*Shift:\s*(\d{1,2}):(\d{1,2})\s*-\s*(\d{1,2}):(\d{1,2})/i);
      if(!m && fallbackSCH){
        m=cell.match(/SCH:\s*(\d{1,2}):(\d{1,2})\s*-\s*(\d{1,2}):(\d{1,2})/i);
      }
      if(!m) return null;
      let s=toMin(m[1],m[2]), e=toMin(m[3],m[4]);
      if(e<s) e+=1440; // overnight
      return {start:s,end:e};
    }

    function segmentsForRange(range,splitMidnight){
      if(!range) return [];
      const segments=[];
      let start=Math.max(0,Math.min(1440,range.start));
      let end=Math.max(0,range.end);
      if(splitMidnight && end>1440){
        segments.push({start,end:1440});
        let remaining=end-1440;
        while(remaining>0){
          const segEnd=Math.min(remaining,1440);
          if(segEnd>0) segments.push({start:0,end:segEnd});
          remaining-=1440;
        }
        return segments;
      }
      end=Math.min(end,1440);
      if(end<=start) return [];
      return [{start,end}];
    }

    function buildPerDay(model,opts){
      const dayCount=model.dayHeaders.length;
      const perDay=Array.from({length:dayCount},()=>[]);
      model.rows.forEach(row=>{
        const highlight=isNathanName(row.rawName||row.name);
        const daySegments=Array.from({length:dayCount},()=>[]);
        const dayRanges=Array.from({length:dayCount},()=>null);
        for(let dayIdx=0;dayIdx<dayCount;dayIdx++){
          const cell=row.days[dayIdx];
          const rng=pickRange(cell,opts);
          if(!rng) continue;
          if(!opts.splitMidnight){
            const segs=segmentsForRange(rng,false);
            if(!segs.length) continue;
            segs.forEach(seg=>{
              const start=Math.max(0,seg.start);
              const end=Math.max(0,seg.end);
              if(end<=start) return;
              daySegments[dayIdx].push({start,end});
            });
            if(daySegments[dayIdx].length){
              if(rng){
                dayRanges[dayIdx]={start:rng.start,end:Math.max(rng.end,rng.start)};
              }else{
                const starts=daySegments[dayIdx].map(s=>s.start);
                const ends=daySegments[dayIdx].map(s=>s.end);
                const merged={start:Math.min(...starts),end:Math.max(...ends)};
                dayRanges[dayIdx]=merged;
              }
            }
            continue;
          }
          const clampedStart=Math.max(0,Math.min(1440,rng.start));
          const startAbs=dayIdx*1440+clampedStart;
          const rawEnd=Math.max(rng.end,rng.start);
          const endAbs=dayIdx*1440+Math.max(rawEnd,clampedStart);
          if(!Number.isFinite(startAbs) || !Number.isFinite(endAbs) || endAbs<=startAbs) continue;
          for(let targetDay=dayIdx;targetDay<dayCount;targetDay++){
            const dayStart=targetDay*1440;
            const dayEnd=dayStart+1440;
            const segStartAbs=Math.max(startAbs,dayStart);
            const segEndAbs=Math.min(endAbs,dayEnd);
            if(segEndAbs>segStartAbs){
              const localStart=Math.max(0,Math.min(1440,segStartAbs-dayStart));
              const localEnd=Math.max(0,Math.min(1440,segEndAbs-dayStart));
              if(localEnd>localStart){
                daySegments[targetDay].push({start:localStart,end:localEnd});
                const existing=dayRanges[targetDay];
                if(existing){
                  existing.start=Math.min(existing.start,localStart);
                  existing.end=Math.max(existing.end,localEnd);
                }else{
                  dayRanges[targetDay]={start:localStart,end:localEnd};
                }
              }
            }
            if(segEndAbs>=endAbs || endAbs<=dayEnd) break;
          }
        }
        for(let dayIdx=0;dayIdx<dayCount;dayIdx++){
          const segs=daySegments[dayIdx];
          segs.sort((a,b)=>a.start-b.start);
          const range=dayRanges[dayIdx]?{...dayRanges[dayIdx]}:null;
          perDay[dayIdx].push({name:row.name, rawName:row.rawName, range, segments:segs.map(s=>({...s})), highlight});
        }
      });
      return perDay;
    }

    // ---------- Week storage ----------
    function storageAvailable(){
      try{
        if(typeof window==='undefined' || !window.localStorage) return false;
        const key='loggannt-storage-test';
        window.localStorage.setItem(key,'1');
        window.localStorage.removeItem(key);
        return true;
      }catch(err){
        console.warn('Local storage unavailable:',err);
        return false;
      }
    }

    const storageSupported=storageAvailable();

    function normalizeColorHex(value){
      if(typeof value!=='string') return null;
      const match=value.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
      if(!match) return null;
      let hex=match[1];
      if(hex.length===3){
        hex=hex.split('').map(ch=>ch+ch).join('');
      }
      return `#${hex.toLowerCase()}`;
    }

    function normalizeNameKey(value){
      if(typeof value!=='string') return '';
      return value.trim().toLowerCase();
    }

    function loadColorPreferences(){
      try{
        if(!storageSupported) return new Map();
        const raw=window.localStorage.getItem(STORAGE_COLOR_KEY);
        if(!raw) return new Map();
        const parsed=JSON.parse(raw);
        const map=new Map();
        if(parsed && typeof parsed==='object'){
          Object.entries(parsed).forEach(([key,val])=>{
            const normalized=normalizeColorHex(val);
            if(key && normalized){
              map.set(key,normalized);
            }
          });
        }
        return map;
      }catch(err){
        console.warn('Failed to read colour preferences:',err);
        return new Map();
      }
    }

    function persistColorPreferences(){
      if(!storageSupported) return;
      try{
        const payload={};
        colorPreferenceMap.forEach((value,key)=>{
          payload[key]=value;
        });
        window.localStorage.setItem(STORAGE_COLOR_KEY,JSON.stringify(payload));
      }catch(err){
        console.warn('Failed to store colour preferences:',err);
      }
    }

    const colorPreferenceMap=loadColorPreferences();

    function getColorPreferenceByKey(key){
      if(!key) return null;
      return colorPreferenceMap.get(key)||null;
    }

    function buildColorLookupKeys(entry){
      const keys=[];
      if(!entry) return keys;
      const raw=normalizeNameKey(entry.rawName||'');
      if(raw) keys.push(`raw:${raw}`);
      const clean=normalizeNameKey(entry.name||'');
      if(clean) keys.push(`clean:${clean}`);
      return keys;
    }

    function getStoredColorForEntry(entry){
      const keys=buildColorLookupKeys(entry);
      for(const key of keys){
        const value=getColorPreferenceByKey(key);
        if(value) return value;
      }
      return null;
    }

    function getCustomColorForEntry(entry){
      if(entry && entry.highlight) return null;
      return getStoredColorForEntry(entry);
    }

    let defaultPickerColor=null;
    function getDefaultPickerColor(){
      if(defaultPickerColor) return defaultPickerColor;
      try{
        const computed=getComputedStyle(document.documentElement);
        const accent=normalizeColorHex(computed.getPropertyValue('--accent')||'');
        if(accent){
          defaultPickerColor=accent;
          return defaultPickerColor;
        }
      }catch(err){
        console.warn('Failed to resolve accent colour:',err);
      }
      defaultPickerColor=normalizeColorHex(DEFAULT_LAYOUT.barColor)||'#4b4b4b';
      return defaultPickerColor;
    }

    function refreshReportsForColorChange(){
      const weeks=getActiveWeekData();
      renderScheduleView(weeks);
      renderLineView(weeks);
      renderPdfPreview(weeks);
    }

    function handleColorPreferenceChange(key,color){
      if(!key) return;
      const normalized=normalizeColorHex(color);
      if(normalized){
        colorPreferenceMap.set(key,normalized);
      }else{
        colorPreferenceMap.delete(key);
      }
      persistColorPreferences();
      refreshReportsForColorChange();
    }

    function isHomeTipDismissed(){
      if(!storageSupported) return false;
      try{
        return window.localStorage.getItem(STORAGE_HOME_TIP_KEY)==='1';
      }catch(err){
        console.warn('Failed to read quick-tip preference:',err);
        return false;
      }
    }

    function setHomeTipDismissed(state){
      if(!storageSupported) return;
      try{
        if(state){
          window.localStorage.setItem(STORAGE_HOME_TIP_KEY,'1');
        }else{
          window.localStorage.removeItem(STORAGE_HOME_TIP_KEY);
        }
      }catch(err){
        console.warn('Failed to store quick-tip preference:',err);
      }
    }

    function loadSavedWeekRecords(){
      if(!storageSupported) return [];
      try{
        const raw=window.localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        const parsed=JSON.parse(raw);
        if(!Array.isArray(parsed)) return [];
        return parsed.map(entry=>{
          const model=cloneStoredModel(entry && entry.model);
          const meta=deriveWeekMetadata(model);
          const storedAt=Number.isFinite(entry && entry.storedAt)?Number(entry.storedAt):Date.now();
          const id=entry && typeof entry.id==='string'?entry.id:meta.id;
          if(meta.id!==id) meta.id=id;
          return {id,storedAt,metadata:meta,model};
        }).filter(record=>record && record.id && record.model);
      }catch(err){
        console.warn('Failed to read stored weeks:',err);
        return [];
      }
    }

    function persistSavedWeekRecords(records){
      if(!storageSupported) return;
      try{
        const payload=records.map(record=>({
          id:record.id,
          storedAt:record.storedAt,
          metadata:record.metadata,
          model:sanitizeModelForStorage(record.model),
        }));
        window.localStorage.setItem(STORAGE_KEY,JSON.stringify(payload));
      }catch(err){
        console.warn('Failed to persist weeks:',err);
      }
    }

    function loadSavedSelection(){
      if(!storageSupported) return [];
      try{
        const raw=window.localStorage.getItem(STORAGE_SELECTION_KEY);
        if(!raw) return [];
        const parsed=JSON.parse(raw);
        if(!Array.isArray(parsed)) return [];
        return parsed.filter(id=>typeof id==='string');
      }catch(err){
        console.warn('Failed to read week selection:',err);
        return [];
      }
    }

    function persistActiveSelection(ids){
      if(!storageSupported) return;
      try{
        window.localStorage.setItem(STORAGE_SELECTION_KEY,JSON.stringify(ids));
      }catch(err){
        console.warn('Failed to store selection:',err);
      }
    }

    function compareWeekRecords(a,b){
      const aDate=a && a.metadata && typeof a.metadata.startIso==='string'?a.metadata.startIso:'';
      const bDate=b && b.metadata && typeof b.metadata.startIso==='string'?b.metadata.startIso:'';
      if(aDate && bDate && aDate!==bDate){
        return aDate>bDate?-1:1;
      }
      const aStored=Number.isFinite(a && a.storedAt)?a.storedAt:0;
      const bStored=Number.isFinite(b && b.storedAt)?b.storedAt:0;
      return bStored-aStored;
    }

    function trimWeekRecords(records){
      const list=records.slice().sort(compareWeekRecords);
      while(list.length>MAX_STORED_WEEKS){
        list.pop();
      }
      return list;
    }

    let savedWeekRecords=trimWeekRecords(loadSavedWeekRecords());
    const cachedWeeks=new Map();
    let activeWeekIds=loadSavedSelection();
    let settingsDrawerOpen=false;

    function hydrateWeekRecord(record){
      if(!record || !record.model) return null;
      const model=cloneStoredModel(record.model);
      const metadata=deriveWeekMetadata(model);
      const mergedMeta={...metadata};
      const storedAt=Number.isFinite(record.storedAt)?record.storedAt:Date.now();
      const perDay=buildPerDay(model,{fallbackSCH:true,splitMidnight:true});
      return {id:metadata.id,storedAt,metadata:mergedMeta,model,perDay};
    }

    function rebuildWeekCache(){
      cachedWeeks.clear();
      savedWeekRecords=trimWeekRecords(savedWeekRecords);
      savedWeekRecords.forEach(record=>{
        const hydrated=hydrateWeekRecord(record);
        if(!hydrated) return;
        record.id=hydrated.id;
        record.metadata=hydrated.metadata;
        record.storedAt=hydrated.storedAt;
        record.model=sanitizeModelForStorage(record.model);
        cachedWeeks.set(hydrated.id,hydrated);
      });
      savedWeekRecords=trimWeekRecords(savedWeekRecords);
      persistSavedWeekRecords(savedWeekRecords);
    }

    rebuildWeekCache();

    function getSortedWeekRecords(){
      return savedWeekRecords.slice().sort(compareWeekRecords);
    }

    function getActiveWeekData(){
      return activeWeekIds.slice(0,1).map(id=>cachedWeeks.get(id)).filter(Boolean);
    }

    function setActiveWeeks(ids,{persist=true}={}){
      const unique=[];
      ids.forEach(id=>{
        if(typeof id!=='string') return;
        if(!cachedWeeks.has(id)) return;
        if(!unique.includes(id)) unique.push(id);
      });
      if(unique.length>1){
        unique.splice(1);
      }
      activeWeekIds=unique;
      if(persist) persistActiveSelection(activeWeekIds);
    }

    function recordCoversIsoDate(record,iso){
      if(!record || !record.metadata || !iso) return false;
      const {startIso,endIso}=record.metadata;
      const isIso=value=>typeof value==='string' && /^\d{4}-\d{2}-\d{2}$/.test(value);
      const hasStart=isIso(startIso);
      const hasEnd=isIso(endIso);
      if(hasStart && hasEnd){
        return startIso<=iso && iso<=endIso;
      }
      if(hasStart){
        return startIso<=iso;
      }
      if(hasEnd){
        return iso<=endIso;
      }
      return false;
    }

    function ensureActiveWeeks(){
      const available=getSortedWeekRecords();
      if(!available.length){
        activeWeekIds=[];
        persistActiveSelection(activeWeekIds);
        return;
      }
      const valid=activeWeekIds.filter(id=>cachedWeeks.has(id));
      if(valid.length){
        activeWeekIds=valid.slice(0,1);
        persistActiveSelection(activeWeekIds);
        return;
      }
      const todayIso=new Date().toISOString().slice(0,10);
      const preferred=available.find(record=>recordCoversIsoDate(record,todayIso));
      const target=preferred||available[0]||null;
      activeWeekIds=target?[target.id]:[];
      persistActiveSelection(activeWeekIds);
    }

    ensureActiveWeeks();

    if(!getSortedWeekRecords().length){
      settingsDrawerOpen=true;
    }

    function formatWeekMeta(record){
      if(!record) return '';
      if(record.metadata && record.metadata.displayRange){
        return record.metadata.displayRange;
      }
      const savedDate=new Date(record.storedAt);
      if(!Number.isNaN(savedDate.getTime())){
        return `Saved ${savedDate.toLocaleDateString()}`;
      }
      return '';
    }

    function syncSettingsPanel(){
      const toggle=document.getElementById('btnToggleSettings');
      const panel=document.getElementById('savedWeeksPanel');
      const visible=settingsDrawerOpen;
      if(toggle){
        toggle.disabled=false;
        toggle.setAttribute('aria-expanded',visible?'true':'false');
        toggle.setAttribute('aria-label',visible?'Hide settings panel':'Show settings panel');
      }
      if(panel){
        panel.hidden=!visible;
        panel.setAttribute('aria-hidden',visible?'false':'true');
      }
    }

    function updateWeekSelectionUI(){
      const select=document.getElementById('savedWeekSelect');
      const meta=document.getElementById('savedWeekMeta');
      const clearBtn=document.getElementById('btnClearWeeks');
      const forgetBtn=document.getElementById('btnForgetWeek');
      const records=getSortedWeekRecords();
      const hasRecords=records.length>0;
      if(clearBtn){
        clearBtn.disabled=!hasRecords;
      }
      if(forgetBtn){
        forgetBtn.disabled=!hasRecords;
      }
      if(select){
        select.innerHTML='';
        if(hasRecords){
          records.forEach(record=>{
            const option=document.createElement('option');
            option.value=record.id;
            option.textContent=record.metadata && record.metadata.label?record.metadata.label:'Saved rota';
            select.appendChild(option);
          });
          let activeId=activeWeekIds[0];
          if(!activeId || !records.some(record=>record.id===activeId)){
            activeId=records[0].id;
            setActiveWeeks([activeId],{persist:true});
          }
          select.disabled=false;
          select.value=activeId;
        }else{
          select.disabled=true;
          select.value='';
          setActiveWeeks([],{persist:true});
        }
      }
      if(meta){
        const activeId=activeWeekIds[0];
        const record=records.find(item=>item.id===activeId);
        const text=record?formatWeekMeta(record):'';
        meta.textContent=text;
        meta.hidden=!text;
      }
      syncSettingsPanel();
    }

    function removeWeekRecord(id){
      const index=savedWeekRecords.findIndex(record=>record.id===id);
      if(index===-1) return;
      savedWeekRecords.splice(index,1);
      rebuildWeekCache();
      const remaining=activeWeekIds.filter(item=>item!==id);
      setActiveWeeks(remaining,{persist:true});
      ensureActiveWeeks();
      updateWeekSelectionUI();
      renderViews();
    }

    function clearAllWeeks(){
      savedWeekRecords=[];
      rebuildWeekCache();
      activeWeekIds=[];
      persistActiveSelection(activeWeekIds);
      settingsDrawerOpen=false;
      updateWeekSelectionUI();
      renderViews();
    }

    // ---------- Layout & Draw ----------
    function drawDayCard(container,label,rows,ctx={}){
      const layout=ctx.layout || currentLayout || DEFAULT_LAYOUT;
      const P=Math.max(0,layout.padding);
      const W=Math.max(400,layout.chartWidth);
      const rowH=Math.max(18,layout.rowHeight);
      const leftAxis=Math.max(120,layout.nameColumnWidth);
      const innerW=Math.max(100,W-leftAxis-P*2);
      const headerHeight=Math.max(24,layout.headerHeight);
      const showEmptyRows=!!ctx.showEmptyRows;
      const placeholderLabel=(ctx.placeholderLabel||'No scheduled colleagues');
      const sourceRows=Array.isArray(rows)?rows.filter(Boolean):[];
      const visibleRows=showEmptyRows?sourceRows:sourceRows.filter(r=>r && r.range);
      const bodyRows=visibleRows.length?visibleRows:[{name:placeholderLabel,range:null,segments:[],highlight:false}];
      const bodyHeight=rowH*bodyRows.length;
      const H=P+headerHeight+bodyHeight+P;
      const svgNS='http://www.w3.org/2000/svg';
      const svg=document.createElementNS(svgNS,'svg');
      svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
      svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
      svg.setAttribute('font-family','Arial, "Helvetica Neue", Helvetica, sans-serif');

      const style=document.createElementNS(svgNS,'style');
      style.textContent=buildSvgStyleBlock(layout);
      svg.appendChild(style);

      const bg=document.createElementNS(svgNS,'rect');
      bg.setAttribute('x',0);bg.setAttribute('y',0);bg.setAttribute('width',W);bg.setAttribute('height',H);bg.setAttribute('fill',layout.sheetBackground);
      svg.appendChild(bg);

      const border=document.createElementNS(svgNS,'rect');
      border.setAttribute('x',0);border.setAttribute('y',0);border.setAttribute('width',W);border.setAttribute('height',H);
      border.setAttribute('fill','none');border.setAttribute('stroke',layout.sheetBorder);border.setAttribute('stroke-width','1');
      svg.appendChild(border);

      const headerBand=document.createElementNS(svgNS,'rect');
      headerBand.setAttribute('x',P);headerBand.setAttribute('y',P);
      headerBand.setAttribute('width',W-P*2);headerBand.setAttribute('height',headerHeight);
      headerBand.setAttribute('class','headerband');
      svg.appendChild(headerBand);

      const columnDivider=document.createElementNS(svgNS,'line');
      columnDivider.setAttribute('x1',P+leftAxis);
      columnDivider.setAttribute('y1',P);
      columnDivider.setAttribute('x2',P+leftAxis);
      columnDivider.setAttribute('y2',H-P);
      columnDivider.setAttribute('class','divider');
      svg.appendChild(columnDivider);

      const headerLine=document.createElementNS(svgNS,'line');
      headerLine.setAttribute('x1',P);headerLine.setAttribute('y1',P+headerHeight);
      headerLine.setAttribute('x2',W-P);headerLine.setAttribute('y2',P+headerHeight);
      headerLine.setAttribute('class','divider');
      svg.appendChild(headerLine);

      const headerTop=P;
      const headerBottom=P+headerHeight;
      const bodyTop=headerBottom;
      const headerTextBaseline=headerTop+18;
      const axisBaseline=headerBottom-6;
      const axisLabelOffset=6;

      const columnLabel=ctx && ctx.columnHeaderLabel?String(ctx.columnHeaderLabel):'Colleague Names';
      const nameHeader=document.createElementNS(svgNS,'text');
      nameHeader.setAttribute('x',P+6);nameHeader.setAttribute('y',headerTextBaseline);
      nameHeader.setAttribute('class','colheader');
      nameHeader.textContent=columnLabel;
      svg.appendChild(nameHeader);

      const toX=m=>P+leftAxis+(m/1440)*innerW;
      for(let minute=0;minute<=1440;minute+=15){
        const x=toX(minute);
        const isHour=minute%60===0;

        if(isHour && minute>0 && minute<1440){
          const headerLine=document.createElementNS(svgNS,'line');
          headerLine.setAttribute('x1',x);
          headerLine.setAttribute('y1',headerTop);
          headerLine.setAttribute('x2',x);
          headerLine.setAttribute('y2',headerBottom);
          headerLine.setAttribute('class','gridline');
          svg.appendChild(headerLine);
        }

        if(minute>0 && minute<1440){
          const vline=document.createElementNS(svgNS,'line');
          vline.setAttribute('x1',x);
          vline.setAttribute('y1',bodyTop);
          vline.setAttribute('x2',x);
          vline.setAttribute('y2',H-P);
          vline.setAttribute('class',isHour?'gridline':'gridline-minor');
          svg.appendChild(vline);
        }

        if(isHour && minute<1440){
          const axisText=document.createElementNS(svgNS,'text');
          axisText.setAttribute('x',x+axisLabelOffset);
          axisText.setAttribute('y',axisBaseline);
          axisText.setAttribute('text-anchor','start');
          axisText.setAttribute('class','axislabel');
          axisText.textContent=fmtHMDisplay(minute);
          svg.appendChild(axisText);
        }
      }

      bodyRows.forEach((row,idx)=>{
        const y=bodyTop+idx*rowH;
        if(idx>0){
          const baseline=document.createElementNS(svgNS,'line');
          baseline.setAttribute('x1',P);
          baseline.setAttribute('y1',y);
          baseline.setAttribute('x2',W-P);
          baseline.setAttribute('y2',y);
          baseline.setAttribute('class','gridline');
          svg.appendChild(baseline);
        }

        const name=document.createElementNS(svgNS,'text');
        name.setAttribute('x',P+6);
        name.setAttribute('y',y+rowH/2);
        name.setAttribute('class','rowlabel');
        name.textContent=row.name;
        svg.appendChild(name);

        if(row.range){
          const labelText=`${fmtHMDisplay(row.range.start)} - ${fmtHMDisplay(row.range.end)}`;
          const storedColor=row.highlight?null:getCustomColorForEntry(row);
          const barFill=row.highlight?SPECIAL_NAME_COLOR:(storedColor||layout.barColor||DEFAULT_LAYOUT.barColor);
          row.segments.forEach((seg,segIdx)=>{
            const segY=y+4;
            const segHeight=rowH-8;
            const rect=document.createElementNS(svgNS,'rect');
            rect.setAttribute('x',toX(seg.start));
            rect.setAttribute('y',segY);
            rect.setAttribute('width',Math.max(2,toX(seg.end)-toX(seg.start)));
            rect.setAttribute('height',segHeight);
            rect.setAttribute('class','bar');
            rect.setAttribute('fill',barFill);
            svg.appendChild(rect);

            if(segIdx===0){
              const label=document.createElementNS(svgNS,'text');
              label.setAttribute('x',toX(seg.start)+4);
              label.setAttribute('y',segY+segHeight/2+1);
              label.setAttribute('class','barlabel');
              label.textContent=labelText;
              svg.appendChild(label);
            }
          });
        }
      });

      const finalLine=document.createElementNS(svgNS,'line');
      finalLine.setAttribute('x1',P);
      finalLine.setAttribute('y1',bodyTop+bodyRows.length*rowH);
      finalLine.setAttribute('x2',W-P);
      finalLine.setAttribute('y2',bodyTop+bodyRows.length*rowH);
      finalLine.setAttribute('class','divider');
      svg.appendChild(finalLine);

      const section=document.createElement('section');
      section.className='sheet';

      const header=document.createElement('header');
      header.className='sheet-header';

      const titleEl=document.createElement('div');
      titleEl.className='sheet-title';
      titleEl.textContent=layout.title || DEFAULT_LAYOUT.title;
      header.appendChild(titleEl);

      const rangeLabel=(ctx.dateRangeLabel || '').trim();
      if(rangeLabel){
        const rangeEl=document.createElement('div');
        rangeEl.className='sheet-range';
        rangeEl.textContent=rangeLabel;
        header.appendChild(rangeEl);
      }

      const codeEl=document.createElement('div');
      codeEl.className='sheet-code';
      const resolvedCode=(ctx.staticCode || layout.staticCode || STATIC_CODE).trim();
      codeEl.textContent=resolvedCode;
      header.appendChild(codeEl);

      const dateEl=document.createElement('div');
      dateEl.className='sheet-date';
      dateEl.textContent=ctx.formattedDate || formatFullDayLabel(label);
      header.appendChild(dateEl);

      section.appendChild(header);
      section.appendChild(svg);

      if(layout.footerNote){
        const note=document.createElement('div');
        note.className='sheet-footnote';
        note.textContent=layout.footerNote;
        section.appendChild(note);
      }

      const footerText=formatFooterText(layout.footerTemplate,{pageNumber:ctx.pageNumber,totalPages:ctx.totalPages,formattedDate:ctx.formattedDate,label:label});
      if(footerText){
        const footer=document.createElement('div');
        footer.className='sheet-footer';
        footer.textContent=footerText;
        section.appendChild(footer);
      }

      container.appendChild(section);
      return {section, svg};
    }

    // ---------- Render / Export ----------
    let lastIndividuals=[];
    let currentIndividualSelection=[];

    const LINE_VIEW_DEFAULT_STATE={dayIndex:0,startMinute:8*60,windowMinutes:12*60};
    const LINE_VIEW_MIN_WINDOW=60;
    const LINE_VIEW_MAX_WINDOW=1440;
    const LINE_VIEW_STEP=15;

    let lineViewState={...LINE_VIEW_DEFAULT_STATE};
    let lineViewStateInitialized=false;
    let lineViewLastWeekId=null;
    let lineViewLastDayIndex=null;
    let lineViewCurrentEntries=[];
    let lineViewCurrentLookup=new Map();
    let lineViewCurrentDayLabel='';
    let lineViewBaseMinutesPerPixel=null;
    let lineViewUserSelectedDay=false;

    function setCurrentIndividualSelection(indices,{suppressLineReset=false,maxIndex}={}){
      const limit=Number.isInteger(maxIndex)?Math.max(0,maxIndex):Infinity;
      const normalized=[];
      const seen=new Set();
      (Array.isArray(indices)?indices:[]).forEach(idx=>{
        if(!Number.isInteger(idx)) return;
        if(idx<0) return;
        if(idx>=limit) return;
        if(seen.has(idx)) return;
        seen.add(idx);
        normalized.push(idx);
      });
      normalized.sort((a,b)=>a-b);
      const changed=normalized.length!==currentIndividualSelection.length || normalized.some((val,idx)=>currentIndividualSelection[idx]!==val);
      if(changed){
        currentIndividualSelection=normalized;
        if(!suppressLineReset){
          lineViewStateInitialized=false;
          lineViewBaseMinutesPerPixel=null;
        }
      }
      return changed;
    }

    function getSelectionRecords(model){
      if(!model || !Array.isArray(model.rows)) return [];
      const indices=currentIndividualSelection.filter(idx=>Number.isInteger(idx) && idx>=0 && idx<model.rows.length);
      if(indices.length!==currentIndividualSelection.length){
        setCurrentIndividualSelection(indices);
      }
      return indices.map(index=>({
        index,
        row:model.rows[index],
        record:lastIndividuals.find(rec=>rec.index===index) || null,
      }));
    }

    function getSelectedRows(model){
      return getSelectionRecords(model).map(item=>item.row);
    }

    const lineViewContainer=document.getElementById('lineView');
    const lineControls=document.getElementById('lineControls');
    const lineDaySelect=document.getElementById('lineDaySelect');
    const lineWindowHint=document.getElementById('lineWindowHint');
    const lineWindowHintDefault=lineWindowHint?lineWindowHint.textContent.trim():'';
    const lineDaySummary=document.getElementById('lineDaySummary');
    const lineChartShell=document.getElementById('lineChartShell');
    const lineChartAxis=document.getElementById('lineChartAxis');
    const lineChartRows=document.getElementById('lineChartRows');
    const lineViewEmpty=document.getElementById('lineViewEmpty');
    const linePresetButtons=document.getElementById('linePresetButtons');
    const linePresetButtonList=linePresetButtons?Array.from(linePresetButtons.querySelectorAll('button[data-start][data-end]')):[];
    const lineIndividualWeek=document.getElementById('lineIndividualWeek');
    const selectionActions=document.getElementById('selectionActions');
    const btnClearSelection=document.getElementById('btnClearSelection');
    const btnManagementShortcut=document.getElementById('btnManagementShortcut');
    const appearanceControls=document.getElementById('appearanceControls');

    if(Array.isArray(linePresetButtonList) && linePresetButtonList.length){
      linePresetButtonList.forEach(btn=>{
        if(!btn) return;
        btn.addEventListener('click',()=>{
          const start=parseFloat(btn.dataset.start);
          const end=parseFloat(btn.dataset.end);
          if(Number.isFinite(start) && Number.isFinite(end) && end>start){
            applyLineViewPresetRange(start,end);
          }
        });
      });
    }

    function buildDisplayNameLookup(model){
      const map=new Map();
      if(!model || !Array.isArray(model.rows)) return map;
      model.rows.forEach((row,idx)=>{
        const display=getRowDisplayName(row,idx+1);
        if(row.rawName) map.set(`raw:${row.rawName}`,display);
        if(row.name) map.set(`clean:${row.name}`,display);
      });
      return map;
    }

    function resolveEntryDisplayName(entry,lookup){
      if(!entry) return 'Colleague';
      if(entry.rawName){
        const rawMatch=lookup.get(`raw:${entry.rawName}`);
        if(rawMatch) return rawMatch;
      }
      if(entry.name){
        const cleanMatch=lookup.get(`clean:${entry.name}`);
        if(cleanMatch) return cleanMatch;
      }
      return entry.name || 'Colleague';
    }

    function entryMatchesSelection(entry,person){
      if(!entry || !person) return false;
      if(person.rawName && entry.rawName && entry.rawName===person.rawName) return true;
      if(person.name && entry.name && entry.name===person.name) return true;
      return false;
    }

    function filterEntriesBySelection(entries,selectedRows){
      const list=Array.isArray(entries)?entries.filter(Boolean):[];
      if(!Array.isArray(selectedRows) || !selectedRows.length) return list;
      return list.filter(entry=>selectedRows.some(person=>entryMatchesSelection(entry,person)));
    }

    function filterPerDayEntries(perDay,selectedRows){
      if(!Array.isArray(perDay)) return [];
      if(!Array.isArray(selectedRows) || !selectedRows.length) return perDay;
      return perDay.map(entries=>filterEntriesBySelection(entries,selectedRows));
    }

    function resolveDateRangeLabelForWeek(model,metadata,layout){
      if(layout && typeof layout.subtitleOverride==='string' && layout.subtitleOverride.trim()){
        return layout.subtitleOverride.trim();
      }
      const auto=buildDateRangeLabel(model);
      if(auto) return auto;
      if(metadata && metadata.displayRange) return metadata.displayRange;
      return '';
    }

    function clampLineViewWindow(value){
      if(!Number.isFinite(value)) return LINE_VIEW_DEFAULT_STATE.windowMinutes;
      const clamped=Math.max(LINE_VIEW_MIN_WINDOW,Math.min(LINE_VIEW_MAX_WINDOW,value));
      const snapped=Math.round(clamped/LINE_VIEW_STEP)*LINE_VIEW_STEP;
      return Math.max(LINE_VIEW_MIN_WINDOW,Math.min(LINE_VIEW_MAX_WINDOW,snapped));
    }

    function clampLineViewStart(value,windowMinutes){
      if(!Number.isFinite(value)) value=0;
      const snapped=Math.round(value/LINE_VIEW_STEP)*LINE_VIEW_STEP;
      const maxStart=Math.max(0,1440-windowMinutes);
      return Math.max(0,Math.min(maxStart,snapped));
    }

    function applyLineViewPresetRange(startMinute,endMinute){
      if(!Number.isFinite(startMinute) || !Number.isFinite(endMinute)) return;
      const clampedStart=Math.max(0,Math.min(1440,startMinute));
      const clampedEnd=Math.max(0,Math.min(1440,endMinute));
      if(clampedEnd<=clampedStart) return;
      const span=clampedEnd-clampedStart;
      const windowMinutes=clampLineViewWindow(span);
      const start=clampLineViewStart(clampedStart,windowMinutes);
      const windowChanged=Math.abs(lineViewState.windowMinutes-windowMinutes)>=0.5;
      const startChanged=Math.abs(lineViewState.startMinute-start)>=0.5;
      if(!windowChanged && !startChanged) return;
      lineViewState.windowMinutes=windowMinutes;
      lineViewState.startMinute=start;
      lineViewBaseMinutesPerPixel=null;
      drawCurrentLineChart();
    }

    function updateLinePresetActiveState(){
      if(!Array.isArray(linePresetButtonList) || !linePresetButtonList.length) return;
      linePresetButtonList.forEach(btn=>{
        if(!btn) return;
        if(btn.disabled){
          btn.classList.remove('active');
          return;
        }
        const start=parseFloat(btn.dataset.start);
        const end=parseFloat(btn.dataset.end);
        if(Number.isFinite(start) && Number.isFinite(end) && end>start){
          const window=end-start;
          const matches=Math.abs(lineViewState.startMinute-start)<=1 && Math.abs(lineViewState.windowMinutes-window)<=1;
          if(matches){
            btn.classList.add('active');
          }else{
            btn.classList.remove('active');
          }
        }else{
          btn.classList.remove('active');
        }
      });
    }

    function syncLinePresetButtons(hasData){
      if(!linePresetButtons) return;
      const show=!!hasData;
      linePresetButtons.hidden=!show;
      linePresetButtons.setAttribute('aria-hidden',show?'false':'true');
      if(!Array.isArray(linePresetButtonList)) return;
      linePresetButtonList.forEach(btn=>{
        if(!btn) return;
        btn.disabled=!show;
        if(!show){
          btn.classList.remove('active');
        }
      });
      if(show){
        updateLinePresetActiveState();
      }
    }

    function computeLineViewDefaults(entries){
      const defaults={startMinute:LINE_VIEW_DEFAULT_STATE.startMinute,windowMinutes:LINE_VIEW_DEFAULT_STATE.windowMinutes};
      if(!Array.isArray(entries) || !entries.length) return defaults;
      const segments=[];
      entries.forEach(entry=>{
        if(entry && Array.isArray(entry.segments)){
          entry.segments.forEach(seg=>{
            if(!seg) return;
            if(Number.isFinite(seg.start) && Number.isFinite(seg.end) && seg.end>seg.start){
              const start=Math.max(0,Math.min(1440,seg.start));
              const end=Math.max(0,Math.min(1440,seg.end));
              if(end>start) segments.push({start,end});
            }
          });
        }else if(entry && entry.range && Number.isFinite(entry.range.start) && Number.isFinite(entry.range.end)){
          const start=Math.max(0,Math.min(1440,entry.range.start));
          const end=Math.max(0,Math.min(1440,entry.range.end));
          if(end>start) segments.push({start,end});
        }
      });
      if(!segments.length) return defaults;
      const earliest=Math.min(...segments.map(seg=>seg.start));
      const latest=Math.max(...segments.map(seg=>seg.end));
      const padding=60;
      const proposedStart=Math.max(0,earliest-padding);
      const proposedEnd=Math.min(1440,latest+padding);
      let windowMinutes=proposedEnd-proposedStart;
      if(windowMinutes<LINE_VIEW_MIN_WINDOW) windowMinutes=LINE_VIEW_MIN_WINDOW;
      if(windowMinutes>LINE_VIEW_MAX_WINDOW) windowMinutes=LINE_VIEW_MAX_WINDOW;
      windowMinutes=clampLineViewWindow(windowMinutes);
      const startMinute=clampLineViewStart(proposedStart,windowMinutes);
      return {startMinute,windowMinutes};
    }

    function chooseLineTickSpacing(windowMinutes){
      if(windowMinutes<=180) return {major:60,minor:15};
      if(windowMinutes<=360) return {major:120,minor:30};
      if(windowMinutes<=720) return {major:180,minor:60};
      return {major:240,minor:120};
    }

    function buildLineViewTicks(startMinute,windowMinutes){
      const ticks=[];
      if(!Number.isFinite(startMinute) || !Number.isFinite(windowMinutes) || windowMinutes<=0) return ticks;
      const endMinute=startMinute+windowMinutes;
      const {major,minor}=chooseLineTickSpacing(windowMinutes);
      const minorStep=Math.max(5,minor);
      const majorStep=Math.max(minorStep,major);
      const first=Math.floor(startMinute/minorStep)*minorStep;
      for(let minute=first;minute<=endMinute+minorStep;minute+=minorStep){
        const percent=((minute-startMinute)/windowMinutes)*100;
        if(percent<-5 || percent>105) continue;
        const normalized=((minute%majorStep)+majorStep)%majorStep;
        const isMajor=normalized===0;
        ticks.push({minute,percent,isMajor});
      }
      [startMinute,endMinute].forEach(minute=>{
        const percent=((minute-startMinute)/windowMinutes)*100;
        const existing=ticks.find(t=>Math.abs(t.percent-percent)<0.01);
        if(!existing){
          ticks.push({minute,percent,isMajor:true});
        }
      });
      ticks.sort((a,b)=>a.minute-b.minute);
      return ticks.filter(t=>t.percent>=-0.1 && t.percent<=100.1);
    }

    function measureLineTrackWidth(){
      if(!lineChartShell) return null;
      if(lineChartRows){
        const track=lineChartRows.querySelector('.line-row-track');
        if(track){
          const rect=track.getBoundingClientRect();
          if(rect && rect.width>0) return rect.width;
        }
      }
      const styles=getComputedStyle(lineChartShell);
      const paddingLeft=parseFloat(styles.paddingLeft)||0;
      const paddingRight=parseFloat(styles.paddingRight)||0;
      const width=lineChartShell.clientWidth-paddingLeft-paddingRight;
      return width>0?width:null;
    }

    function updateLineViewResponsiveWindow(){
      const width=measureLineTrackWidth();
      if(!width || width<=0) return false;
      if(!Number.isFinite(lineViewBaseMinutesPerPixel) || lineViewBaseMinutesPerPixel<=0){
        lineViewBaseMinutesPerPixel=lineViewState.windowMinutes/width;
      }
      const desired=Math.max(width*lineViewBaseMinutesPerPixel,LINE_VIEW_MIN_WINDOW);
      const windowMinutes=clampLineViewWindow(desired);
      const changed=Math.abs(windowMinutes-lineViewState.windowMinutes)>=0.5;
      if(changed){
        lineViewState.windowMinutes=windowMinutes;
        lineViewState.startMinute=clampLineViewStart(lineViewState.startMinute,windowMinutes);
      }
      return changed;
    }

    function syncLineViewControls(dayLabels){
      const hasData=Array.isArray(dayLabels) && dayLabels.length>0;
      if(lineControls){
        lineControls.hidden=!hasData;
        lineControls.setAttribute('aria-hidden',hasData?'false':'true');
      }
      if(lineViewEmpty){
        lineViewEmpty.hidden=hasData;
      }
      syncLinePresetButtons(hasData);
      if(!hasData){
        if(lineChartShell){
          lineChartShell.hidden=true;
          lineChartShell.setAttribute('aria-hidden','true');
        }
        if(lineDaySummary){
          lineDaySummary.hidden=true;
        }
        if(lineWindowHint){
          lineWindowHint.textContent=lineWindowHintDefault;
        }
        return;
      }
      if(lineDaySelect){
        const options=dayLabels.map((label,idx)=>`<option value="${idx}">${formatShortDayLabel(label)||`Day ${idx+1}`}</option>`);
        lineDaySelect.innerHTML=options.join('');
        lineDaySelect.disabled=dayLabels.length<=1;
        const desired=Math.min(Math.max(lineViewState.dayIndex||0,0),dayLabels.length-1);
        lineViewState.dayIndex=desired;
        lineDaySelect.value=String(desired);
      }
      if(lineDaySummary){
        const label=dayLabels[lineViewState.dayIndex]||`Day ${lineViewState.dayIndex+1}`;
        lineDaySummary.textContent=formatFullDayLabel(label)||label;
        lineDaySummary.hidden=false;
      }
      if(lineChartShell){
        lineChartShell.hidden=false;
        lineChartShell.setAttribute('aria-hidden','false');
      }
    }

    function buildRowSortKey(entry){
      if(!entry) return Number.POSITIVE_INFINITY;
      if(entry.range && Number.isFinite(entry.range.start)) return entry.range.start;
      if(Array.isArray(entry.segments) && entry.segments.length){
        const starts=entry.segments.map(seg=>Number.isFinite(seg.start)?seg.start:Number.POSITIVE_INFINITY);
        return Math.min(...starts);
      }
      return Number.POSITIVE_INFINITY;
    }

    function rectsOverlap(a,b){
      return !!(a && b && a.left<b.right && a.right>b.left && a.top<b.bottom && a.bottom>b.top);
    }

    function drawLineChart(entries,dayLabel){
      if(!lineChartAxis || !lineChartRows){
        return;
      }
      const start=lineViewState.startMinute;
      const window=lineViewState.windowMinutes;
      const end=start+window;
      const ticks=buildLineViewTicks(start,window);
      lineChartAxis.innerHTML='';
      const axisTicks=ticks.filter(t=>t.isMajor && t.percent>=0 && t.percent<=100);
      axisTicks.forEach(tick=>{
        const tickEl=document.createElement('div');
        tickEl.className='line-axis-tick';
        tickEl.style.left=`${tick.percent}%`;
        const label=document.createElement('span');
        label.className='line-axis-label';
        label.textContent=fmtHMDisplay(tick.minute);
        tickEl.appendChild(label);
        lineChartAxis.appendChild(tickEl);
      });
      lineChartRows.innerHTML='';
      const barsNeedingAdjustment=[];
      if(!Array.isArray(entries) || !entries.length){
        updateLinePresetActiveState();
        const empty=document.createElement('div');
        empty.className='line-chart-empty';
        empty.textContent='No scheduled shifts for this day.';
        lineChartRows.appendChild(empty);
        return;
      }
      const sortedEntries=[...entries];
      sortedEntries.sort((a,b)=>buildRowSortKey(a)-buildRowSortKey(b));
      const filteredEntries=[];
      let hiddenCount=0;
      let totalRenderable=0;
      sortedEntries.forEach(entry=>{
        if(!entry) return;
        const baseSegments=Array.isArray(entry.segments)?entry.segments.slice():[];
        if(!baseSegments.length && entry.range && Number.isFinite(entry.range.start) && Number.isFinite(entry.range.end)){
          baseSegments.push({start:entry.range.start,end:entry.range.end});
        }
        if(!baseSegments.length) return;
        totalRenderable+=1;
        const visibleSegments=[];
        baseSegments.forEach(seg=>{
          if(!seg) return;
          const segStart=Number.isFinite(seg.start)?Math.max(0,Math.min(1440,seg.start)):null;
          const segEnd=Number.isFinite(seg.end)?Math.max(0,Math.min(1440,seg.end)):null;
          if(segStart===null || segEnd===null || segEnd<=segStart) return;
          const visibleStart=Math.max(segStart,start);
          const visibleEnd=Math.min(segEnd,end);
          if(visibleEnd>visibleStart){
            visibleSegments.push({segStart,segEnd,visibleStart,visibleEnd});
          }
        });
        if(!visibleSegments.length){
          hiddenCount+=1;
          return;
        }
        const displayName=resolveEntryDisplayName(entry,lineViewCurrentLookup);
        filteredEntries.push({entry,visibleSegments,displayName});
      });

      if(!filteredEntries.length){
        const empty=document.createElement('div');
        empty.className='line-chart-empty';
        empty.textContent=totalRenderable? 'No scheduled shifts within the visible window.' : 'No scheduled shifts for this day.';
        lineChartRows.appendChild(empty);
      }else{
        filteredEntries.forEach(({entry,visibleSegments,displayName})=>{
          const row=document.createElement('div');
          row.className='line-row';
          if(entry && entry.highlight) row.classList.add('highlight');
          const track=document.createElement('div');
          track.className='line-row-track';
          ticks.forEach(tick=>{
            if(tick.percent<0 || tick.percent>100) return;
            const marker=document.createElement('div');
            marker.className=`line-track-marker${tick.isMajor?'':' minor'}`;
            marker.style.left=`${tick.percent}%`;
            track.appendChild(marker);
          });
          visibleSegments.forEach(segment=>{
            const bar=document.createElement('div');
            bar.className='line-bar';
            if(entry && entry.highlight) bar.classList.add('highlight');
            if(!bar.classList.contains('highlight')){
              const customColor=getCustomColorForEntry(entry);
              if(customColor){
                bar.style.backgroundColor=customColor;
              }
            }
            const left=((segment.visibleStart-start)/window)*100;
            const width=((segment.visibleEnd-segment.visibleStart)/window)*100;
            bar.style.left=`${left}%`;
            bar.style.width=`${width}%`;
            if(width<12){
              bar.classList.add('thin');
            }
            const titleParts=[displayName,`${fmtHMDisplay(segment.segStart)} – ${fmtHMDisplay(segment.segEnd)}`];
            const duration=formatDuration(segment.segEnd-segment.segStart);
            if(duration) titleParts.push(duration);
            bar.title=titleParts.join(' · ');
            const startLabel=document.createElement('span');
            startLabel.className='line-bar-time start';
            startLabel.textContent=fmtHMDisplay(segment.segStart);
            if(segment.segStart<start) startLabel.classList.add('clipped');
            bar.appendChild(startLabel);
            const nameEl=document.createElement('span');
            nameEl.className='line-bar-name';
            nameEl.textContent=displayName;
            bar.appendChild(nameEl);
            const endLabel=document.createElement('span');
            endLabel.className='line-bar-time end';
            endLabel.textContent=fmtHMDisplay(segment.segEnd);
            if(segment.segEnd>end) endLabel.classList.add('clipped');
            bar.appendChild(endLabel);
            barsNeedingAdjustment.push({bar,startLabel,endLabel,nameEl});
            track.appendChild(bar);
          });
          row.appendChild(track);
          lineChartRows.appendChild(row);
        });
        adjustLineBarTimeLabels(barsNeedingAdjustment);
      }

      if(lineWindowHint){
        if(hiddenCount>0){
          const plural=hiddenCount===1?'colleague is':'colleagues are';
          const prefix=lineWindowHintDefault?`${lineWindowHintDefault} `:'';
          lineWindowHint.textContent=`${prefix}Currently ${hiddenCount} ${plural} hidden outside the visible hours.`;
        }else{
          lineWindowHint.textContent=lineWindowHintDefault;
        }
      }
      updateLinePresetActiveState();
    }

    function adjustLineBarTimeLabels(bars=[]){
      if(!Array.isArray(bars) || !bars.length || !lineChartShell){
        return;
      }
      const shellRect=lineChartShell.getBoundingClientRect();
      const safePadding=12;
      const labelGap=8;
      const bumpedClass='bumped';
      bars.forEach(({bar,startLabel,endLabel,nameEl})=>{
        const barRect=bar?bar.getBoundingClientRect():null;
        const nameRect=nameEl?nameEl.getBoundingClientRect():null;
        const startCtrl=startLabel?(()=>{
          startLabel.style.removeProperty('--line-time-shift');
          startLabel.classList.remove(bumpedClass);
          let shift=0;
          let rect=startLabel.getBoundingClientRect();
          const setShift=value=>{
            shift=value;
            if(Math.abs(shift)<0.01){
              startLabel.style.removeProperty('--line-time-shift');
            }else{
              startLabel.style.setProperty('--line-time-shift',`${shift}px`);
            }
            rect=startLabel.getBoundingClientRect();
          };
          const ensureLeftBoundary=()=>{
            const overflow=(shellRect.left+safePadding)-rect.left;
            if(overflow>0){
              setShift(shift+overflow);
            }
          };
          ensureLeftBoundary();
          return {
            moveLeft:amount=>{
              if(amount>0){
                setShift(shift-amount);
                ensureLeftBoundary();
              }
            },
            moveRight:amount=>{
              if(amount>0){
                setShift(shift+amount);
                ensureLeftBoundary();
              }
            },
            get rect(){
              return rect;
            },
            get label(){
              return startLabel;
            }
          };
        })():null;
        const endCtrl=endLabel?(()=>{
          endLabel.style.removeProperty('--line-time-shift');
          endLabel.classList.remove(bumpedClass);
          let shift=0;
          let rect=endLabel.getBoundingClientRect();
          const setShift=value=>{
            shift=value;
            if(Math.abs(shift)<0.01){
              endLabel.style.removeProperty('--line-time-shift');
            }else{
              endLabel.style.setProperty('--line-time-shift',`${shift}px`);
            }
            rect=endLabel.getBoundingClientRect();
          };
          const ensureRightBoundary=()=>{
            const overflow=rect.right-(shellRect.right-safePadding);
            if(overflow>0){
              setShift(shift+overflow);
            }
          };
          ensureRightBoundary();
          return {
            moveLeft:amount=>{
              if(amount>0){
                setShift(shift+amount);
                ensureRightBoundary();
              }
            },
            moveRight:amount=>{
              if(amount>0){
                setShift(shift-amount);
                ensureRightBoundary();
              }
            },
            get rect(){
              return rect;
            },
            get label(){
              return endLabel;
            }
          };
        })():null;
        if(startCtrl){
          if(barRect){
            const overlap=startCtrl.rect.right-barRect.left;
            if(overlap>0){
              startCtrl.moveLeft(overlap+labelGap);
            }
          }
          if(nameRect){
            const overlap=startCtrl.rect.right-nameRect.left;
            if(overlap>0){
              startCtrl.moveLeft(overlap+labelGap);
            }
          }
        }
        if(endCtrl){
          if(barRect){
            const overlap=barRect.right-endCtrl.rect.left;
            if(overlap>0){
              endCtrl.moveRight(overlap+labelGap);
            }
          }
          if(nameRect){
            const overlap=nameRect.right-endCtrl.rect.left;
            if(overlap>0){
              endCtrl.moveRight(overlap+labelGap);
            }
          }
        }
        if(startCtrl && endCtrl){
          let overlap=startCtrl.rect.right-endCtrl.rect.left;
          if(overlap>0){
            const offset=overlap/2+labelGap;
            startCtrl.moveLeft(offset);
            endCtrl.moveRight(offset);
            overlap=startCtrl.rect.right-endCtrl.rect.left;
            if(overlap>0){
              const remainder=overlap+labelGap;
              startCtrl.moveLeft(remainder);
              endCtrl.moveRight(remainder);
            }
          }
        }
        const startRect=startCtrl?startCtrl.rect:null;
        const endRect=endCtrl?endCtrl.rect:null;
        if(startCtrl && ((barRect && rectsOverlap(startRect,barRect)) || (nameRect && rectsOverlap(startRect,nameRect)) || (endRect && rectsOverlap(startRect,endRect)))){
          startCtrl.label.classList.add(bumpedClass);
        }
        if(endCtrl && ((barRect && rectsOverlap(endRect,barRect)) || (nameRect && rectsOverlap(endRect,nameRect)))){
          endCtrl.label.classList.add(bumpedClass);
        }
      });
    }

    function renderLineIndividualWeekView(record,perDay,dayHeaders,dateRangeLabel){
      if(!lineIndividualWeek) return;
      lineIndividualWeek.innerHTML='';
      if(!record || !record.row || !Array.isArray(dayHeaders) || !dayHeaders.length){
        lineIndividualWeek.hidden=false;
        lineIndividualWeek.setAttribute('aria-hidden','false');
        const empty=document.createElement('div');
        empty.className='line-chart-empty';
        empty.textContent='No weekly data available for the selected colleague.';
        lineIndividualWeek.appendChild(empty);
        return;
      }
      const displayName=(record.record && record.record.displayName) || getRowDisplayName(record.row,record.index+1);
      const title=document.createElement('h3');
      title.className='line-week-individual-title';
      title.textContent=`Weekly timeline for ${displayName}`;
      lineIndividualWeek.appendChild(title);
      if(dateRangeLabel){
        const subtitle=document.createElement('p');
        subtitle.className='line-week-individual-subtitle';
        subtitle.textContent=dateRangeLabel;
        lineIndividualWeek.appendChild(subtitle);
      }
      const rowsWrap=document.createElement('div');
      rowsWrap.className='line-week-rows';
      dayHeaders.forEach((label,idx)=>{
        const entries=Array.isArray(perDay[idx])?perDay[idx]:[];
        const match=entries.find(entry=>entryMatchesSelection(entry,record.row)) || entries[0] || null;
        const row=document.createElement('article');
        row.className='line-week-row';
        if(match && match.highlight) row.classList.add('highlight');
        const header=document.createElement('div');
        header.className='line-week-row-header';
        const dayName=document.createElement('div');
        dayName.className='line-week-row-day';
        dayName.textContent=formatShortDayLabel(label)||`Day ${idx+1}`;
        header.appendChild(dayName);
        const timeBlock=document.createElement('div');
        timeBlock.className='line-week-row-time';
        const segments=match && Array.isArray(match.segments)?match.segments:[];
        let durationMinutes=null;
        if(match && match.range && Number.isFinite(match.range.start) && Number.isFinite(match.range.end)){
          durationMinutes=Math.max(0,(match.range.end||0)-(match.range.start||0));
        }
        if(match && (match.range || segments.length)){
          const start=match.range && Number.isFinite(match.range.start)?match.range.start:segments.length?segments[0].start:null;
          const end=match.range && Number.isFinite(match.range.end)?match.range.end:segments.length?segments[segments.length-1].end:null;
          const labelText=(Number.isFinite(start) && Number.isFinite(end))?`${fmtHMDisplay(start)} – ${fmtHMDisplay(end)}`:'Scheduled';
          timeBlock.textContent=labelText;
        }else{
          timeBlock.textContent='Off';
          timeBlock.classList.add('line-week-row-off');
        }
        header.appendChild(timeBlock);
        row.appendChild(header);
        if(match && (match.range || segments.length)){
          if(durationMinutes===null){
            const total=segments.reduce((sum,seg)=>sum+Math.max(0,(seg.end||0)-(seg.start||0)),0);
            durationMinutes=total;
          }
          if(durationMinutes){
            const duration=document.createElement('div');
            duration.className='line-week-row-duration';
            duration.textContent=formatDuration(durationMinutes);
            row.appendChild(duration);
          }
          const track=document.createElement('div');
          track.className='line-week-bar-track';
          const effectiveSegments=segments.length?segments:[match.range];
          effectiveSegments.filter(Boolean).forEach((seg,segIdx)=>{
            if(!seg) return;
            const bar=document.createElement('div');
            bar.className='line-week-bar';
            if(match && match.highlight) bar.classList.add('highlight');
            if(!bar.classList.contains('highlight')){
              const customColor=getCustomColorForEntry(match);
              if(customColor){
                bar.style.backgroundColor=customColor;
              }
            }
            const startPercent=Math.max(0,Math.min(100,(seg.start/1440)*100));
            const widthPercent=Math.max(0,Math.min(100,((seg.end-seg.start)/1440)*100));
            bar.style.left=`${startPercent}%`;
            bar.style.width=`${widthPercent}%`;
            if(segIdx===0){
              const labelSpan=document.createElement('span');
              labelSpan.className='line-week-bar-label';
              labelSpan.textContent=timeBlock.textContent;
              bar.appendChild(labelSpan);
            }
            track.appendChild(bar);
          });
          row.appendChild(track);
          const hint=document.createElement('div');
          hint.className='line-week-track-hint';
          hint.innerHTML='<span>00:00</span><span>24:00</span>';
          row.appendChild(hint);
        }
        rowsWrap.appendChild(row);
      });
      if(!rowsWrap.children.length){
        const empty=document.createElement('div');
        empty.className='line-chart-empty';
        empty.textContent='No scheduled shifts for this colleague.';
        lineIndividualWeek.appendChild(empty);
      }else{
        lineIndividualWeek.appendChild(rowsWrap);
      }
      lineIndividualWeek.hidden=false;
      lineIndividualWeek.setAttribute('aria-hidden','false');
    }

    function hideLineIndividualWeek(){
      if(!lineIndividualWeek) return;
      lineIndividualWeek.hidden=true;
      lineIndividualWeek.setAttribute('aria-hidden','true');
      lineIndividualWeek.innerHTML='';
    }

    function drawCurrentLineChart(){
      if(!lineChartShell || lineChartShell.hidden) return;
      updateLineViewResponsiveWindow();
      drawLineChart(lineViewCurrentEntries,lineViewCurrentDayLabel);
    }

    function renderLineView(weeks=getActiveWeekData()){
      if(!lineViewContainer) return;
      if(!Array.isArray(weeks) || !weeks.length){
        hideLineIndividualWeek();
        if(lineControls){
          lineControls.hidden=true;
          lineControls.setAttribute('aria-hidden','true');
        }
        if(lineChartShell){
          lineChartShell.hidden=true;
          lineChartShell.setAttribute('aria-hidden','true');
        }
        if(lineDaySummary){
          lineDaySummary.hidden=true;
        }
        syncLinePresetButtons(false);
        if(lineViewEmpty){
          lineViewEmpty.hidden=false;
        }
        lineViewCurrentEntries=[];
        lineViewCurrentLookup=new Map();
        lineViewCurrentDayLabel='';
        lineViewStateInitialized=false;
        lineViewLastWeekId=null;
        lineViewLastDayIndex=null;
        lineViewBaseMinutesPerPixel=null;
        lineViewUserSelectedDay=false;
        return;
      }
      const week=weeks[0];
      const model=week && week.model;
      if(!model){
        hideLineIndividualWeek();
        return;
      }
      const perDay=Array.isArray(week.perDay)?week.perDay:[];
      const dayHeaders=Array.isArray(model.dayHeaders)?model.dayHeaders:[];
      const layout=currentLayout || DEFAULT_LAYOUT;
      const selectionRecords=getSelectionRecords(model);
      const selectedRows=selectionRecords.map(item=>item.row);
      const selectionCount=selectionRecords.length;
      const filteredPerDay=filterPerDayEntries(perDay,selectedRows);
      const dateRangeLabel=resolveDateRangeLabelForWeek(model,week.metadata,layout) || '';
      if(selectionCount===1){
        syncLineViewControls([]);
        if(lineDaySummary){
          lineDaySummary.hidden=true;
        }
        if(lineWindowHint){
          lineWindowHint.hidden=true;
        }
        if(lineChartShell){
          lineChartShell.hidden=true;
          lineChartShell.setAttribute('aria-hidden','true');
        }
        if(lineViewEmpty){
          lineViewEmpty.hidden=true;
        }
        renderLineIndividualWeekView(selectionRecords[0],filteredPerDay,dayHeaders,dateRangeLabel);
        lineViewCurrentEntries=[];
        lineViewCurrentLookup=new Map();
        lineViewCurrentDayLabel='';
        lineViewStateInitialized=false;
        lineViewBaseMinutesPerPixel=null;
        return;
      }
      hideLineIndividualWeek();
      if(!perDay.length){
        syncLineViewControls([]);
        lineViewBaseMinutesPerPixel=null;
        if(lineWindowHint){
          lineWindowHint.hidden=false;
          lineWindowHint.textContent=lineWindowHintDefault;
        }
        return;
      }
      const weekId=week.id||'week';
      if(weekId!==lineViewLastWeekId){
        lineViewLastWeekId=weekId;
        lineViewStateInitialized=false;
        lineViewUserSelectedDay=false;
      }
      if(!lineViewUserSelectedDay){
        const todayIndex=findTodayDayIndex(dayHeaders,model);
        if(todayIndex>=0){
          lineViewState.dayIndex=todayIndex;
        }
      }
      if(lineViewState.dayIndex>=perDay.length){
        lineViewState.dayIndex=perDay.length-1;
        lineViewStateInitialized=false;
      }
      if(lineViewState.dayIndex<0){
        lineViewState.dayIndex=0;
        lineViewStateInitialized=false;
      }
      if(lineViewLastDayIndex!==lineViewState.dayIndex){
        lineViewLastDayIndex=lineViewState.dayIndex;
        lineViewStateInitialized=false;
      }
      const dayLabels=perDay.map((_,idx)=>dayHeaders[idx]||`Day ${idx+1}`);
      const entries=Array.isArray(filteredPerDay[lineViewState.dayIndex])?filteredPerDay[lineViewState.dayIndex]:[];
      if(!lineViewStateInitialized){
        const defaults=computeLineViewDefaults(entries);
        lineViewState.startMinute=defaults.startMinute;
        lineViewState.windowMinutes=defaults.windowMinutes;
        lineViewStateInitialized=true;
        lineViewBaseMinutesPerPixel=null;
      }else{
        lineViewState.windowMinutes=clampLineViewWindow(lineViewState.windowMinutes);
        lineViewState.startMinute=clampLineViewStart(lineViewState.startMinute,lineViewState.windowMinutes);
      }
      lineViewCurrentEntries=entries;
      lineViewCurrentLookup=buildDisplayNameLookup(model);
      lineViewCurrentDayLabel=dayLabels[lineViewState.dayIndex]||`Day ${lineViewState.dayIndex+1}`;
      syncLineViewControls(dayLabels);
      if(lineDaySummary && !lineDaySummary.hidden){
        const baseLabel=formatFullDayLabel(lineViewCurrentDayLabel)||lineViewCurrentDayLabel;
        if(selectionCount>1){
          lineDaySummary.textContent=`${baseLabel} — ${selectionCount} selected`;
        }else{
          lineDaySummary.textContent=baseLabel;
        }
      }
      if(lineWindowHint){
        lineWindowHint.hidden=false;
        if(selectionCount>1){
          lineWindowHint.textContent='Showing selected colleagues. Pinch to zoom the visible hours and drag the timeline to pan.';
        }else{
          lineWindowHint.textContent=lineWindowHintDefault;
        }
      }
      drawCurrentLineChart();
    }

    function renderWeekSchedule(container,week,{allowIndividual=true,showHeading=true}={}){
      if(!container || !week || !week.model) return;
      const model=week.model;
      const perDay=Array.isArray(week.perDay)?week.perDay:[];
      const layout=currentLayout || DEFAULT_LAYOUT;
      const dayHeaders=Array.isArray(model.dayHeaders)?model.dayHeaders:[];
      const safeWeekId=(typeof week.id==='string'?week.id:'week').replace(/[^a-z0-9_-]+/gi,'-');
      if(showHeading){
        const heading=document.createElement('div');
        heading.className='schedule-week-heading';
        const title=document.createElement('div');
        title.className='schedule-week-title';
        title.textContent=week.metadata && week.metadata.label?week.metadata.label:'Saved rota';
        heading.appendChild(title);
        const headingRange=resolveDateRangeLabelForWeek(model,week.metadata,layout) || (week.metadata && week.metadata.displayRange) || '';
        if(headingRange){
          const range=document.createElement('div');
          range.className='schedule-week-range';
          range.textContent=headingRange;
          heading.appendChild(range);
        }
        container.appendChild(heading);
      }
      if(!dayHeaders.length){
        const placeholder=document.createElement('div');
        placeholder.className='empty-state';
        placeholder.innerHTML='<strong>No day columns found</strong>We couldn\'t detect any day headings in this CSV.';
        container.appendChild(placeholder);
        return;
      }
      const formattedDates=dayHeaders.map(formatFullDayLabel);
      const dateRangeLabel=resolveDateRangeLabelForWeek(model,week.metadata,layout);
      const parsedHeaders=dayHeaders.map(parseDayHeader);
      const fallbackYear=(()=>{
        const withYear=parsedHeaders.find(info=>info && Number.isInteger(info.year));
        if(withYear) return withYear.year;
        const rangeYear=extractYearFromLabel(dateRangeLabel);
        if(Number.isInteger(rangeYear)) return rangeYear;
        return null;
      })();
      const header=document.createElement('div');
      header.className='schedule-header';
      const range=document.createElement('div');
      range.className='schedule-range';
      range.textContent=dateRangeLabel || 'Date range unavailable';
      header.appendChild(range);
      container.appendChild(header);

      const lookup=buildDisplayNameLookup(model);
      const selectionRecords=allowIndividual?getSelectionRecords(model):[];
      const selectedRows=selectionRecords.map(item=>item.row);
      const selectedCount=selectionRecords.length;
      const perDayData=selectedCount?filterPerDayEntries(perDay,selectedRows):perDay;
      const hasRows=Array.isArray(model.rows) && model.rows.length>0;

      if(allowIndividual && selectedCount===1){
        const selectedPerson=selectionRecords[0].row;
        const selectedRecord=selectionRecords[0].record;
        const selectedIndex=selectionRecords[0].index;
        const displayName=(selectedRecord && selectedRecord.displayName) || getRowDisplayName(selectedPerson,selectedIndex+1);
        const focusSection=document.createElement('section');
        focusSection.className='schedule-individual';
        const title=document.createElement('h2');
        title.className='schedule-individual-title';
        title.textContent=`Shifts for ${displayName}`;
        focusSection.appendChild(title);
        const list=document.createElement('div');
        list.className='individual-list';
        dayHeaders.forEach((label,idx)=>{
          const entries=Array.isArray(perDayData[idx])?perDayData[idx]:[];
          const match=entries.find(entry=>entryMatchesSelection(entry,selectedPerson));
          const item=document.createElement('article');
          item.className='individual-item';
          if(match && match.highlight) item.classList.add('highlight');
          const dayEl=document.createElement('div');
          dayEl.className='individual-item-day';
          dayEl.textContent=formatShortDayLabel(label) || `Day ${idx+1}`;
          item.appendChild(dayEl);
          const timeWrap=document.createElement('div');
          timeWrap.className='individual-item-time';
          if(match && match.range){
            const timeSpan=document.createElement('span');
            timeSpan.textContent=`${fmtHMDisplay(match.range.start)} – ${fmtHMDisplay(match.range.end)}`;
            timeWrap.appendChild(timeSpan);
            if(match.segments && match.segments.length>1){
              const segments=document.createElement('span');
              segments.className='individual-item-segments';
              segments.textContent=match.segments.map(seg=>`${fmtHMDisplay(seg.start)}–${fmtHMDisplay(seg.end)}`).join('  • ');
              timeWrap.appendChild(segments);
            }
            const durationText=formatDuration((match.range.end||0)-(match.range.start||0));
            if(durationText){
              const duration=document.createElement('span');
              duration.className='individual-item-duration';
              duration.textContent=durationText;
              timeWrap.appendChild(duration);
            }
          }else{
            const off=document.createElement('span');
            off.className='individual-item-off';
            off.textContent='Off';
            timeWrap.appendChild(off);
          }
          item.appendChild(timeWrap);
          list.appendChild(item);
        });
        focusSection.appendChild(list);
        const clearBtn=document.createElement('button');
        clearBtn.type='button';
        clearBtn.className='btn-clear-selection';
        clearBtn.textContent='Show all colleagues';
        clearBtn.addEventListener('click',()=>{
          setCurrentIndividualSelection([]);
          renderViews();
        });
        focusSection.appendChild(clearBtn);
        container.appendChild(focusSection);
        return;
      }

      const scheduleDays=document.createElement('div');
      scheduleDays.className='schedule-days';
      container.appendChild(scheduleDays);
      dayHeaders.forEach((label,idx)=>{
        const entries=Array.isArray(perDayData[idx])?perDayData[idx].filter(Boolean):[];
        const scheduledEntries=entries.filter(entry=>entry && entry.range);
        const card=document.createElement('details');
        card.className='schedule-day-card';
        card.id=`${safeWeekId}-schedule-day-${idx}`;
        const summary=document.createElement('summary');
        const summaryText=document.createElement('div');
        summaryText.className='schedule-day-summary-text';
        const title=document.createElement('div');
        title.className='schedule-day-title';
        title.textContent=formattedDates[idx] || label || `Day ${idx+1}`;
        summaryText.appendChild(title);
        const subtitle=document.createElement('div');
        subtitle.className='schedule-day-subtitle';
        if(scheduledEntries.length){
          const labelText=scheduledEntries.length===1?'colleague':'colleagues';
          subtitle.textContent=`${scheduledEntries.length} ${labelText} scheduled`;
        }else{
          subtitle.textContent='No scheduled colleagues';
        }
        summaryText.appendChild(subtitle);
        summary.appendChild(summaryText);
        const headerInfo=parsedHeaders[idx];
        if(isTodayDate(headerInfo,fallbackYear)){
          card.classList.add('today');
          const badge=document.createElement('span');
          badge.className='schedule-day-today-badge';
          badge.textContent='Today';
          summary.appendChild(badge);
          summary.setAttribute('aria-label',`${title.textContent} (Today)`);
        }
        card.appendChild(summary);

        const content=document.createElement('div');
        content.className='schedule-day-content';
        const shiftList=document.createElement('div');
        shiftList.className='schedule-shifts';
        if(!scheduledEntries.length){
          const empty=document.createElement('div');
          empty.className='no-shifts';
          empty.textContent='No scheduled colleagues';
          shiftList.appendChild(empty);
        }else{
          const sorted=scheduledEntries.slice().sort((a,b)=>{
            const aStart=a && a.range?a.range.start:Infinity;
            const bStart=b && b.range?b.range.start:Infinity;
            return aStart-bStart;
          });
          sorted.forEach(entry=>{
            const item=document.createElement('article');
            item.className='shift-card';
            if(entry.highlight) item.classList.add('highlight');
            const nameEl=document.createElement('div');
            nameEl.className='shift-name';
            nameEl.textContent=resolveEntryDisplayName(entry,lookup);
            item.appendChild(nameEl);
            const timeEl=document.createElement('div');
            timeEl.className='shift-time';
            const baseLabel=`${fmtHMDisplay(entry.range.start)} – ${fmtHMDisplay(entry.range.end)}`;
            const timeSpan=document.createElement('span');
            timeSpan.textContent=baseLabel;
            timeEl.appendChild(timeSpan);
            if(entry.segments && entry.segments.length>1){
              const segmentsSpan=document.createElement('span');
              segmentsSpan.className='shift-split';
              segmentsSpan.textContent=entry.segments.map(seg=>`${fmtHMDisplay(seg.start)}–${fmtHMDisplay(seg.end)}`).join('  • ');
              timeEl.appendChild(segmentsSpan);
            }
            const durationValue=formatDuration((entry.range.end||0)-(entry.range.start||0));
            if(durationValue){
              const durationSpan=document.createElement('span');
              durationSpan.className='shift-duration';
              durationSpan.textContent=durationValue;
              timeEl.appendChild(durationSpan);
            }
            item.appendChild(timeEl);
            shiftList.appendChild(item);
          });
        }
        content.appendChild(shiftList);
        card.appendChild(content);
        scheduleDays.appendChild(card);
      });

      if(allowIndividual && selectedCount===0){
        const individualSection=document.createElement('section');
        individualSection.className='individual-summary';
        const heading=document.createElement('h2');
        heading.textContent='Individual rota';
        individualSection.appendChild(heading);
        const message=document.createElement('p');
        message.textContent='Select a colleague in the left-hand controls to focus on their shifts above.';
        individualSection.appendChild(message);
        container.appendChild(individualSection);
      }
    }

    function renderScheduleView(weeks=getActiveWeekData()){
      const container=document.getElementById('scheduleView');
      if(!container) return;
      container.innerHTML='';
      if(!weeks.length){
        const placeholder=document.createElement('div');
        placeholder.className='empty-state';
        placeholder.innerHTML='<strong>Upload a rota</strong>Use the controls to load your CSV export and explore shifts here.';
        container.appendChild(placeholder);
        return;
      }
      const week=weeks[0];
      const section=document.createElement('section');
      section.className='schedule-week';
      renderWeekSchedule(section,week,{allowIndividual:true,showHeading:true});
      container.appendChild(section);
    }

    function renderWeekPdfPreview(sheets,week,{allowIndividual,showHeading}){
      if(!sheets || !week || !week.model) return;
      const layout=currentLayout || DEFAULT_LAYOUT;
      const model=week.model;
      const perDay=Array.isArray(week.perDay)?week.perDay:[];
      const dayHeaders=Array.isArray(model.dayHeaders)?model.dayHeaders:[];
      if(showHeading){
        const heading=document.createElement('div');
        heading.className='sheet-week-heading';
        heading.textContent=week.metadata && week.metadata.label?week.metadata.label:'Saved rota';
        sheets.appendChild(heading);
      }
      if(!dayHeaders.length){
        const placeholder=document.createElement('div');
        placeholder.className='empty-state';
        placeholder.innerHTML='<strong>No PDF preview</strong>This rota has no detectable day headings.';
        sheets.appendChild(placeholder);
        return;
      }
      const formattedDates=dayHeaders.map(formatFullDayLabel);
      const dateRangeLabel=resolveDateRangeLabelForWeek(model,week.metadata,layout);
      const selectionRecords=allowIndividual?getSelectionRecords(model):[];
      const selectedRows=selectionRecords.map(item=>item.row);
      const perDayForPreview=selectedRows.length?filterPerDayEntries(perDay,selectedRows):perDay;
      const totalPages=dayHeaders.length;
      if(allowIndividual && selectionRecords.length===1){
        const selected=selectionRecords[0];
        const person=selected.row;
        const displayName=(selected.record && selected.record.displayName) || getRowDisplayName(person,selected.index+1);
        const dayRows=[];
        dayHeaders.forEach((label,dayIdx)=>{
          const parsed=parseDayHeader(label);
          const dayName=(parsed && parsed.dayName) || formatShortDayLabel(label) || label || `Day ${dayIdx+1}`;
          const entries=Array.isArray(perDayForPreview[dayIdx])?perDayForPreview[dayIdx]:[];
          const match=entries.find(entry=>entryMatchesSelection(entry,person));
          const range=match && match.range?{...match.range}:null;
          const segments=match && Array.isArray(match.segments)?match.segments.map(seg=>({...seg})):[];
          dayRows.push({name:dayName,rawName:match && match.rawName ? match.rawName : person.rawName || '',range,segments,highlight:!!(match && match.highlight)});
        });
        drawDayCard(sheets,displayName,dayRows,{
          dateRangeLabel,
          pageNumber:1,
          totalPages:1,
          formattedDate:displayName,
          staticCode:layout.staticCode,
          layout,
          showEmptyRows:true,
          placeholderLabel:`${displayName} has no scheduled shifts`,
          columnHeaderLabel:'Day',
        });
        return;
      }
      dayHeaders.forEach((label,idx)=>{
        const rows=perDayForPreview[idx]||[];
        drawDayCard(sheets,label,rows,{
          dateRangeLabel,
          pageNumber:idx+1,
          totalPages,
          formattedDate:formattedDates[idx],
          staticCode:layout.staticCode,
          layout,
        });
      });
    }

    function renderPdfPreview(weeks=getActiveWeekData()){
      const sheets=document.getElementById('sheets');
      if(!sheets){
        return;
      }
      sheets.innerHTML='';
      if(!weeks.length){
        const placeholder=document.createElement('div');
        placeholder.className='empty-state';
        placeholder.innerHTML='<strong>No PDF preview</strong>Upload a CSV to generate printable sheets.';
        sheets.appendChild(placeholder);
        return;
      }
      const week=weeks[0];
      renderWeekPdfPreview(sheets,week,{allowIndividual:true,showHeading:false});
    }

    function updateIndividualControls(weeks){
      const select=document.getElementById('selIndividual');
      const btn=document.getElementById('btnExport');
      const scopeControl=document.getElementById('reportScopeControl');
      const scopeHint=document.getElementById('reportScopeHint');
      const hasWeeks=weeks && weeks.length>0;
      if(scopeControl){
        scopeControl.hidden=!hasWeeks;
        scopeControl.setAttribute('aria-hidden',hasWeeks?'false':'true');
      }
      if(scopeHint){
        scopeHint.hidden=!hasWeeks;
        scopeHint.setAttribute('aria-hidden',hasWeeks?'false':'true');
        if(hasWeeks){
          scopeHint.textContent='Select one or more colleagues to focus every preview and export.';
        }
      }
      if(!select || !btn){
        lastIndividuals=[];
        setCurrentIndividualSelection([]);
        return;
      }
      lastIndividuals=[];
      if(!hasWeeks){
        select.innerHTML='<option value="all">All colleagues</option>';
        select.multiple=true;
        select.disabled=true;
        btn.disabled=true;
        btn.textContent='Export PDF';
        setCurrentIndividualSelection([]);
        if(selectionActions){
          selectionActions.hidden=true;
          selectionActions.setAttribute('aria-hidden','true');
        }
        if(btnClearSelection){
          btnClearSelection.disabled=true;
        }
        if(btnManagementShortcut){
          btnManagementShortcut.disabled=true;
        }
        return;
      }
      const week=weeks[0];
      const model=week.model;
      const rows=Array.isArray(model.rows)?model.rows:[];
      const options=['<option value="all">All colleagues</option>'];
      rows.forEach((row,idx)=>{
        const display=getRowDisplayName(row,idx+1);
        options.push(`<option value="${idx}">${display}</option>`);
        lastIndividuals.push({index:idx,displayName:display,rawName:row.rawName,name:row.name});
      });
      select.innerHTML=options.join('');
      select.multiple=true;
      select.disabled=!rows.length;
      const size=Math.min(8,Math.max(2,rows.length+1));
      select.size=size;
      if(!rows.length){
        setCurrentIndividualSelection([]);
      }else{
        setCurrentIndividualSelection(currentIndividualSelection.slice(),{maxIndex:rows.length});
      }
      const selectedSet=new Set(currentIndividualSelection.map(val=>String(val)));
      Array.from(select.options).forEach(opt=>{
        if(opt.value==='all'){
          opt.selected=!selectedSet.size;
        }else{
          opt.selected=selectedSet.has(opt.value);
        }
      });
      btn.disabled=!rows.length;
      let btnLabel='Export weekly PDF';
      if(currentIndividualSelection.length===1){
        btnLabel='Export colleague PDF';
      }else if(currentIndividualSelection.length>1){
        btnLabel='Export filtered PDF';
      }
      btn.textContent=btnLabel;
      if(selectionActions){
        const showActions=rows.length>0;
        selectionActions.hidden=!showActions;
        selectionActions.setAttribute('aria-hidden',showActions?'false':'true');
      }
      if(btnClearSelection){
        btnClearSelection.disabled=!rows.length || !currentIndividualSelection.length;
      }
      if(btnManagementShortcut){
        const normalizedTargets=MANAGEMENT_SHORTCUT_NAMES;
        const hasShortcut=rows.length>0 && lastIndividuals.some(rec=>{
          const value=(rec.displayName||rec.rawName||rec.name||'').toLowerCase();
          return normalizedTargets.some(name=>value.includes(name));
        });
        btnManagementShortcut.disabled=!hasShortcut;
      }
    }

    function syncAppearanceControls(weeks){
      if(!appearanceControls) return;
      appearanceControls.innerHTML='';
      const week=Array.isArray(weeks) && weeks.length?weeks[0]:null;
      const model=week && week.model;
      const rows=Array.isArray(model && model.rows)?model.rows:[];
      if(!rows.length){
        appearanceControls.hidden=true;
        appearanceControls.setAttribute('aria-hidden','true');
        return;
      }
      const seenKeys=new Set();
      const entries=[];
      rows.forEach((row,index)=>{
        const keys=buildColorLookupKeys(row);
        const primary=keys[0];
        if(!primary || seenKeys.has(primary)) return;
        seenKeys.add(primary);
        entries.push({
          key:primary,
          row,
          index,
          label:getRowDisplayName(row,index+1),
          locked:isNathanName(row.rawName||row.name),
        });
      });
      if(!entries.length){
        appearanceControls.hidden=true;
        appearanceControls.setAttribute('aria-hidden','true');
        return;
      }
      entries.sort((a,b)=>a.label.localeCompare(b.label,undefined,{sensitivity:'base'}));
      const hint=document.createElement('p');
      hint.className='control-hint appearance-hint';
      hint.textContent='Adjust colleague bar colours across every report. Nathan\'s colour stays locked for quick identification.';
      appearanceControls.appendChild(hint);
      const grid=document.createElement('div');
      grid.className='appearance-grid';
      entries.forEach((entry,idx)=>{
        const item=document.createElement('div');
        item.className='appearance-item';
        const inputId=`appearanceColor-${idx}`;
        const label=document.createElement('label');
        label.className='appearance-label';
        label.setAttribute('for',inputId);
        label.textContent=entry.label;
        if(entry.locked){
          const lock=document.createElement('small');
          lock.textContent='Locked';
          label.appendChild(lock);
        }
        const input=document.createElement('input');
        input.type='color';
        input.id=inputId;
        input.className='appearance-color-input';
        const stored=getColorPreferenceByKey(entry.key);
        const lockedColor=normalizeColorHex(SPECIAL_NAME_COLOR);
        const defaultColor=entry.locked?(lockedColor||getDefaultPickerColor()):getDefaultPickerColor();
        input.value=stored||defaultColor||'#4b4b4b';
        input.disabled=entry.locked;
        if(!entry.locked){
          input.addEventListener('input',event=>{
            handleColorPreferenceChange(entry.key,event.target.value);
          });
        }
        item.appendChild(label);
        item.appendChild(input);
        grid.appendChild(item);
      });
      appearanceControls.appendChild(grid);
      appearanceControls.hidden=false;
      appearanceControls.setAttribute('aria-hidden','false');
    }

    function renderViews(){
      const weeks=getActiveWeekData();
      setViewerTabsVisibility(weeks.length>0);
      updateIndividualControls(weeks);
      syncAppearanceControls(weeks);
      if(!weeks.length && activeView!=='schedule'){
        switchView('schedule');
      }
      renderScheduleView(weeks);
      renderLineView(weeks);
      renderPdfPreview(weeks);
    }

    function addOrUpdateWeekRecord(model){
      if(!model) return;
      const sanitized=sanitizeModelForStorage(model);
      const metadata=deriveWeekMetadata(sanitized);
      const record={id:metadata.id,storedAt:Date.now(),metadata,model:sanitized};
      const existingIndex=savedWeekRecords.findIndex(item=>item.id===record.id);
      if(existingIndex>=0){
        savedWeekRecords[existingIndex]=record;
      }else{
        savedWeekRecords.push(record);
      }
      rebuildWeekCache();
      setActiveWeeks([record.id],{persist:true});
      ensureActiveWeeks();
      updateWeekSelectionUI();
      renderViews();
    }

    async function exportPDF(btn){
      if(!btn) return;
      const weeks=getActiveWeekData();
      if(!weeks.length){
        alert('No stored rotas to export.');
        return;
      }
      const week=weeks[0];
      if(!week || !week.model){
        alert('The selected week is unavailable.');
        return;
      }
      if(!window.PDFLib){
        alert('PDF generator failed to load. Please refresh and try again.');
        return;
      }
      const originalLabel=btn.textContent;
      btn.disabled=true;
      btn.textContent='Exporting…';
      try{
        const layout=currentLayout || DEFAULT_LAYOUT;
        const palette=buildPdfPalette(layout);
        const {PDFDocument,rgb,StandardFonts}=window.PDFLib;
        const pdfDoc=await PDFDocument.create();
        const fontRegular=await pdfDoc.embedFont(StandardFonts.Helvetica);
        const fontBold=await pdfDoc.embedFont(StandardFonts.HelveticaBold);
        const pageSize=[842,595];
        const model=week.model;
        const perDay=Array.isArray(week.perDay)?week.perDay:[];
        const dayHeaders=Array.isArray(model.dayHeaders)?model.dayHeaders:[];
        const selectionRecords=getSelectionRecords(model);
        const selectedRows=selectionRecords.map(item=>item.row);
        const filteredPerDay=selectedRows.length?filterPerDayEntries(perDay,selectedRows):perDay;
        const totalPages=Math.max(dayHeaders.length,1);
        let pageNumber=1;
        const formattedDates=dayHeaders.map(formatFullDayLabel);
        const dateRangeLabel=resolveDateRangeLabelForWeek(model,week.metadata,layout);
        dayHeaders.forEach((label,idx)=>{
          const rows=filteredPerDay[idx]||[];
          const footerText=formatFooterText(layout.footerTemplate,{
            pageNumber,
            totalPages,
            formattedDate:formattedDates[idx] || label || `Day ${idx+1}`,
            label:label,
          });
          const plan=buildPdfSheetPlan(rows,layout,{
            title:layout.title||DEFAULT_LAYOUT.title,
            rangeLabel:dateRangeLabel,
            code:(layout.staticCode||STATIC_CODE||'').trim(),
            date:formattedDates[idx] || label || `Day ${idx+1}`,
            footerText,
            footerNote:(layout.footerNote||'').trim(),
          },palette,{});
          const page=pdfDoc.addPage(pageSize);
          const pageBg=parseCssColor(layout.pageBackground);
          if(pageBg){
            page.drawRectangle({x:0,y:0,width:page.getWidth(),height:page.getHeight(),color:rgb(pageBg.r,pageBg.g,pageBg.b)});
          }
          drawPdfSheet(page,plan,{fonts:{regular:fontRegular,bold:fontBold},palette,rgb,margin:24});
          pageNumber+=1;
        });
        const baseName=week.metadata && week.metadata.label?week.metadata.label:'rota';
        const exportLabel=sanitizeFileName(baseName);
        const pdfBytes=await pdfDoc.save();
        const blob=new Blob([pdfBytes],{type:'application/pdf'});
        const url=URL.createObjectURL(blob);
        const link=document.createElement('a');
        link.href=url;
        link.download=`${exportLabel||'rota'}_schedule.pdf`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        setTimeout(()=>URL.revokeObjectURL(url),5000);
      }catch(err){
        console.error(err);
        alert(`Failed to export PDF: ${err.message}`);
      }finally{
        btn.disabled=false;
        btn.textContent=originalLabel;
      }
    }

    async function exportIndividualPDF(selectionIndex,btn){
      if(!btn) return;
      const weeks=getActiveWeekData();
      if(weeks.length!==1){
        await exportPDF(btn);
        return;
      }
      const idx=parseInt(selectionIndex,10);
      if(Number.isNaN(idx)){
        await exportPDF(btn);
        return;
      }
      const week=weeks[0];
      const model=week.model;
      if(!model || !Array.isArray(model.rows) || idx<0 || idx>=model.rows.length){
        alert('Select a colleague before exporting.');
        return;
      }
      if(!window.PDFLib){
        alert('PDF generator failed to load. Please refresh and try again.');
        return;
      }
      const person=model.rows[idx];
      const record=lastIndividuals.find(rec=>rec.index===idx);
      const baseName=getRowDisplayName(person,idx+1);
      const displayName=(record && record.displayName)||baseName;
      const resolvedName=displayName.trim()||baseName;
      const perDay=Array.isArray(week.perDay)?week.perDay:[];
      const layout=currentLayout || DEFAULT_LAYOUT;
      const palette=buildPdfPalette(layout);
      const dateRangeLabel=resolveDateRangeLabelForWeek(model,week.metadata,layout);
      const dayHeaders=Array.isArray(model.dayHeaders)?model.dayHeaders:[];
      const dayRows=[];
      dayHeaders.forEach((label,dayIdx)=>{
        const parsed=parseDayHeader(label);
        const dayName=(parsed && parsed.dayName)||label;
        const entries=Array.isArray(perDay[dayIdx])?perDay[dayIdx]:[];
        const match=entries.find(entry=>{
          if(person.rawName && entry.rawName){
            return entry.rawName===person.rawName;
          }
          return entry.name===person.name;
        });
        const range=match && match.range?{...match.range}:null;
        const segments=match && Array.isArray(match.segments)?match.segments.map(seg=>({...seg})):[];
        dayRows.push({name:dayName,rawName:(match && match.rawName) || person.rawName || '',range,segments,highlight:!!(match && match.highlight)});
      });
      const footerText=formatFooterText(layout.footerTemplate,{
        pageNumber:1,
        totalPages:1,
        formattedDate:resolvedName,
        label:resolvedName,
      });
      const footerNote=(layout.footerNote||'').trim();
      const plan=buildPdfSheetPlan(dayRows,layout,{
        title:layout.title||DEFAULT_LAYOUT.title,
        rangeLabel:dateRangeLabel,
        code:(layout.staticCode||STATIC_CODE||'').trim(),
        date:resolvedName,
        footerText,
        footerNote,
      },palette,{preserveEmptyRows:true,columnHeaderLabel:'Day'});
      const originalLabel=btn.textContent;
      btn.disabled=true;
      btn.textContent='Exporting…';
      try{
        const {PDFDocument,rgb,StandardFonts}=window.PDFLib;
        const pdfDoc=await PDFDocument.create();
        const fontRegular=await pdfDoc.embedFont(StandardFonts.Helvetica);
        const fontBold=await pdfDoc.embedFont(StandardFonts.HelveticaBold);
        const pageSize=[842,595];
        const page=pdfDoc.addPage(pageSize);
        const pageBg=parseCssColor(layout.pageBackground);
        if(pageBg){
          page.drawRectangle({x:0,y:0,width:page.getWidth(),height:page.getHeight(),color:rgb(pageBg.r,pageBg.g,pageBg.b)});
        }
        drawPdfSheet(page,plan,{fonts:{regular:fontRegular,bold:fontBold},palette,rgb,margin:24});
        const pdfBytes=await pdfDoc.save();
        const blob=new Blob([pdfBytes],{type:'application/pdf'});
        const url=URL.createObjectURL(blob);
        const link=document.createElement('a');
        link.href=url;
        link.download=`${sanitizeFileName(resolvedName||'schedule')}_schedule.pdf`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        setTimeout(()=>URL.revokeObjectURL(url),5000);
      }catch(err){
        console.error(err);
        alert(`Failed to export PDF: ${err.message}`);
      }finally{
        btn.disabled=false;
        btn.textContent=originalLabel;
      }
    }

    async function exportSelectedPDF(){
      const btn=document.getElementById('btnExport');
      if(!btn || btn.disabled) return;
      if(currentIndividualSelection.length===1){
        await exportIndividualPDF(currentIndividualSelection[0],btn);
        return;
      }
      await exportPDF(btn);
    }

    function buildPdfSheetPlan(rows,layout,meta={},palette={},options={}){
      const safeLayout={...DEFAULT_LAYOUT,...(layout||{})};
      const numberOr=(value,fallback)=>Number.isFinite(value)?value:fallback;
      const normalizedPadding=Math.max(8,numberOr(safeLayout.padding,DEFAULT_LAYOUT.padding));
      const paddingOuter=Math.max(12,normalizedPadding);
      const chartPadding=Math.max(12,normalizedPadding);
      const leftAxis=Math.max(120,numberOr(safeLayout.nameColumnWidth,DEFAULT_LAYOUT.nameColumnWidth));
      let chartWidth=Math.max(leftAxis+200,numberOr(safeLayout.chartWidth,DEFAULT_LAYOUT.chartWidth));
      const rowHeight=Math.max(18,numberOr(safeLayout.rowHeight,DEFAULT_LAYOUT.rowHeight));
      const chartHeaderHeight=Math.max(24,numberOr(safeLayout.headerHeight,DEFAULT_LAYOUT.headerHeight));
      const columnHeaderSize=Math.max(8,numberOr(safeLayout.columnHeaderSize,DEFAULT_LAYOUT.columnHeaderSize));
      const rowLabelSize=Math.max(8,numberOr(safeLayout.rowLabelSize,DEFAULT_LAYOUT.rowLabelSize));
      const barLabelSize=Math.max(6,numberOr(safeLayout.barLabelSize,DEFAULT_LAYOUT.barLabelSize));
      const footerSize=Math.max(8,numberOr(safeLayout.footerSize,DEFAULT_LAYOUT.footerSize));
      const axisLabelSize=Math.max(8,Math.min(16,rowLabelSize));
      const minInnerWidth=200;
      let innerWidth=chartWidth-chartPadding*2-leftAxis;
      if(innerWidth<minInnerWidth){
        innerWidth=minInnerWidth;
        chartWidth=innerWidth+chartPadding*2+leftAxis;
      }

      const sanitizeRange=range=>{
        if(!range || typeof range!=='object') return null;
        const start=Number(range.start);
        const end=Number(range.end);
        if(!Number.isFinite(start) || !Number.isFinite(end)) return null;
        const clampedStart=Math.max(0,Math.min(1440,start));
        const clampedEnd=Math.max(0,Math.min(1440,end));
        if(clampedEnd<=clampedStart) return null;
        return {start:clampedStart,end:clampedEnd};
      };

      const sanitizeSegments=segments=>{
        if(!Array.isArray(segments)) return [];
        const sanitized=[];
        segments.forEach(segment=>{
          if(!segment) return;
          const start=Number(segment.start);
          const end=Number(segment.end);
          if(!Number.isFinite(start) || !Number.isFinite(end)) return;
          const clampedStart=Math.max(0,Math.min(1440,start));
          const clampedEnd=Math.max(0,Math.min(1440,end));
          if(clampedEnd<=clampedStart) return;
          sanitized.push({start:clampedStart,end:clampedEnd});
        });
        sanitized.sort((a,b)=>a.start-b.start);
        return sanitized;
      };

      const placeholderLabel=String(options.placeholderLabel||'No scheduled colleagues');
      const preserveEmptyRows=!!options.preserveEmptyRows;
      const columnHeaderLabel=(options && options.columnHeaderLabel)||meta.columnHeaderLabel||'Colleague Names';
      const sourceRows=Array.isArray(rows)?rows.map((row,idx)=>{
        if(!row) return null;
        const name=(row.name||'').trim()||`Row ${idx+1}`;
        const highlight=!!row.highlight;
        const sanitizedSegments=sanitizeSegments(row.segments);
        let sanitizedRange=sanitizeRange(row.range);
        if(!sanitizedRange && sanitizedSegments.length){
          const starts=sanitizedSegments.map(seg=>seg.start);
          const ends=sanitizedSegments.map(seg=>seg.end);
          sanitizedRange={start:Math.min(...starts),end:Math.max(...ends)};
        }
        const customColor=getCustomColorForEntry(row);
        const parsedColor=customColor?parseCssColor(customColor):null;
        return {name,range:sanitizedRange,segments:sanitizedSegments,highlight,rawName:row.rawName||'',color:parsedColor};
      }).filter(Boolean):[];

      const visibleRows=preserveEmptyRows?sourceRows:sourceRows.filter(row=>row.range);
      const bodyRows=(visibleRows.length?visibleRows:[{name:placeholderLabel,range:null,segments:[],highlight:false,rawName:'',color:null}]).map(row=>({
        name:row.name,
        range:row.range,
        segments:row.segments,
        highlight:!!row.highlight,
        rawName:row.rawName||'',
        color:row.color||null,
      }));

      const inkColor=(palette && palette.ink)?palette.ink:{r:0,g:0,b:0};
      const mutedColor=(palette && palette.muted)?palette.muted:{r:0.5,g:0.5,b:0.5};
      const headerGap=6;
      let headerCursor=paddingOuter;
      const headerLines=[];
      const pushHeaderLine=(text,size,weight,color)=>{
        if(text===undefined || text===null) return;
        const cleaned=String(text).trim();
        if(!cleaned) return;
        const fontSize=Number(size);
        if(!Number.isFinite(fontSize) || fontSize<=0) return;
        headerLines.push({text:cleaned,size:fontSize,weight:weight||400,color:color||inkColor,top:headerCursor});
        headerCursor+=fontSize+headerGap;
      };

      pushHeaderLine(meta.title||safeLayout.title||DEFAULT_LAYOUT.title,numberOr(safeLayout.titleSize,DEFAULT_LAYOUT.titleSize),700,inkColor);
      pushHeaderLine(meta.rangeLabel,numberOr(safeLayout.subtitleSize,DEFAULT_LAYOUT.subtitleSize),600,mutedColor);
      const resolvedCode=(meta.code||safeLayout.staticCode||'').trim();
      pushHeaderLine(resolvedCode,numberOr(safeLayout.codeSize,DEFAULT_LAYOUT.codeSize),700,inkColor);
      pushHeaderLine(meta.date,numberOr(safeLayout.dateSize,DEFAULT_LAYOUT.dateSize),700,inkColor);
      if(headerLines.length){
        headerCursor-=headerGap;
      }
      const headerBlockEnd=headerLines.length?headerCursor:paddingOuter;
      const chartTop=Math.max(paddingOuter,headerBlockEnd+(headerLines.length?16:0));

      const chartHeight=chartPadding*2+chartHeaderHeight+rowHeight*bodyRows.length;
      const chartLeft=paddingOuter;
      const chart={
        left:chartLeft,
        top:chartTop,
        width:chartWidth,
        height:chartHeight,
        padding:chartPadding,
        headerHeight:chartHeaderHeight,
        leftAxis,
        innerWidth,
        rowHeight,
        axisLabelOffset:6,
        axisLabelSize,
        columnHeaderLabel,
        columnHeaderSize,
        rowLabelSize,
        barLabelSize,
        bodyRows,
      };

      let contentBottom=chartTop+chartHeight;
      const footerNotes=[];
      const noteLines=typeof meta.footerNote==='string'?meta.footerNote.split(/\r?\n/).map(line=>line.trim()).filter(Boolean):[];
      if(noteLines.length){
        let noteTop=contentBottom+12;
        noteLines.forEach(line=>{
          footerNotes.push({text:line,top:noteTop,size:footerSize,color:mutedColor});
          noteTop+=footerSize+6;
        });
        contentBottom=footerNotes[footerNotes.length-1].top+footerSize;
      }

      const sheetWidth=chartLeft+chartWidth+paddingOuter;
      const sheetHeight=contentBottom+paddingOuter;
      const footerText=typeof meta.footerText==='string'?meta.footerText.trim():'';
      const pageFooter=footerText?{text:footerText,size:footerSize,fontWeight:400,color:mutedColor}:null;

      const header=headerLines.map(line=>({
        text:line.text,
        top:line.top,
        size:line.size,
        weight:line.weight,
        color:line.color,
      }));

      return {
        sheetWidth,
        sheetHeight,
        paddingOuter,
        header,
        chart,
        footerNotes,
        pageFooter,
      };
    }

    function drawPdfSheet(page,plan,{fonts,palette,rgb,scaleLimit=1,margin=24}){
      const pageWidth=page.getWidth();
      const pageHeight=page.getHeight();
      const availableWidth=pageWidth-margin*2;
      const availableHeight=pageHeight-margin*2;
      const scale=Math.min(scaleLimit,availableWidth/plan.sheetWidth,availableHeight/plan.sheetHeight,1);
      const offsetX=margin+(availableWidth-plan.sheetWidth*scale)/2;
      const offsetY=margin+Math.max(0,availableHeight-plan.sheetHeight*scale);

      const toPageX=x=>offsetX+x*scale;
      const toPageYTop=y=>offsetY+(plan.sheetHeight-y)*scale;
      const rectCoords=(x,y,width,height)=>({
        x:toPageX(x),
        y:offsetY+(plan.sheetHeight-(y+height))*scale,
        width:width*scale,
        height:height*scale,
      });
      const lineCoords=(x1,y1,x2,y2)=>({
        start:{x:toPageX(x1),y:toPageYTop(y1)},
        end:{x:toPageX(x2),y:toPageYTop(y2)},
      });
      const drawLine=(x1,y1,x2,y2,color,width,extra={})=>{
        page.drawLine({
          ...lineCoords(x1,y1,x2,y2),
          thickness:Math.max(width*scale,0.25),
          color:rgb(color.r,color.g,color.b),
          opacity:extra.opacity,
        });
      };
      const drawRect=(x,y,width,height,options={})=>{
        page.drawRectangle({
          ...rectCoords(x,y,width,height),
          color:options.fill?rgb(options.fill.r,options.fill.g,options.fill.b):undefined,
          borderColor:options.stroke?rgb(options.stroke.r,options.stroke.g,options.stroke.b):undefined,
          borderWidth:options.strokeWidth?Math.max(options.strokeWidth*scale,0.25):undefined,
        });
      };
      const drawText=(text,{x,y,size,color,fontWeight=400,align='left',baseline='alphabetic'})=>{
        if(!text) return;
        const font=fontWeight>=600?fonts.bold:fonts.regular;
        const fontSize=Math.max(0.1,size*scale);
        const width=font.widthOfTextAtSize(text,fontSize);
        let pageX=toPageX(x);
        if(align==='center') pageX-=width/2;
        if(align==='right') pageX-=width;
        let pageY=toPageYTop(y);
        if(baseline==='top'){
          pageY-=font.heightAtSize(fontSize);
        }else if(baseline==='middle'){
          pageY-=font.heightAtSize(fontSize)/2;
        }
        page.drawText(text,{
          x:pageX,
          y:pageY,
          size:fontSize,
          font,
          color:rgb(color.r,color.g,color.b),
        });
      };

      const sheetBg=palette.sheetBackground;
      const sheetBorder=palette.sheetBorder;
      drawRect(0,0,plan.sheetWidth,plan.sheetHeight,{fill:sheetBg});

      plan.header.forEach(line=>{
        drawText(line.text,{
          x:plan.paddingOuter||18,
          y:line.top,
          size:line.size,
          color:line.color||palette.ink,
          fontWeight:line.weight||400,
          baseline:'top',
        });
      });

      const chart=plan.chart;
      const chartLeft=chart.left;
      const chartTop=chart.top;
      const chartWidth=chart.width;
      const chartHeight=chart.height;
      const innerPadding=chart.padding;
      const headerHeight=chart.headerHeight;
      const leftAxis=chart.leftAxis;
      const innerW=chart.innerWidth;
      const rowH=chart.rowHeight;
      const headerTop=chartTop+innerPadding;
      const headerBottom=headerTop+headerHeight;
      const bodyTop=headerBottom;
      const axisBaseline=headerBottom-6;
      const axisLabelOffset=chart.axisLabelOffset||6;
      const axisLabelSize=chart.axisLabelSize||12;
      drawRect(chartLeft,chartTop,chartWidth,chartHeight,{fill:sheetBg,stroke:sheetBorder,strokeWidth:1});
      drawRect(chartLeft+innerPadding,chartTop+innerPadding,chartWidth-innerPadding*2,headerHeight,{fill:palette.headerBand});

      drawLine(chartLeft+innerPadding+leftAxis,chartTop+innerPadding,chartLeft+innerPadding+leftAxis,chartTop+chartHeight-innerPadding,palette.sheetBorder,1.2);
      drawLine(chartLeft+innerPadding,headerBottom,chartLeft+chartWidth-innerPadding,headerBottom,palette.sheetBorder,1.2);

      const headerTextBaseline=headerTop+18;
      const columnLabel=chart.columnHeaderLabel||'Colleague Names';
      drawText(columnLabel,{
        x:chartLeft+innerPadding+6,
        y:headerTextBaseline,
        size:chart.columnHeaderSize,
        color:palette.columnHeader,
        fontWeight:700,
      });

      const toX=minute=>chartLeft+innerPadding+leftAxis+(minute/1440)*innerW;
      for(let minute=0;minute<=1440;minute+=15){
        const x=toX(minute);
        const isHour=minute%60===0;
        const color=isHour?palette.grid:palette.minorGrid;
        const strokeWidth=isHour?1:0.6;

        if(isHour && minute>0 && minute<1440){
          drawLine(x,headerTop,x,headerBottom,palette.grid,1);
        }

        if(minute>0 && minute<1440){
          drawLine(x,headerBottom,x,chartTop+chartHeight-innerPadding,color,strokeWidth);
        }

        if(isHour && minute<1440){
          drawText(fmtHMDisplay(minute),{
            x:x+axisLabelOffset,
            y:axisBaseline,
            size:axisLabelSize,
            color:palette.axis,
          });
        }
      }

      chart.bodyRows.forEach((row,idx)=>{
        const rowTop=bodyTop+idx*rowH;
        if(idx>0){
          drawLine(chartLeft+innerPadding,rowTop,chartLeft+chartWidth-innerPadding,rowTop,palette.grid,1);
        }
        drawText(row.name,{
          x:chartLeft+innerPadding+6,
          y:rowTop+rowH/2,
          size:chart.rowLabelSize,
          color:palette.rowLabel,
          baseline:'middle',
        });
        if(row.range){
          const labelText=`${fmtHMDisplay(row.range.start)} - ${fmtHMDisplay(row.range.end)}`;
          const customColor=row.color && row.color.r!==undefined?row.color:null;
          const barColor=row.highlight && palette.specialBar?palette.specialBar:(customColor||palette.bar);
          row.segments.forEach((seg,segIdx)=>{
            const segY=rowTop+4;
            const segHeight=rowH-8;
            const segX=toX(seg.start);
            const segW=Math.max(2,toX(seg.end)-segX);
            drawRect(segX,segY,segW,segHeight,{fill:barColor});
            if(segIdx===0){
              drawText(labelText,{
                x:segX+4,
                y:segY+segHeight/2+1,
                size:chart.barLabelSize,
                color:palette.barLabel,
                fontWeight:700,
                baseline:'middle',
              });
            }
          });
        }
      });

      drawLine(chartLeft+innerPadding,bodyTop+chart.bodyRows.length*rowH,chartLeft+chartWidth-innerPadding,bodyTop+chart.bodyRows.length*rowH,palette.sheetBorder,1.2);

      if(Array.isArray(plan.footerNotes)){
        plan.footerNotes.forEach(item=>{
          drawText(item.text,{
            x:plan.sheetWidth-plan.paddingOuter,
            y:item.top,
            size:item.size,
            color:item.color||palette.muted,
            align:'right',
            baseline:'top',
          });
        });
      }

      if(plan.pageFooter && plan.pageFooter.text){
        const footer=plan.pageFooter;
        const font=footer.fontWeight>=600?fonts.bold:fonts.regular;
        const footerSize=Math.max(0.1,footer.size*scale);
        const textWidth=font.widthOfTextAtSize(footer.text,footerSize);
        const x=pageWidth-margin-textWidth;
        const y=Math.max(4,margin/2);
        page.drawText(footer.text,{
          x,
          y,
          size:footerSize,
          font,
          color:rgb((footer.color||palette.muted).r,(footer.color||palette.muted).g,(footer.color||palette.muted).b),
        });
      }
    }

    function parseHexColor(color){
      if(!color || typeof color!=='string') return null;
      const hex=color.trim();
      const match=hex.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
      if(!match) return null;
      let value=match[1];
      if(value.length===3){
        value=value.split('').map(ch=>ch+ch).join('');
      }
      const int=parseInt(value,16);
      const r=(int>>16)&255;
      const g=(int>>8)&255;
      const b=int&255;
      return {r:r/255,g:g/255,b:b/255};
    }

    function parseCssColor(color){
      if(!color || typeof color!=='string') return null;
      const hex=parseHexColor(color);
      if(hex) return hex;
      const match=color.trim().match(/^rgba?\(([^)]+)\)$/i);
      if(!match) return null;
      const parts=match[1].split(',').map(part=>part.trim()).filter(Boolean);
      if(parts.length<3) return null;
      const nums=parts.slice(0,3).map(val=>{
        if(val.endsWith('%')){
          const pct=parseFloat(val);
          if(!Number.isFinite(pct)) return NaN;
          return Math.max(0,Math.min(100,pct))/100*255;
        }
        const num=parseFloat(val);
        return Number.isFinite(num)?num:NaN;
      });
      if(nums.some(v=>!Number.isFinite(v))) return null;
      const [r,g,b]=nums;
      return {r:Math.max(0,Math.min(255,r))/255,g:Math.max(0,Math.min(255,g))/255,b:Math.max(0,Math.min(255,b))/255};
    }

    function buildPdfPalette(layout){
      const computed=getComputedStyle(document.documentElement);
      const inkRaw=(computed.getPropertyValue('--ink')||'#111111').trim()||'#111111';
      const mutedRaw=(computed.getPropertyValue('--muted')||'#555555').trim()||'#555555';
      const getColor=(value,def)=>parseCssColor(value)||parseCssColor(def)||{r:0,g:0,b:0};
      return {
        ink:getColor(inkRaw,'#111111'),
        muted:getColor(mutedRaw,'#555555'),
        sheetBackground:getColor(layout.sheetBackground,DEFAULT_LAYOUT.sheetBackground),
        sheetBorder:getColor(layout.sheetBorder,DEFAULT_LAYOUT.sheetBorder),
        headerBand:getColor(layout.headerBandColor,DEFAULT_LAYOUT.headerBandColor),
        grid:getColor(layout.gridColor,DEFAULT_LAYOUT.gridColor),
        minorGrid:getColor(layout.minorGridColor,DEFAULT_LAYOUT.minorGridColor),
        axis:getColor(layout.axisColor,DEFAULT_LAYOUT.axisColor),
        columnHeader:getColor(layout.columnHeaderColor,layout.axisColor||DEFAULT_LAYOUT.columnHeaderColor),
        rowLabel:getColor(layout.rowLabelColor,DEFAULT_LAYOUT.rowLabelColor),
        specialBar:getColor(SPECIAL_NAME_COLOR,DEFAULT_LAYOUT.barColor),
        bar:getColor(layout.barColor,DEFAULT_LAYOUT.barColor),
        barLabel:getColor(layout.barLabelColor,DEFAULT_LAYOUT.barLabelColor),
      };
    }

    function handleLayoutControlChange(){
      const layout=getLayoutSettings();
      applyLayoutToDocument(layout);
      currentLayout=layout;
      renderViews();
    }

    // ---------- Sample & Wire-up ----------
    const hiddenInput=document.getElementById('input');
    const mobileHint=document.getElementById('mobileHint');
    const btnDismissHint=document.getElementById('btnDismissHint');
    const fileInput=document.getElementById('fileInput');
    const btnUpload=document.getElementById('btnUpload');
    const btnClearWeeks=document.getElementById('btnClearWeeks');
    const uploadLogPanel=document.getElementById('uploadLogPanel');
    const uploadLogContainer=document.getElementById('uploadLog');
    const btnClearLog=document.getElementById('btnClearLog');
    const uploadLogEntries=[];

    function hideMobileHint(){
      if(!mobileHint) return;
      mobileHint.hidden=true;
      mobileHint.setAttribute('aria-hidden','true');
    }

    function showMobileHint(){
      if(!mobileHint) return;
      mobileHint.hidden=false;
      mobileHint.setAttribute('aria-hidden','false');
    }

    function initMobileHint(){
      if(!mobileHint) return;
      if(isHomeTipDismissed()){
        hideMobileHint();
      }else{
        showMobileHint();
      }
      if(btnDismissHint){
        btnDismissHint.addEventListener('click',()=>{
          hideMobileHint();
          setHomeTipDismissed(true);
        });
      }
    }

    function formatFileSize(bytes){
      if(typeof bytes!=='number' || !Number.isFinite(bytes) || bytes<0){ return ''; }
      const units=['B','KB','MB','GB','TB'];
      let value=bytes;
      let unitIndex=0;
      while(value>=1024 && unitIndex<units.length-1){
        value/=1024;
        unitIndex+=1;
      }
      const precision=value>=100?0:value>=10?1:2;
      return `${value.toFixed(precision)} ${units[unitIndex]}`;
    }

    function normalizeLogDetail(detail){
      if(detail===undefined || detail===null){ return ''; }
      if(typeof detail==='string'){ return detail; }
      if(typeof detail==='object'){
        try{
          return JSON.stringify(detail,null,2);
        }catch(err){
          return String(detail);
        }
      }
      return String(detail);
    }

    function renderUploadLog(){
      if(!uploadLogContainer) return;
      uploadLogContainer.innerHTML='';
      if(!uploadLogEntries.length){
        const empty=document.createElement('p');
        empty.className='log-empty';
        empty.textContent='No upload activity yet.';
        uploadLogContainer.appendChild(empty);
      }else{
        const fragment=document.createDocumentFragment();
        const entries=uploadLogEntries.slice().reverse();
        entries.forEach(entry=>{
          const item=document.createElement('article');
          item.className='log-entry';
          item.dataset.level=entry.level;

          const message=document.createElement('div');
          message.className='log-entry-message';
          message.textContent=entry.message;
          item.appendChild(message);

          if(entry.details){
            const details=document.createElement('pre');
            details.className='log-entry-details';
            details.textContent=entry.details;
            item.appendChild(details);
          }

          const meta=document.createElement('div');
          meta.className='log-entry-meta';
          const timestamp=entry.time;
          const hours=String(timestamp.getHours()).padStart(2,'0');
          const minutes=String(timestamp.getMinutes()).padStart(2,'0');
          const seconds=String(timestamp.getSeconds()).padStart(2,'0');
          meta.textContent=`${hours}:${minutes}:${seconds} · ${entry.level.toUpperCase()}`;
          item.appendChild(meta);

          fragment.appendChild(item);
        });
        uploadLogContainer.appendChild(fragment);
      }
      if(uploadLogPanel){
        uploadLogPanel.classList.toggle('has-entries',uploadLogEntries.length>0);
      }
    }

    function addUploadLog(message,level='info',detail){
      if(!message){ message='(no message)'; }
      const normalizedLevel=typeof level==='string'?level.toLowerCase():'info';
      const entry={
        message:String(message),
        level:['success','warning','error','info'].includes(normalizedLevel)?normalizedLevel:'info',
        details:normalizeLogDetail(detail),
        time:new Date(),
      };
      uploadLogEntries.push(entry);
      if(uploadLogEntries.length>40){
        uploadLogEntries.shift();
      }
      renderUploadLog();
      const consoleMethod=entry.level==='error'?'error':entry.level==='warning'?'warn':'info';
      if(typeof console!=='undefined' && typeof console[consoleMethod]==='function'){
        if(detail!==undefined){
          console[consoleMethod](`[upload] ${entry.message}`,detail);
        }else{
          console[consoleMethod](`[upload] ${entry.message}`);
        }
      }
    }

    initMobileHint();
    renderUploadLog();
    if(btnClearLog){
      btnClearLog.addEventListener('click',()=>{
        uploadLogEntries.length=0;
        addUploadLog('Upload log cleared.','info');
      });
    }

    if(btnUpload && fileInput){
      const defaultUploadLabel=btnUpload.textContent||'Upload CSV';
      btnUpload.addEventListener('click',()=>{
        console.info('[upload-debug] Upload button clicked. Triggering hidden file input.');
        if(!fileInput){
          console.error('[upload-debug] File input element is missing; cannot open file picker.');
          addUploadLog('File input element missing when attempting to upload.','error');
          return;
        }
        try{
          fileInput.click();
          console.info('[upload-debug] fileInput.click() invoked. Waiting for user to select a file…');
        }catch(err){
          console.error('[upload-debug] Failed to trigger file input click.',err);
          addUploadLog('Could not open the file chooser.','error',err && err.message?err.message:err);
        }
      });
      fileInput.addEventListener('click',()=>{
        console.info('[upload-debug] Native file input received a click event.');
      });
      fileInput.addEventListener('change',()=>{
        console.info('[upload-debug] File input change event fired.',{ fileCount:fileInput.files?fileInput.files.length:0 });
        const files=fileInput.files;
        const file=files && files.length?files[0]:null;
        if(!file){
          if(hiddenInput){ hiddenInput.value=''; }
          btnUpload.textContent=defaultUploadLabel;
          addUploadLog('File selection cancelled or no file chosen.','info');
          console.warn('[upload-debug] No file was selected after the change event.');
          return;
        }
        const name=file.name||'file';
        const isCsv=name.toLowerCase().endsWith('.csv') || (file.type && file.type.toLowerCase()==='text/csv');
        if(!isCsv){
          alert('Please choose a CSV file.');
          fileInput.value='';
          if(hiddenInput){ hiddenInput.value=''; }
          btnUpload.textContent=defaultUploadLabel;
          addUploadLog('Rejected non-CSV file.','warning',{name,type:file.type||'unknown'});
          console.warn('[upload-debug] Rejected non-CSV file selection.',{ name,type:file.type||'unknown' });
          return;
        }
        const sizeLabel=formatFileSize(file.size);
        addUploadLog(`Selected ${name}${sizeLabel?` (${sizeLabel})`:''}.`,'info',{type:file.type||'text/csv'});
        console.info('[upload-debug] Accepted CSV file selection.',{ name,size:file.size,type:file.type||'text/csv' });
        const reader=new FileReader();
        reader.addEventListener('load',()=>{
          const text=typeof reader.result==='string'?reader.result:'';
          addUploadLog(`Finished reading ${name} (${text.length} characters).`,'success');
          console.info('[upload-debug] FileReader load event completed.',{ characters:text.length });
          if(hiddenInput){ hiddenInput.value=text; }
          fileInput.value='';
          btnUpload.textContent='Replace CSV';
          setCurrentIndividualSelection([]);
          if(!text.trim()){
            renderViews();
            addUploadLog('Uploaded CSV was empty after trimming whitespace.','warning');
            return;
          }
          try{
            addUploadLog('Parsing CSV data…','info');
            const layout=getLayoutSettings();
            applyLayoutToDocument(layout);
            currentLayout=layout;
            const model=parseExport(text);
            addOrUpdateWeekRecord(model);
            addUploadLog('CSV parsed and stored successfully.','success',`Saved weeks: ${savedWeekRecords.length}`);
          }catch(err){
            console.error(err);
            alert(err && err.message?err.message:'Failed to parse the provided CSV file.');
            btnUpload.textContent=defaultUploadLabel;
            addUploadLog('Failed to parse uploaded CSV.','error',err && err.message?err.message:err);
            console.error('[upload-debug] Error while parsing uploaded CSV.',err);
          }
        });
        reader.addEventListener('error',()=>{
          const errDetail=reader.error && reader.error.message?reader.error.message:'Unknown error';
          console.error(reader.error||new Error('Failed to read file'));
          alert(`Failed to read ${name}: ${errDetail}`);
          fileInput.value='';
          if(hiddenInput){ hiddenInput.value=''; }
          btnUpload.textContent=defaultUploadLabel;
          addUploadLog(`FileReader error while reading ${name}.`,'error',errDetail);
          console.error('[upload-debug] FileReader encountered an error while reading the file.',reader.error);
        });
        addUploadLog(`Reading ${name}${sizeLabel?` (${sizeLabel})`:''}…`,'info');
        console.info('[upload-debug] Began reading file contents with FileReader.');
        reader.readAsText(file);
      });
    }

    const exportButton=document.getElementById('btnExport');
    if(exportButton){
      exportButton.addEventListener('click',()=>{ exportSelectedPDF(); });
    }
    if(btnClearWeeks){
      btnClearWeeks.addEventListener('click',()=>{ clearAllWeeks(); });
    }

    const savedWeekSelect=document.getElementById('savedWeekSelect');
    if(savedWeekSelect){
      savedWeekSelect.addEventListener('change',()=>{
        const value=savedWeekSelect.value;
        setActiveWeeks(value?[value]:[],{persist:true});
        ensureActiveWeeks();
        updateWeekSelectionUI();
        renderViews();
      });
    }

    const btnForgetWeek=document.getElementById('btnForgetWeek');
    if(btnForgetWeek){
      btnForgetWeek.addEventListener('click',()=>{
        const value=savedWeekSelect?savedWeekSelect.value:'';
        if(value){
          removeWeekRecord(value);
        }
      });
    }

    const btnToggleSettings=document.getElementById('btnToggleSettings');
    if(btnToggleSettings){
      btnToggleSettings.addEventListener('click',event=>{
        event.preventDefault();
        event.stopPropagation();
        settingsDrawerOpen=!settingsDrawerOpen;
        syncSettingsPanel();
      });
    }

    document.addEventListener('click',event=>{
      if(!settingsDrawerOpen) return;
      const panel=document.getElementById('savedWeeksPanel');
      const toggle=document.getElementById('btnToggleSettings');
      if(panel && panel.contains(event.target)) return;
      if(toggle && toggle.contains(event.target)) return;
      settingsDrawerOpen=false;
      syncSettingsPanel();
    });
    const selIndividual=document.getElementById('selIndividual');
    if(selIndividual){
      selIndividual.addEventListener('change',()=>{
        const options=Array.from(selIndividual.options||[]);
        let selectedValues=options.filter(opt=>opt.selected).map(opt=>opt.value);
        const hasAllSelected=selectedValues.includes('all');
        const filteredValues=selectedValues.filter(val=>val!=='all');
        if(hasAllSelected && filteredValues.length){
          const allOption=options.find(opt=>opt.value==='all');
          if(allOption){
            allOption.selected=false;
          }
          selectedValues=filteredValues;
        }
        if(!selectedValues.length){
          setCurrentIndividualSelection([]);
        }else{
          const indices=selectedValues.map(val=>parseInt(val,10)).filter(idx=>Number.isInteger(idx));
          setCurrentIndividualSelection(indices);
        }
        renderViews();
      });
    }

    if(btnClearSelection){
      btnClearSelection.addEventListener('click',()=>{
        if(btnClearSelection.disabled) return;
        setCurrentIndividualSelection([]);
        renderViews();
      });
    }

    if(btnManagementShortcut){
      btnManagementShortcut.addEventListener('click',()=>{
        if(btnManagementShortcut.disabled) return;
        if(!lastIndividuals.length){
          return;
        }
        const matches=lastIndividuals.filter(rec=>{
          const value=(rec.displayName||rec.rawName||rec.name||'').toLowerCase();
          return MANAGEMENT_SHORTCUT_NAMES.some(name=>value.includes(name));
        }).map(rec=>rec.index);
        setCurrentIndividualSelection(matches);
        renderViews();
      });
    }

    const viewerContainer=document.getElementById('viewerContainer');
    const viewerTabsContainer=document.querySelector('.viewer-tabs');
    const viewerTabs=Array.from(document.querySelectorAll('.viewer-tab'));
    const viewPanels={
      schedule:document.getElementById('viewSchedule'),
      line:document.getElementById('viewLine'),
      pdf:document.getElementById('viewPdf'),
    };
    let activeView='schedule';

    function setViewerTabsVisibility(visible){
      const show=!!visible;
      if(viewerContainer){
        viewerContainer.hidden=!show;
        viewerContainer.setAttribute('aria-hidden',show?'false':'true');
      }
      if(viewerTabsContainer){
        viewerTabsContainer.hidden=!show;
        viewerTabsContainer.setAttribute('aria-hidden',show?'false':'true');
      }
      if(viewerTabs && viewerTabs.length){
        viewerTabs.forEach(btn=>{
          btn.disabled=!show;
          if(!show){
            btn.setAttribute('tabindex','-1');
            btn.setAttribute('aria-hidden','true');
          }else{
            const isActive=btn.dataset.view===activeView;
            btn.setAttribute('tabindex',isActive?'0':'-1');
            btn.setAttribute('aria-hidden','false');
          }
        });
      }
    }

    function switchView(view){
      if(!viewPanels[view]) return;
      activeView=view;
      viewerTabs.forEach(btn=>{
        const isActive=btn.dataset.view===view;
        btn.classList.toggle('active',isActive);
        btn.setAttribute('aria-selected',isActive?'true':'false');
        btn.setAttribute('aria-pressed',isActive?'true':'false');
        btn.setAttribute('tabindex',isActive?'0':'-1');
      });
      Object.entries(viewPanels).forEach(([key,panel])=>{
        if(!panel) return;
        const isActive=key===view;
        panel.classList.toggle('active',isActive);
        panel.setAttribute('aria-hidden',isActive?'false':'true');
      });
    }

    if(viewerTabs.length){
      viewerTabs.forEach(btn=>{
        btn.addEventListener('click',()=>{
          const view=btn.dataset.view;
          if(view){
            switchView(view);
          }
        });
      });
      switchView(activeView);
    }

    if(lineDaySelect){
      lineDaySelect.addEventListener('change',()=>{
        const value=parseInt(lineDaySelect.value,10);
        if(!Number.isNaN(value)){
          lineViewUserSelectedDay=true;
          lineViewState.dayIndex=value;
          lineViewStateInitialized=false;
          renderLineView(getActiveWeekData());
        }
      });
    }

    let lineViewDrag=null;
    const lineViewPointers=new Map();
    let lineViewPinch=null;

    function getLineTrackMetrics(){
      if(!lineChartRows) return null;
      const firstTrack=lineChartRows.querySelector('.line-row-track');
      if(!firstTrack) return null;
      const rect=firstTrack.getBoundingClientRect();
      if(!rect || rect.width<=0) return null;
      return {left:rect.left,right:rect.right,width:rect.width};
    }

    function handleLinePointerDown(event){
      if(event.button!==0) return;
      if(!lineChartShell || lineChartShell.hidden) return;
      const element=event.target instanceof Element?event.target:null;
      const inTrack=element?element.closest('.line-row-track'):null;
      const inAxis=element && lineChartAxis?lineChartAxis.contains(element):false;
      if(!inTrack && !inAxis) return;
      const metrics=getLineTrackMetrics();
      if(!metrics) return;
      lineViewPointers.set(event.pointerId,{x:event.clientX,y:event.clientY,startX:event.clientX,startY:event.clientY,ignore:false});
      lineChartShell.setPointerCapture(event.pointerId);
      const activeEntries=Array.from(lineViewPointers.entries()).filter(([,info])=>info && !info.ignore);
      if(activeEntries.length===1){
        const [activeId,info]=activeEntries[0];
        lineViewDrag={pointerId:activeId,startX:info?info.startX:event.clientX,startY:info?info.startY:event.clientY,startMinute:lineViewState.startMinute,trackWidth:metrics.width,intent:null};
        lineViewPinch=null;
      }else if(activeEntries.length>=2){
        const pointerEntries=activeEntries.slice(0,2);
        const firstPos=pointerEntries[0][1];
        const secondPos=pointerEntries[1][1];
        const distance=Math.hypot(secondPos.x-firstPos.x,secondPos.y-firstPos.y);
        if(distance>0){
          const centerX=(firstPos.x+secondPos.x)/2;
          const rawFraction=(centerX-metrics.left)/metrics.width;
          const centerFraction=Number.isFinite(rawFraction)?Math.max(0,Math.min(1,rawFraction)):0.5;
          lineViewPinch={
            pointerIds:pointerEntries.map(([id])=>id),
            initialDistance:distance,
            startWindow:lineViewState.windowMinutes,
            startMinute:lineViewState.startMinute,
            centerMinute:lineViewState.startMinute+lineViewState.windowMinutes*centerFraction,
            metrics,
          };
          lineViewDrag=null;
        }
      }
    }

    function handleLinePointerMove(event){
      if(!lineChartShell || lineChartShell.hidden) return;
      if(lineViewPointers.has(event.pointerId)){
        const info=lineViewPointers.get(event.pointerId);
        if(info){
          info.x=event.clientX;
          info.y=event.clientY;
        }
      }
      if(lineViewPinch){
        const activeIds=lineViewPinch.pointerIds.filter(id=>{
          const info=lineViewPointers.get(id);
          return info && !info.ignore;
        });
        if(activeIds.length>=2 && lineViewPinch.metrics && lineViewPinch.metrics.width){
          const firstPos=lineViewPointers.get(activeIds[0]);
          const secondPos=lineViewPointers.get(activeIds[1]);
          if(!firstPos || !secondPos) return;
          const distance=Math.hypot(secondPos.x-firstPos.x,secondPos.y-firstPos.y);
          if(distance>0){
            const scale=lineViewPinch.initialDistance/distance;
            let windowMinutes=clampLineViewWindow(lineViewPinch.startWindow*scale);
            const centerX=(firstPos.x+secondPos.x)/2;
            const rawFraction=(centerX-lineViewPinch.metrics.left)/lineViewPinch.metrics.width;
            const centerFraction=Number.isFinite(rawFraction)?Math.max(0,Math.min(1,rawFraction)):0.5;
            let startMinute=lineViewPinch.centerMinute-windowMinutes*centerFraction;
            startMinute=clampLineViewStart(startMinute,windowMinutes);
            const changed=Math.abs(windowMinutes-lineViewState.windowMinutes)>=0.5 || Math.abs(startMinute-lineViewState.startMinute)>=0.5;
            if(changed){
              lineViewState.windowMinutes=windowMinutes;
              lineViewState.startMinute=startMinute;
              if(lineViewPinch.metrics.width>0){
                lineViewBaseMinutesPerPixel=windowMinutes/lineViewPinch.metrics.width;
              }
              drawCurrentLineChart();
            }
            event.preventDefault();
            return;
          }
        }
      }
      if(!lineViewDrag || event.pointerId!==lineViewDrag.pointerId) return;
      if(!lineViewDrag.trackWidth) return;
      const deltaX=event.clientX-lineViewDrag.startX;
      const deltaY=event.clientY-lineViewDrag.startY;
      const threshold=6;
      if(!lineViewDrag.intent){
        if(Math.abs(deltaY)>Math.abs(deltaX) && Math.abs(deltaY)>threshold){
          const info=lineViewPointers.get(event.pointerId);
          if(info){
            info.ignore=true;
          }
          if(lineChartShell.hasPointerCapture(event.pointerId)){
            lineChartShell.releasePointerCapture(event.pointerId);
          }
          lineViewDrag=null;
          return;
        }
        if(Math.abs(deltaX)>threshold){
          lineViewDrag.intent='horizontal';
        }else{
          return;
        }
      }
      if(!lineViewDrag || lineViewDrag.intent!=='horizontal') return;
      const minutesDelta=(deltaX/lineViewDrag.trackWidth)*lineViewState.windowMinutes;
      const newStart=clampLineViewStart(lineViewDrag.startMinute-minutesDelta,lineViewState.windowMinutes);
      if(newStart!==lineViewState.startMinute){
        lineViewState.startMinute=newStart;
        drawCurrentLineChart();
      }
      event.preventDefault();
    }

    function handleLinePointerUp(event){
      if(lineChartShell && lineChartShell.hasPointerCapture(event.pointerId)){
        lineChartShell.releasePointerCapture(event.pointerId);
      }
      if(lineViewPointers.has(event.pointerId)){
        lineViewPointers.delete(event.pointerId);
      }
      if(lineViewPinch && lineViewPinch.pointerIds.includes(event.pointerId)){
        lineViewPinch=null;
      }
      if(lineViewDrag && event.pointerId===lineViewDrag.pointerId){
        lineViewDrag=null;
      }
      if(!lineViewPinch){
        const activeEntries=Array.from(lineViewPointers.entries()).filter(([,info])=>info && !info.ignore);
        if(activeEntries.length===1){
          const [remainingId,pos]=activeEntries[0];
          const metrics=getLineTrackMetrics();
          if(metrics && pos){
            lineViewDrag={pointerId:remainingId,startX:pos.x,startY:pos.y,startMinute:lineViewState.startMinute,trackWidth:metrics.width,intent:null};
          }
        }
      }
    }

    if(lineChartShell){
      lineChartShell.addEventListener('pointerdown',handleLinePointerDown);
      lineChartShell.addEventListener('pointermove',handleLinePointerMove);
      lineChartShell.addEventListener('pointerup',handleLinePointerUp);
      lineChartShell.addEventListener('pointercancel',handleLinePointerUp);
      lineChartShell.addEventListener('lostpointercapture',handleLinePointerUp);
    }

    function handleLineViewportChange(){
      if(!lineChartShell || lineChartShell.hidden) return;
      drawCurrentLineChart();
    }

    window.addEventListener('resize',handleLineViewportChange);
    if(window.visualViewport){
      window.visualViewport.addEventListener('resize',handleLineViewportChange);
      window.visualViewport.addEventListener('scroll',handleLineViewportChange);
    }

    const layoutControlIds=[
      'inpTitle','inpSubtitle','inpStaticCode','inpFooter','inpFooterNote','inpRowHeight','inpChartWidth','inpNameWidth','inpHeaderHeight','inpPadding','inpTitleSize','inpRangeSize','inpCodeSize','inpDateSize','inpFooterSize','inpColumnHeaderSize','inpRowLabelSize','inpBarLabelSize','inpBarColor','inpBarLabelColor','inpHeaderBandColor','inpGridColor','inpMinorGridColor','inpAxisColor','inpColumnHeaderColor','inpRowLabelColor','inpSheetBgColor','inpSheetBorderColor','inpPageBgColor'
    ];
    layoutControlIds.forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener('input',handleLayoutControlChange);
      el.addEventListener('change',handleLayoutControlChange);
    });

    // First paint
    document.addEventListener('DOMContentLoaded',()=>{
      if(hiddenInput){ hiddenInput.value=''; }
      if(btnUpload){ btnUpload.textContent='Upload CSV'; }
      addUploadLog('Ready to upload CSV files.','info');
      const layout=getLayoutSettings();
      applyLayoutToDocument(layout);
      currentLayout=layout;
      updateWeekSelectionUI();
      renderViews();
      switchView('schedule');
    });
  </script>
</body>
</html>

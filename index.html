<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Colleague Summary — HTML Demo</title>
  <style>
    :root {
      --page-bg:#fff;
      --ink:#111;
      --muted:#555;
      --grid:#d4d4d4;
      --axis:#888;
      --accent:#4a4a4a;
      --sheet-bg:#fff;
      --sheet-border:#000;
      --sheet-header-band:#efefef;
      --sheet-title-size:26px;
      --sheet-range-size:22px;
      --sheet-code-size:21px;
      --sheet-date-size:16px;
      --sheet-footer-size:12px;
      --column-header-size:12px;
      --column-header-color:#111111;
      --row-label-size:12px;
      --bar-label-size:11px;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:0;font:12px/1.35 "Arial","Helvetica Neue",Helvetica,sans-serif;color:var(--ink);background:var(--page-bg)}
    h1{font-size:26px;margin:0;font-weight:600;color:var(--ink)}
    p{color:var(--muted);margin:6px 0 20px}
    .wrap{max-width:none;margin:0;padding:24px 32px;width:100%}
    .controls{display:grid;gap:12px;grid-template-columns:2fr minmax(240px,1fr);align-items:start;border:1px solid #cfcfcf;padding:16px 18px;border-radius:6px;background:#fafafa;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    textarea{width:100%;height:200px;resize:vertical;color:var(--ink);background:#fff;border:1px solid #cfcfcf;border-radius:4px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .btn{appearance:none;border:1px solid #2d4a83;border-radius:4px;padding:9px 14px;background:linear-gradient(180deg,#4867a9,#324a7a);color:#fff;font-weight:600;cursor:pointer;letter-spacing:.2px}
    .btn[disabled]{opacity:.65;cursor:not-allowed}
    .btn:active{transform:translateY(1px)}
    .side{display:flex;flex-direction:column;gap:12px;min-width:240px}
    .panel{border:1px solid #cfd5e2;border-radius:6px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:0}
    .panel summary{cursor:pointer;list-style:none;font-weight:600;color:var(--ink);padding:12px 14px;font-size:13px;display:flex;align-items:center;justify-content:space-between}
    .panel summary::-webkit-details-marker{display:none}
    .panel summary::after{content:'▾';font-size:11px;color:var(--muted);transition:transform .2s}
    .panel[open] summary::after{transform:rotate(180deg)}
    .panel-body{padding:0 14px 14px;display:grid;gap:12px}
    .ctrl-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
    .ctrl{display:flex;flex-direction:column;gap:4px;font-size:12px;color:var(--muted)}
    .ctrl input,.ctrl select{padding:7px 9px;border:1px solid #cfd5e2;border-radius:4px;font:12px/1.35 "Arial","Helvetica Neue",Helvetica,sans-serif;color:var(--ink);background:#fff}
    .ctrl input[type="color"]{padding:0;height:34px}
    .ctrl small{color:var(--muted);font-size:11px}
    .ctrl-inline{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
    .sheets{display:flex;flex-direction:column;gap:28px}
    .sheet{
      padding:18px;
      background:var(--sheet-bg);
      border:1px solid var(--sheet-border);
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .sheet-header{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:10px;
      padding-bottom:4px;
    }
    .sheet-title{font-size:var(--sheet-title-size);font-weight:600;color:var(--ink)}
    .sheet-range{font-size:var(--sheet-range-size);color:var(--muted)}
    .sheet-code{font-size:var(--sheet-code-size);font-weight:700;color:var(--ink);margin-top:6px}
    .sheet-date{font-size:var(--sheet-date-size);font-weight:600;color:var(--ink)}
    .sheet svg{width:100%;height:auto;display:block}
    .sheet-footer{margin-top:auto;font-size:var(--sheet-footer-size);color:var(--muted);text-align:right}
    .sheet-footnote{font-size:var(--sheet-footer-size);color:var(--muted);text-align:right;white-space:pre-wrap}
    .axislabel{fill:#000;font-size:12px;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
    .colheader{fill:var(--column-header-color,#000);font-size:var(--column-header-size,12px);font-weight:700;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif;text-transform:uppercase}
    .rowlabel{fill:var(--row-label-color,#000);font-size:var(--row-label-size,12px);dominant-baseline:middle;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
    .gridline{stroke:#d0d0d0;stroke-width:1}
    .gridline-minor{stroke:#ededed;stroke-width:.6}
    .divider{stroke:#000;stroke-width:1.2}
    .bar{fill:#7b7b7b}
    .barlabel{fill:#fff;font-size:var(--bar-label-size,11px);font-weight:700;dominant-baseline:middle;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
    .footer{margin-top:24px;color:var(--muted);font-size:12px;text-align:center}
    .switch{position:relative;display:inline-block;width:46px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#cfd5e2;border-radius:999px;border:1px solid #a3afc5}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:2px;background:white;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.25)}
    input:checked + .slider{background:#6aa871;border-color:#4e8d58}
    input:checked + .slider:before{transform:translateX(20px)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Daily Colleague Summary</h1>
    <p>Paste your raw export and hit <b>Render</b>. By default we show <b>Whole Shift</b> ranges; if a day has none, we can <i>fallback</i> to the first <code>SCH:</code> range so you still see coverage.</p>

    <div class="controls">
      <textarea id="input"></textarea>
      <div class="side">
        <button class="btn" id="btnRender">Render</button>
        <button class="btn" id="btnExport" style="background:linear-gradient(180deg,#f59e0b,#d97706)">Export PDF</button>
        <div class="row">
          <label class="switch"><input type="checkbox" id="chkFallback" checked><span class="slider"></span></label>
          <span>Use <b>SCH:</b> when no <b>Whole&nbsp;Shift</b> found</span>
        </div>
        <div class="row">
          <label class="switch"><input type="checkbox" id="chkSplit" checked><span class="slider"></span></label>
          <span>Split bars at midnight</span>
        </div>
        <details class="panel" open>
          <summary>Appearance &amp; Layout</summary>
          <div class="panel-body">
            <div class="ctrl-grid">
              <label class="ctrl">
                <span>Sheet title</span>
                <input type="text" id="inpTitle" value="Daily Colleague Summary">
              </label>
              <label class="ctrl">
                <span>Subtitle override</span>
                <input type="text" id="inpSubtitle" placeholder="Leave blank to auto-fill">
              </label>
              <label class="ctrl">
                <span>Static code</span>
                <input type="text" id="inpStaticCode" value="7774">
              </label>
              <label class="ctrl">
                <span>Footer template</span>
                <input type="text" id="inpFooter" value="Page {page} of {total}">
                <small>Use {page}, {total}, {date}, {label}</small>
              </label>
              <label class="ctrl">
                <span>Footer note</span>
                <input type="text" id="inpFooterNote" placeholder="Optional text shown under chart">
              </label>
            </div>
            <div class="ctrl-grid">
              <label class="ctrl">
                <span>Row height</span>
                <input type="number" id="inpRowHeight" value="28" min="18" max="80">
              </label>
              <label class="ctrl">
                <span>Chart width</span>
                <input type="number" id="inpChartWidth" value="1150" min="600" max="1600">
              </label>
              <label class="ctrl">
                <span>Name column width</span>
                <input type="number" id="inpNameWidth" value="140" min="140" max="400" disabled>
              </label>
              <label class="ctrl">
                <span>Header height</span>
                <input type="number" id="inpHeaderHeight" value="36" min="24" max="80">
              </label>
              <label class="ctrl">
                <span>Chart padding</span>
                <input type="number" id="inpPadding" value="14" min="6" max="40">
              </label>
            </div>
            <div class="ctrl-grid">
              <label class="ctrl">
                <span>Title size</span>
                <input type="number" id="inpTitleSize" value="26" min="14" max="48">
              </label>
              <label class="ctrl">
                <span>Subtitle size</span>
                <input type="number" id="inpRangeSize" value="22" min="10" max="28" disabled>
              </label>
              <label class="ctrl">
                <span>Code size</span>
                <input type="number" id="inpCodeSize" value="21" min="12" max="48" disabled>
              </label>
              <label class="ctrl">
                <span>Date size</span>
                <input type="number" id="inpDateSize" value="16" min="12" max="36">
              </label>
              <label class="ctrl">
                <span>Footer size</span>
                <input type="number" id="inpFooterSize" value="12" min="10" max="24">
              </label>
              <label class="ctrl">
                <span>Column header size</span>
                <input type="number" id="inpColumnHeaderSize" value="12" min="8" max="32">
              </label>
              <label class="ctrl">
                <span>Row label size</span>
                <input type="number" id="inpRowLabelSize" value="12" min="8" max="32">
              </label>
              <label class="ctrl">
                <span>Bar label size</span>
                <input type="number" id="inpBarLabelSize" value="11" min="8" max="32">
              </label>
            </div>
            <div class="ctrl-grid">
              <label class="ctrl">
                <span>Bar colour</span>
                <input type="color" id="inpBarColor" value="#4b4b4b">
              </label>
              <label class="ctrl">
                <span>Bar label colour</span>
                <input type="color" id="inpBarLabelColor" value="#ffffff">
              </label>
              <label class="ctrl">
                <span>Header band colour</span>
                <input type="color" id="inpHeaderBandColor" value="#efefef">
              </label>
              <label class="ctrl">
                <span>Grid line colour</span>
                <input type="color" id="inpGridColor" value="#bfbfbf">
              </label>
              <label class="ctrl">
                <span>Minor grid colour</span>
                <input type="color" id="inpMinorGridColor" value="#e5e5e5">
              </label>
              <label class="ctrl">
                <span>Axis/label colour</span>
                <input type="color" id="inpAxisColor" value="#111111">
              </label>
              <label class="ctrl">
                <span>Column header colour</span>
                <input type="color" id="inpColumnHeaderColor" value="#111111">
              </label>
              <label class="ctrl">
                <span>Row label colour</span>
                <input type="color" id="inpRowLabelColor" value="#111111">
              </label>
              <label class="ctrl">
                <span>Sheet background</span>
                <input type="color" id="inpSheetBgColor" value="#ffffff">
              </label>
              <label class="ctrl">
                <span>Sheet border</span>
                <input type="color" id="inpSheetBorderColor" value="#000000">
              </label>
              <label class="ctrl">
                <span>Page background</span>
                <input type="color" id="inpPageBgColor" value="#ffffff">
              </label>
            </div>
          </div>
        </details>
      </div>
    </div>

    <div class="sheets" id="sheets"></div>
      <div class="footer">Client‑side only. Uses pdf-lib to turn the SVG output into shareable landscape PDFs.</div>
  </div>

  <script src="pdf-lib.min.js"></script>
  <script>
    // ---------- Utilities ----------
    const pad2=n=>String(n).padStart(2,'0');
    const toMin=(h,m)=>parseInt(h,10)*60+parseInt(m,10);
    const fmtHM=mins=>{const m=((mins%1440)+1440)%1440;const h=Math.floor(m/60), mm=m%60;return `${pad2(h)}:${pad2(mm)}`};
    const fmtHMDisplay=mins=>{
      if(Number.isNaN(mins)) return '';
      const total=((mins%1440)+1440)%1440;
      const hours=Math.floor(total/60);
      const minutes=total%60;
      const suffix=hours>=12?'pm':'am';
      const hour12=(hours%12)||12;
      const minutePart=minutes===0?'':`:${pad2(minutes)}`;
      return `${hour12}${minutePart}${suffix}`;
    };

    function cleanColleagueName(raw){
      if(typeof raw!=='string') return '';
      const trimmed=raw.trim();
      if(!trimmed) return '';
      const noId=trimmed.replace(/\s*\([^)]*\)\s*/g,' ').trim();
      if(!noId) return trimmed;
      const parts=noId.split(/\s+/);
      return parts.length?parts[parts.length-1]:trimmed;
    }

    const STATIC_CODE='7774';
    const DAY_NAME_MAP={sun:'Sunday',mon:'Monday',tue:'Tuesday',wed:'Wednesday',thu:'Thursday',fri:'Friday',sat:'Saturday'};
    const MONTH_NAMES=['January','February','March','April','May','June','July','August','September','October','November','December'];

    function ordinal(n){
      const rem10=n%10;
      const rem100=n%100;
      if(rem10===1 && rem100!==11) return `${n}st`;
      if(rem10===2 && rem100!==12) return `${n}nd`;
      if(rem10===3 && rem100!==13) return `${n}rd`;
      return `${n}th`;
    }

    function parseDayHeader(label){
      if(!label) return null;
      const match=label.match(/([A-Za-z]{3,})\s*\(?\s*(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\s*\)?/);
      if(!match) return null;
      const [,dayPart,dayStr,monthStr,yearStr]=match;
      const dayNum=parseInt(dayStr,10);
      const monthNum=parseInt(monthStr,10);
      if(Number.isNaN(dayNum) || Number.isNaN(monthNum)) return null;
      const key=dayPart.slice(0,3).toLowerCase();
      const dayName=DAY_NAME_MAP[key] || dayPart;
      let year=undefined;
      if(yearStr){
        const yr=parseInt(yearStr,10);
        if(!Number.isNaN(yr)){
          year=yearStr.length===2?2000+yr:yr;
        }
      }
      return {dayName,day:dayNum,month:monthNum,year};
    }

    function formatFullDayLabel(label){
      const parsed=parseDayHeader(label);
      if(!parsed) return label;
      const monthName=MONTH_NAMES[parsed.month-1] || '';
      const pieces=[parsed.dayName || '', ordinal(parsed.day), monthName];
      if(parsed.year) pieces.push(parsed.year);
      return pieces.filter(Boolean).join(' ');
    }

    function formatRangeDate(part){
      if(!part) return '';
      const day=pad2(part.day);
      const month=pad2(part.month);
      return `${day}/${month}${part.year?`/${part.year}`:''}`;
    }

    function buildDateRangeLabel(model){
      if(model && typeof model.sub==='string'){
        const match=model.sub.match(/Date\s*range\s*:\s*(.+)/i);
        if(match) return `Date range: ${match[1].trim()}`;
      }
      if(!model || !Array.isArray(model.dayHeaders) || !model.dayHeaders.length) return '';
      const parsed=model.dayHeaders.map(parseDayHeader).filter(Boolean);
      if(!parsed.length) return '';
      const start=parsed[0];
      const end=parsed[parsed.length-1];
      const startStr=formatRangeDate(start);
      const endStr=formatRangeDate(end);
      if(!startStr && !endStr) return '';
      if(startStr && endStr) return `Date range: ${startStr} - ${endStr}`;
      return `Date range: ${startStr || endStr}`;
    }

    const DEFAULT_LAYOUT={
      title:'Daily Colleague Summary',
      subtitleOverride:'',
      staticCode:STATIC_CODE,
      footerTemplate:'Page {page} of {total}',
      footerNote:'',
      rowHeight:28,
      chartWidth:1150,
      nameColumnWidth:140,
      headerHeight:36,
      padding:14,
      titleSize:26,
      subtitleSize:22,
      codeSize:21,
      dateSize:16,
      footerSize:12,
      columnHeaderSize:12,
      rowLabelSize:12,
      barLabelSize:11,
      barColor:'#4b4b4b',
      barLabelColor:'#ffffff',
      headerBandColor:'#efefef',
      gridColor:'#bfbfbf',
      minorGridColor:'#e5e5e5',
      axisColor:'#111111',
      columnHeaderColor:'#111111',
      rowLabelColor:'#111111',
      sheetBackground:'#ffffff',
      sheetBorder:'#000000',
      pageBackground:'#ffffff',
    };

    let currentLayout={...DEFAULT_LAYOUT};

    function readControlValue(id){
      const el=document.getElementById(id);
      return el?el.value:'';
    }

    function readNumberValue(id,fallback){
      const raw=readControlValue(id);
      const num=parseFloat(raw);
      return Number.isFinite(num)?num:fallback;
    }

    function getLayoutSettings(){
      const layout={...DEFAULT_LAYOUT};
      layout.title=readControlValue('inpTitle')||DEFAULT_LAYOUT.title;
      layout.subtitleOverride=readControlValue('inpSubtitle').trim();
      const staticCode=readControlValue('inpStaticCode').trim();
      layout.staticCode=staticCode||DEFAULT_LAYOUT.staticCode;
      layout.footerTemplate=readControlValue('inpFooter')||DEFAULT_LAYOUT.footerTemplate;
      layout.footerNote=readControlValue('inpFooterNote').trim();
      layout.rowHeight=readNumberValue('inpRowHeight',DEFAULT_LAYOUT.rowHeight);
      layout.chartWidth=readNumberValue('inpChartWidth',DEFAULT_LAYOUT.chartWidth);
      layout.nameColumnWidth=DEFAULT_LAYOUT.nameColumnWidth;
      layout.headerHeight=readNumberValue('inpHeaderHeight',DEFAULT_LAYOUT.headerHeight);
      layout.padding=readNumberValue('inpPadding',DEFAULT_LAYOUT.padding);
      layout.titleSize=readNumberValue('inpTitleSize',DEFAULT_LAYOUT.titleSize);
      layout.subtitleSize=DEFAULT_LAYOUT.subtitleSize;
      layout.codeSize=DEFAULT_LAYOUT.codeSize;
      layout.dateSize=readNumberValue('inpDateSize',DEFAULT_LAYOUT.dateSize);
      layout.footerSize=readNumberValue('inpFooterSize',DEFAULT_LAYOUT.footerSize);
      layout.columnHeaderSize=readNumberValue('inpColumnHeaderSize',DEFAULT_LAYOUT.columnHeaderSize);
      layout.rowLabelSize=readNumberValue('inpRowLabelSize',DEFAULT_LAYOUT.rowLabelSize);
      layout.barLabelSize=readNumberValue('inpBarLabelSize',DEFAULT_LAYOUT.barLabelSize);
      layout.barColor=readControlValue('inpBarColor')||DEFAULT_LAYOUT.barColor;
      layout.barLabelColor=readControlValue('inpBarLabelColor')||DEFAULT_LAYOUT.barLabelColor;
      layout.headerBandColor=readControlValue('inpHeaderBandColor')||DEFAULT_LAYOUT.headerBandColor;
      layout.gridColor=readControlValue('inpGridColor')||DEFAULT_LAYOUT.gridColor;
      layout.minorGridColor=readControlValue('inpMinorGridColor')||DEFAULT_LAYOUT.minorGridColor;
      layout.axisColor=readControlValue('inpAxisColor')||DEFAULT_LAYOUT.axisColor;
      layout.columnHeaderColor=readControlValue('inpColumnHeaderColor')||DEFAULT_LAYOUT.columnHeaderColor;
      layout.rowLabelColor=readControlValue('inpRowLabelColor')||DEFAULT_LAYOUT.rowLabelColor;
      layout.sheetBackground=readControlValue('inpSheetBgColor')||DEFAULT_LAYOUT.sheetBackground;
      layout.sheetBorder=readControlValue('inpSheetBorderColor')||DEFAULT_LAYOUT.sheetBorder;
      layout.pageBackground=readControlValue('inpPageBgColor')||DEFAULT_LAYOUT.pageBackground;
      return layout;
    }

    function applyLayoutCssVariables(style,layout){
      if(!style || typeof style.setProperty!=='function') return;
      style.setProperty('--page-bg',layout.pageBackground);
      style.setProperty('--sheet-bg',layout.sheetBackground);
      style.setProperty('--sheet-border',layout.sheetBorder);
      style.setProperty('--sheet-header-band',layout.headerBandColor);
      style.setProperty('--sheet-title-size',`${layout.titleSize}px`);
      style.setProperty('--sheet-range-size',`${layout.subtitleSize}px`);
      style.setProperty('--sheet-code-size',`${layout.codeSize}px`);
      style.setProperty('--sheet-date-size',`${layout.dateSize}px`);
      style.setProperty('--sheet-footer-size',`${layout.footerSize}px`);
      style.setProperty('--column-header-size',`${layout.columnHeaderSize}px`);
      style.setProperty('--column-header-color',layout.columnHeaderColor);
      style.setProperty('--row-label-size',`${layout.rowLabelSize}px`);
      style.setProperty('--bar-label-size',`${layout.barLabelSize}px`);
      style.setProperty('--bar-color',layout.barColor);
      style.setProperty('--bar-label-color',layout.barLabelColor);
      style.setProperty('--header-band-color',layout.headerBandColor);
      style.setProperty('--grid-color',layout.gridColor);
      style.setProperty('--minor-grid-color',layout.minorGridColor);
      style.setProperty('--axis-color',layout.axisColor);
      style.setProperty('--row-label-color',layout.rowLabelColor);
    }

    function applyLayoutToElement(element,layout){
      if(!element) return;
      applyLayoutCssVariables(element.style,layout);
    }

    function applyLayoutToDocument(layout){
      applyLayoutCssVariables(document.documentElement.style,layout);
    }

    function buildSvgStyleBlock(theme){
      const axis=theme.axisColor;
      const columnHeaderColor=theme.columnHeaderColor || axis;
      const columnHeaderSize=theme.columnHeaderSize || DEFAULT_LAYOUT.columnHeaderSize;
      const axisLabelSize=Math.max(10,Math.round((theme.axisLabelSize||columnHeaderSize*0.9)));
      const rowLabelColor=theme.rowLabelColor || DEFAULT_LAYOUT.rowLabelColor;
      const rowLabelSize=theme.rowLabelSize || DEFAULT_LAYOUT.rowLabelSize;
      const barLabelColor=theme.barLabelColor || DEFAULT_LAYOUT.barLabelColor;
      const barLabelSize=theme.barLabelSize || DEFAULT_LAYOUT.barLabelSize;
      return `
      .axislabel{fill:${axis};font-size:${axisLabelSize}px;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
      .colheader{fill:${columnHeaderColor};font-size:${columnHeaderSize}px;font-weight:700;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif;text-transform:uppercase}
      .rowlabel{fill:${rowLabelColor};font-size:${rowLabelSize}px;dominant-baseline:middle;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
      .gridline{stroke:${theme.gridColor};stroke-width:1}
      .gridline-minor{stroke:${theme.minorGridColor};stroke-width:.6}
      .divider{stroke:${theme.sheetBorder};stroke-width:1.2}
      .headerband{fill:${theme.headerBandColor}}
      .tick-major{stroke:${axis};stroke-width:1}
      .tick-minor{stroke:${axis};stroke-width:.4;opacity:.5}
      .bar{fill:${theme.barColor}}
      .barlabel{fill:${barLabelColor};font-size:${barLabelSize}px;font-weight:700;dominant-baseline:middle;font-family:"Arial","Helvetica Neue",Helvetica,sans-serif}
      `;
    }

    function formatFooterText(template,ctx){
      if(!template) return '';
      return template
        .replace(/\{page\}/gi,String(ctx.pageNumber||''))
        .replace(/\{total\}/gi,String(ctx.totalPages||''))
        .replace(/\{date\}/gi,ctx.formattedDate||'')
        .replace(/\{label\}/gi,ctx.label||'');
    }

    // ---------- Parsing ----------
    function parseExport(text){
      text=text.replace(/^\"|\"$/g,'').replace(/\r/g,'');
      const lines=text.split('\n').map(x=>x.trim()).filter(Boolean);
      const headerIdx=lines.findIndex(l=>l.startsWith('Employee,'));
      if(headerIdx===-1) throw new Error('Header row starting with "Employee," not found.');
      const title=lines[0]||''; const sub=lines[1]||'';
      const header=lines[headerIdx].split(',');
      const dayHeaders=header.slice(1,8); // Sun..Sat
      const rows=[];
      for(let i=headerIdx+1;i<lines.length;i++){
        const parts=lines[i].split(',');
        if(parts.length<8) continue;
        const name=cleanColleagueName(parts[0]);
        const days=parts.slice(1,8);
        rows.push({name,days});
      }
      return {title,sub,dayHeaders,rows};
    }

    function pickRange(cell,{fallbackSCH}){
      if(!cell) return null;
      // Prefer Whole Shift
      let m=cell.match(/Whole\s*Shift:\s*(\d{1,2}):(\d{1,2})\s*-\s*(\d{1,2}):(\d{1,2})/i);
      if(!m && fallbackSCH){
        m=cell.match(/SCH:\s*(\d{1,2}):(\d{1,2})\s*-\s*(\d{1,2}):(\d{1,2})/i);
      }
      if(!m) return null;
      let s=toMin(m[1],m[2]), e=toMin(m[3],m[4]);
      if(e<s) e+=1440; // overnight
      return {start:s,end:e};
    }

    function segmentsForRange(range,splitMidnight){
      if(!range) return [];
      const segments=[];
      let start=Math.max(0,Math.min(1440,range.start));
      let end=Math.max(0,range.end);
      if(splitMidnight && end>1440){
        segments.push({start,end:1440});
        let remaining=end-1440;
        while(remaining>0){
          const segEnd=Math.min(remaining,1440);
          if(segEnd>0) segments.push({start:0,end:segEnd});
          remaining-=1440;
        }
        return segments;
      }
      end=Math.min(end,1440);
      if(end<=start) return [];
      return [{start,end}];
    }

    function buildPerDay(model,opts){
      const dayCount=model.dayHeaders.length;
      const perDay=Array.from({length:dayCount},()=>[]);
      model.rows.forEach(row=>{
        const daySegments=Array.from({length:dayCount},()=>[]);
        const dayRanges=Array.from({length:dayCount},()=>null);
        for(let dayIdx=0;dayIdx<dayCount;dayIdx++){
          const cell=row.days[dayIdx];
          const rng=pickRange(cell,opts);
          if(!rng) continue;
          if(!opts.splitMidnight){
            const segs=segmentsForRange(rng,false);
            if(!segs.length) continue;
            segs.forEach(seg=>{
              const start=Math.max(0,seg.start);
              const end=Math.max(0,seg.end);
              if(end<=start) return;
              daySegments[dayIdx].push({start,end});
            });
            if(daySegments[dayIdx].length){
              if(rng){
                dayRanges[dayIdx]={start:rng.start,end:Math.max(rng.end,rng.start)};
              }else{
                const starts=daySegments[dayIdx].map(s=>s.start);
                const ends=daySegments[dayIdx].map(s=>s.end);
                const merged={start:Math.min(...starts),end:Math.max(...ends)};
                dayRanges[dayIdx]=merged;
              }
            }
            continue;
          }
          const clampedStart=Math.max(0,Math.min(1440,rng.start));
          const startAbs=dayIdx*1440+clampedStart;
          const rawEnd=Math.max(rng.end,rng.start);
          const endAbs=dayIdx*1440+Math.max(rawEnd,clampedStart);
          if(!Number.isFinite(startAbs) || !Number.isFinite(endAbs) || endAbs<=startAbs) continue;
          for(let targetDay=dayIdx;targetDay<dayCount;targetDay++){
            const dayStart=targetDay*1440;
            const dayEnd=dayStart+1440;
            const segStartAbs=Math.max(startAbs,dayStart);
            const segEndAbs=Math.min(endAbs,dayEnd);
            if(segEndAbs>segStartAbs){
              const localStart=Math.max(0,Math.min(1440,segStartAbs-dayStart));
              const localEnd=Math.max(0,Math.min(1440,segEndAbs-dayStart));
              if(localEnd>localStart){
                daySegments[targetDay].push({start:localStart,end:localEnd});
                const existing=dayRanges[targetDay];
                if(existing){
                  existing.start=Math.min(existing.start,localStart);
                  existing.end=Math.max(existing.end,localEnd);
                }else{
                  dayRanges[targetDay]={start:localStart,end:localEnd};
                }
              }
            }
            if(segEndAbs>=endAbs || endAbs<=dayEnd) break;
          }
        }
        for(let dayIdx=0;dayIdx<dayCount;dayIdx++){
          const segs=daySegments[dayIdx];
          segs.sort((a,b)=>a.start-b.start);
          const range=dayRanges[dayIdx]?{...dayRanges[dayIdx]}:null;
          perDay[dayIdx].push({name:row.name, range, segments:segs.map(s=>({...s}))});
        }
      });
      return perDay;
    }

    // ---------- Layout & Draw ----------
    function drawDayCard(container,label,rows,ctx={}){
      const layout=ctx.layout || currentLayout || DEFAULT_LAYOUT;
      const P=Math.max(0,layout.padding);
      const W=Math.max(400,layout.chartWidth);
      const rowH=Math.max(18,layout.rowHeight);
      const leftAxis=Math.max(120,layout.nameColumnWidth);
      const innerW=Math.max(100,W-leftAxis-P*2);
      const headerHeight=Math.max(24,layout.headerHeight);
      const visibleRows=rows.filter(r=>r.range);
      const bodyRows=visibleRows.length?visibleRows:[{name:'No scheduled colleagues',range:null,segments:[]}];
      const bodyHeight=rowH*bodyRows.length;
      const H=P+headerHeight+bodyHeight+P;
      const svgNS='http://www.w3.org/2000/svg';
      const svg=document.createElementNS(svgNS,'svg');
      svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
      svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
      svg.setAttribute('font-family','Arial, "Helvetica Neue", Helvetica, sans-serif');

      const style=document.createElementNS(svgNS,'style');
      style.textContent=buildSvgStyleBlock(layout);
      svg.appendChild(style);

      const bg=document.createElementNS(svgNS,'rect');
      bg.setAttribute('x',0);bg.setAttribute('y',0);bg.setAttribute('width',W);bg.setAttribute('height',H);bg.setAttribute('fill',layout.sheetBackground);
      svg.appendChild(bg);

      const border=document.createElementNS(svgNS,'rect');
      border.setAttribute('x',0);border.setAttribute('y',0);border.setAttribute('width',W);border.setAttribute('height',H);
      border.setAttribute('fill','none');border.setAttribute('stroke',layout.sheetBorder);border.setAttribute('stroke-width','1');
      svg.appendChild(border);

      const headerBand=document.createElementNS(svgNS,'rect');
      headerBand.setAttribute('x',P);headerBand.setAttribute('y',P);
      headerBand.setAttribute('width',W-P*2);headerBand.setAttribute('height',headerHeight);
      headerBand.setAttribute('class','headerband');
      svg.appendChild(headerBand);

      const columnDivider=document.createElementNS(svgNS,'line');
      columnDivider.setAttribute('x1',P+leftAxis);
      columnDivider.setAttribute('y1',P);
      columnDivider.setAttribute('x2',P+leftAxis);
      columnDivider.setAttribute('y2',H-P);
      columnDivider.setAttribute('class','divider');
      svg.appendChild(columnDivider);

      const headerLine=document.createElementNS(svgNS,'line');
      headerLine.setAttribute('x1',P);headerLine.setAttribute('y1',P+headerHeight);
      headerLine.setAttribute('x2',W-P);headerLine.setAttribute('y2',P+headerHeight);
      headerLine.setAttribute('class','divider');
      svg.appendChild(headerLine);

      const headerTop=P;
      const headerBottom=P+headerHeight;
      const bodyTop=headerBottom;
      const headerTextBaseline=headerTop+18;
      const axisBaseline=headerBottom-6;
      const axisLabelOffset=6;

      const nameHeader=document.createElementNS(svgNS,'text');
      nameHeader.setAttribute('x',P+6);nameHeader.setAttribute('y',headerTextBaseline);
      nameHeader.setAttribute('class','colheader');
      nameHeader.textContent='Colleague Names';
      svg.appendChild(nameHeader);

      const toX=m=>P+leftAxis+(m/1440)*innerW;
      for(let minute=0;minute<=1440;minute+=15){
        const x=toX(minute);
        const isHour=minute%60===0;

        if(isHour && minute>0 && minute<1440){
          const headerLine=document.createElementNS(svgNS,'line');
          headerLine.setAttribute('x1',x);
          headerLine.setAttribute('y1',headerTop);
          headerLine.setAttribute('x2',x);
          headerLine.setAttribute('y2',headerBottom);
          headerLine.setAttribute('class','gridline');
          svg.appendChild(headerLine);
        }

        if(minute>0 && minute<1440){
          const vline=document.createElementNS(svgNS,'line');
          vline.setAttribute('x1',x);
          vline.setAttribute('y1',bodyTop);
          vline.setAttribute('x2',x);
          vline.setAttribute('y2',H-P);
          vline.setAttribute('class',isHour?'gridline':'gridline-minor');
          svg.appendChild(vline);
        }

        if(isHour && minute<1440){
          const axisText=document.createElementNS(svgNS,'text');
          axisText.setAttribute('x',x+axisLabelOffset);
          axisText.setAttribute('y',axisBaseline);
          axisText.setAttribute('text-anchor','start');
          axisText.setAttribute('class','axislabel');
          axisText.textContent=fmtHMDisplay(minute);
          svg.appendChild(axisText);
        }
      }

      bodyRows.forEach((row,idx)=>{
        const y=bodyTop+idx*rowH;
        if(idx>0){
          const baseline=document.createElementNS(svgNS,'line');
          baseline.setAttribute('x1',P);
          baseline.setAttribute('y1',y);
          baseline.setAttribute('x2',W-P);
          baseline.setAttribute('y2',y);
          baseline.setAttribute('class','gridline');
          svg.appendChild(baseline);
        }

        const name=document.createElementNS(svgNS,'text');
        name.setAttribute('x',P+6);
        name.setAttribute('y',y+rowH/2);
        name.setAttribute('class','rowlabel');
        name.textContent=row.name;
        svg.appendChild(name);

        if(row.range){
          const labelText=`${fmtHMDisplay(row.range.start)} - ${fmtHMDisplay(row.range.end)}`;
          row.segments.forEach((seg,segIdx)=>{
            const segY=y+4;
            const segHeight=rowH-8;
            const rect=document.createElementNS(svgNS,'rect');
            rect.setAttribute('x',toX(seg.start));
            rect.setAttribute('y',segY);
            rect.setAttribute('width',Math.max(2,toX(seg.end)-toX(seg.start)));
            rect.setAttribute('height',segHeight);
            rect.setAttribute('class','bar');
            svg.appendChild(rect);

            if(segIdx===0){
              const label=document.createElementNS(svgNS,'text');
              label.setAttribute('x',toX(seg.start)+4);
              label.setAttribute('y',segY+segHeight/2+1);
              label.setAttribute('class','barlabel');
              label.textContent=labelText;
              svg.appendChild(label);
            }
          });
        }
      });

      const finalLine=document.createElementNS(svgNS,'line');
      finalLine.setAttribute('x1',P);
      finalLine.setAttribute('y1',bodyTop+bodyRows.length*rowH);
      finalLine.setAttribute('x2',W-P);
      finalLine.setAttribute('y2',bodyTop+bodyRows.length*rowH);
      finalLine.setAttribute('class','divider');
      svg.appendChild(finalLine);

      const section=document.createElement('section');
      section.className='sheet';

      const header=document.createElement('header');
      header.className='sheet-header';

      const titleEl=document.createElement('div');
      titleEl.className='sheet-title';
      titleEl.textContent=layout.title || DEFAULT_LAYOUT.title;
      header.appendChild(titleEl);

      const rangeLabel=(ctx.dateRangeLabel || '').trim();
      if(rangeLabel){
        const rangeEl=document.createElement('div');
        rangeEl.className='sheet-range';
        rangeEl.textContent=rangeLabel;
        header.appendChild(rangeEl);
      }

      const codeEl=document.createElement('div');
      codeEl.className='sheet-code';
      const resolvedCode=(ctx.staticCode || layout.staticCode || STATIC_CODE).trim();
      codeEl.textContent=resolvedCode;
      header.appendChild(codeEl);

      const dateEl=document.createElement('div');
      dateEl.className='sheet-date';
      dateEl.textContent=ctx.formattedDate || formatFullDayLabel(label);
      header.appendChild(dateEl);

      section.appendChild(header);
      section.appendChild(svg);

      if(layout.footerNote){
        const note=document.createElement('div');
        note.className='sheet-footnote';
        note.textContent=layout.footerNote;
        section.appendChild(note);
      }

      const footerText=formatFooterText(layout.footerTemplate,{pageNumber:ctx.pageNumber,totalPages:ctx.totalPages,formattedDate:ctx.formattedDate,label:label});
      if(footerText){
        const footer=document.createElement('div');
        footer.className='sheet-footer';
        footer.textContent=footerText;
        section.appendChild(footer);
      }

      container.appendChild(section);
      return {section, svg};
    }

    // ---------- Render / Export ----------
    let lastModel=null,lastPerDay=null,lastRenderDetails=null,lastSourceText='';

    function render(text){
      const opts={fallbackSCH:document.getElementById('chkFallback').checked, splitMidnight:document.getElementById('chkSplit').checked};
      const layout=getLayoutSettings();
      applyLayoutToDocument(layout);
      currentLayout=layout;
      let model; try{ model=parseExport(text);}catch(e){ alert(e.message); return; }
      lastSourceText=text;
      const perDay=buildPerDay(model,opts);
      lastModel=model; lastPerDay=perDay;

      const autoRangeLabel=buildDateRangeLabel(model);
      const resolvedRangeLabel=layout.subtitleOverride || autoRangeLabel;
      const totalPages=model.dayHeaders.length;
      const formattedDates=model.dayHeaders.map(formatFullDayLabel);
      lastRenderDetails={dateRangeLabel:resolvedRangeLabel,formattedDates,totalPages,layout};

      const sheets=document.getElementById('sheets'); sheets.innerHTML='';
      model.dayHeaders.forEach((label,i)=>{
        drawDayCard(sheets,label,perDay[i],{
          dateRangeLabel:resolvedRangeLabel,
          pageNumber:i+1,
          totalPages,
          formattedDate:formattedDates[i],
          staticCode:layout.staticCode,
          layout,
        });
      });
    }

    function sanitizeFileName(name){
      return name.replace(/[^\w\d\-_]+/g,'_').replace(/_+/g,'_').replace(/^_|_$/g,'') || 'gantt';
    }

    function buildPdfSheetPlan(rows,layout,{title,rangeLabel,code,date,footerText,footerNote},palette){
      const paddingOuter=18;
      const blockGap=12;
      const lineGap=6;
      const lineHeightFactor=1.2;
      const P=Math.max(0,layout.padding);
      const W=Math.max(400,layout.chartWidth);
      const rowH=Math.max(18,layout.rowHeight);
      const leftAxis=Math.max(120,layout.nameColumnWidth);
      const innerW=Math.max(100,W-leftAxis-P*2);
      const headerHeight=Math.max(24,layout.headerHeight);
      const visibleRows=rows.filter(r=>r.range);
      const bodyRows=visibleRows.length?visibleRows:[{name:'No scheduled colleagues',range:null,segments:[]}];
      const bodyHeight=rowH*bodyRows.length;
      const chartHeight=P+headerHeight+bodyHeight+P;
      const sheetWidth=W+paddingOuter*2;
      const headerLines=[];
      if(title){
        headerLines.push({text:title,size:layout.titleSize||DEFAULT_LAYOUT.titleSize,color:palette.ink,weight:600});
      }
      if(rangeLabel){
        headerLines.push({text:rangeLabel,size:layout.subtitleSize||DEFAULT_LAYOUT.subtitleSize,color:palette.muted,weight:400});
      }
      if(code){
        headerLines.push({text:code,size:layout.codeSize||DEFAULT_LAYOUT.codeSize,color:palette.ink,weight:700});
      }
      if(date){
        headerLines.push({text:date,size:layout.dateSize||DEFAULT_LAYOUT.dateSize,color:palette.ink,weight:600});
      }
      let cursorY=paddingOuter;
      const headerPlacements=headerLines.map((line,idx)=>{
        const top=cursorY;
        cursorY+=line.size*lineHeightFactor;
        if(idx<headerLines.length-1) cursorY+=lineGap;
        return {...line,top};
      });
      if(headerLines.length) cursorY+=blockGap;
      const chartTop=cursorY;
      cursorY+=chartHeight;
      const footerNotes=[];
      if(footerNote){
        cursorY+=blockGap;
        const size=layout.footerSize||DEFAULT_LAYOUT.footerSize;
        const top=cursorY;
        cursorY+=size*lineHeightFactor;
        footerNotes.push({text:footerNote,size,color:palette.muted,top});
      }
      const pageFooter=footerText?{text:footerText,size:layout.footerSize||DEFAULT_LAYOUT.footerSize,color:palette.muted}:null;
      const sheetHeight=cursorY+paddingOuter;
      return {
        sheetWidth,
        sheetHeight,
        paddingOuter,
        header:headerPlacements,
        footerNotes,
        pageFooter,
        chart:{
          left:paddingOuter,
          top:chartTop,
          width:W,
          height:chartHeight,
          padding:P,
          headerHeight,
          leftAxis,
          innerWidth:innerW,
          rowHeight:rowH,
          bodyRows,
          columnHeaderSize:layout.columnHeaderSize||DEFAULT_LAYOUT.columnHeaderSize,
          rowLabelSize:layout.rowLabelSize||DEFAULT_LAYOUT.rowLabelSize,
          barLabelSize:layout.barLabelSize||DEFAULT_LAYOUT.barLabelSize,
          axisLabelSize:Math.max(10,Math.round((layout.columnHeaderSize||DEFAULT_LAYOUT.columnHeaderSize)*0.9)),
          axisLabelOffset:6,
        },
      };
    }

    function drawPdfSheet(page,plan,{fonts,palette,rgb,scaleLimit=1,margin=24}){
      const pageWidth=page.getWidth();
      const pageHeight=page.getHeight();
      const availableWidth=pageWidth-margin*2;
      const availableHeight=pageHeight-margin*2;
      const scale=Math.min(scaleLimit,availableWidth/plan.sheetWidth,availableHeight/plan.sheetHeight,1);
      const offsetX=margin+(availableWidth-plan.sheetWidth*scale)/2;
      const offsetY=margin+Math.max(0,availableHeight-plan.sheetHeight*scale);

      const toPageX=x=>offsetX+x*scale;
      const toPageYTop=y=>offsetY+(plan.sheetHeight-y)*scale;
      const rectCoords=(x,y,width,height)=>({
        x:toPageX(x),
        y:offsetY+(plan.sheetHeight-(y+height))*scale,
        width:width*scale,
        height:height*scale,
      });
      const lineCoords=(x1,y1,x2,y2)=>({
        start:{x:toPageX(x1),y:toPageYTop(y1)},
        end:{x:toPageX(x2),y:toPageYTop(y2)},
      });
      const drawLine=(x1,y1,x2,y2,color,width,extra={})=>{
        page.drawLine({
          ...lineCoords(x1,y1,x2,y2),
          thickness:Math.max(width*scale,0.25),
          color:rgb(color.r,color.g,color.b),
          opacity:extra.opacity,
        });
      };
      const drawRect=(x,y,width,height,options={})=>{
        page.drawRectangle({
          ...rectCoords(x,y,width,height),
          color:options.fill?rgb(options.fill.r,options.fill.g,options.fill.b):undefined,
          borderColor:options.stroke?rgb(options.stroke.r,options.stroke.g,options.stroke.b):undefined,
          borderWidth:options.strokeWidth?Math.max(options.strokeWidth*scale,0.25):undefined,
        });
      };
      const drawText=(text,{x,y,size,color,fontWeight=400,align='left',baseline='alphabetic'})=>{
        if(!text) return;
        const font=fontWeight>=600?fonts.bold:fonts.regular;
        const fontSize=Math.max(0.1,size*scale);
        const width=font.widthOfTextAtSize(text,fontSize);
        let pageX=toPageX(x);
        if(align==='center') pageX-=width/2;
        if(align==='right') pageX-=width;
        let pageY=toPageYTop(y);
        if(baseline==='top'){
          pageY-=font.heightAtSize(fontSize);
        }else if(baseline==='middle'){
          pageY-=font.heightAtSize(fontSize)/2;
        }
        page.drawText(text,{
          x:pageX,
          y:pageY,
          size:fontSize,
          font,
          color:rgb(color.r,color.g,color.b),
        });
      };

      const sheetBg=palette.sheetBackground;
      const sheetBorder=palette.sheetBorder;
      drawRect(0,0,plan.sheetWidth,plan.sheetHeight,{fill:sheetBg});

      plan.header.forEach(line=>{
        drawText(line.text,{
          x:plan.paddingOuter||18,
          y:line.top,
          size:line.size,
          color:line.color||palette.ink,
          fontWeight:line.weight||400,
          baseline:'top',
        });
      });

      const chart=plan.chart;
      const chartLeft=chart.left;
      const chartTop=chart.top;
      const chartWidth=chart.width;
      const chartHeight=chart.height;
      const innerPadding=chart.padding;
      const headerHeight=chart.headerHeight;
      const leftAxis=chart.leftAxis;
      const innerW=chart.innerWidth;
      const rowH=chart.rowHeight;
      const headerTop=chartTop+innerPadding;
      const headerBottom=headerTop+headerHeight;
      const bodyTop=headerBottom;
      const axisBaseline=headerBottom-6;
      const axisLabelOffset=chart.axisLabelOffset||6;
      const axisLabelSize=chart.axisLabelSize||12;
      drawRect(chartLeft,chartTop,chartWidth,chartHeight,{fill:sheetBg,stroke:sheetBorder,strokeWidth:1});
      drawRect(chartLeft+innerPadding,chartTop+innerPadding,chartWidth-innerPadding*2,headerHeight,{fill:palette.headerBand});

      drawLine(chartLeft+innerPadding+leftAxis,chartTop+innerPadding,chartLeft+innerPadding+leftAxis,chartTop+chartHeight-innerPadding,palette.sheetBorder,1.2);
      drawLine(chartLeft+innerPadding,headerBottom,chartLeft+chartWidth-innerPadding,headerBottom,palette.sheetBorder,1.2);

      const headerTextBaseline=headerTop+18;
      drawText('Colleague Names',{
        x:chartLeft+innerPadding+6,
        y:headerTextBaseline,
        size:chart.columnHeaderSize,
        color:palette.columnHeader,
        fontWeight:700,
      });

      const toX=minute=>chartLeft+innerPadding+leftAxis+(minute/1440)*innerW;
      for(let minute=0;minute<=1440;minute+=15){
        const x=toX(minute);
        const isHour=minute%60===0;
        const color=isHour?palette.grid:palette.minorGrid;
        const strokeWidth=isHour?1:0.6;

        if(isHour && minute>0 && minute<1440){
          drawLine(x,headerTop,x,headerBottom,palette.grid,1);
        }

        if(minute>0 && minute<1440){
          drawLine(x,headerBottom,x,chartTop+chartHeight-innerPadding,color,strokeWidth);
        }

        if(isHour && minute<1440){
          drawText(fmtHMDisplay(minute),{
            x:x+axisLabelOffset,
            y:axisBaseline,
            size:axisLabelSize,
            color:palette.axis,
          });
        }
      }

      chart.bodyRows.forEach((row,idx)=>{
        const rowTop=bodyTop+idx*rowH;
        if(idx>0){
          drawLine(chartLeft+innerPadding,rowTop,chartLeft+chartWidth-innerPadding,rowTop,palette.grid,1);
        }
        drawText(row.name,{
          x:chartLeft+innerPadding+6,
          y:rowTop+rowH/2,
          size:chart.rowLabelSize,
          color:palette.rowLabel,
          baseline:'middle',
        });
        if(row.range){
          const labelText=`${fmtHMDisplay(row.range.start)} - ${fmtHMDisplay(row.range.end)}`;
          row.segments.forEach((seg,segIdx)=>{
            const segY=rowTop+4;
            const segHeight=rowH-8;
            const segX=toX(seg.start);
            const segW=Math.max(2,toX(seg.end)-segX);
            drawRect(segX,segY,segW,segHeight,{fill:palette.bar});
            if(segIdx===0){
              drawText(labelText,{
                x:segX+4,
                y:segY+segHeight/2+1,
                size:chart.barLabelSize,
                color:palette.barLabel,
                fontWeight:700,
                baseline:'middle',
              });
            }
          });
        }
      });

      drawLine(chartLeft+innerPadding,bodyTop+chart.bodyRows.length*rowH,chartLeft+chartWidth-innerPadding,bodyTop+chart.bodyRows.length*rowH,palette.sheetBorder,1.2);

      if(Array.isArray(plan.footerNotes)){
        plan.footerNotes.forEach(item=>{
          drawText(item.text,{
            x:plan.sheetWidth-plan.paddingOuter,
            y:item.top,
            size:item.size,
            color:item.color||palette.muted,
            align:'right',
            baseline:'top',
          });
        });
      }

      if(plan.pageFooter && plan.pageFooter.text){
        const footer=plan.pageFooter;
        const font=footer.fontWeight>=600?fonts.bold:fonts.regular;
        const footerSize=Math.max(0.1,footer.size*scale);
        const textWidth=font.widthOfTextAtSize(footer.text,footerSize);
        const x=pageWidth-margin-textWidth;
        const y=Math.max(4,margin/2);
        page.drawText(footer.text,{
          x,
          y,
          size:footerSize,
          font,
          color:rgb((footer.color||palette.muted).r,(footer.color||palette.muted).g,(footer.color||palette.muted).b),
        });
      }
    }

    function parseHexColor(color){
      if(!color || typeof color!=='string') return null;
      const hex=color.trim();
      const match=hex.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
      if(!match) return null;
      let value=match[1];
      if(value.length===3){
        value=value.split('').map(ch=>ch+ch).join('');
      }
      const int=parseInt(value,16);
      const r=(int>>16)&255;
      const g=(int>>8)&255;
      const b=int&255;
      return {r:r/255,g:g/255,b:b/255};
    }

    function parseCssColor(color){
      if(!color || typeof color!=='string') return null;
      const hex=parseHexColor(color);
      if(hex) return hex;
      const match=color.trim().match(/^rgba?\(([^)]+)\)$/i);
      if(!match) return null;
      const parts=match[1].split(',').map(part=>part.trim()).filter(Boolean);
      if(parts.length<3) return null;
      const nums=parts.slice(0,3).map(val=>{
        if(val.endsWith('%')){
          const pct=parseFloat(val);
          if(!Number.isFinite(pct)) return NaN;
          return Math.max(0,Math.min(100,pct))/100*255;
        }
        const num=parseFloat(val);
        return Number.isFinite(num)?num:NaN;
      });
      if(nums.some(v=>!Number.isFinite(v))) return null;
      const [r,g,b]=nums;
      return {r:Math.max(0,Math.min(255,r))/255,g:Math.max(0,Math.min(255,g))/255,b:Math.max(0,Math.min(255,b))/255};
    }

    function buildPdfPalette(layout){
      const computed=getComputedStyle(document.documentElement);
      const inkRaw=(computed.getPropertyValue('--ink')||'#111111').trim()||'#111111';
      const mutedRaw=(computed.getPropertyValue('--muted')||'#555555').trim()||'#555555';
      const getColor=(value,def)=>parseCssColor(value)||parseCssColor(def)||{r:0,g:0,b:0};
      return {
        ink:getColor(inkRaw,'#111111'),
        muted:getColor(mutedRaw,'#555555'),
        sheetBackground:getColor(layout.sheetBackground,DEFAULT_LAYOUT.sheetBackground),
        sheetBorder:getColor(layout.sheetBorder,DEFAULT_LAYOUT.sheetBorder),
        headerBand:getColor(layout.headerBandColor,DEFAULT_LAYOUT.headerBandColor),
        grid:getColor(layout.gridColor,DEFAULT_LAYOUT.gridColor),
        minorGrid:getColor(layout.minorGridColor,DEFAULT_LAYOUT.minorGridColor),
        axis:getColor(layout.axisColor,DEFAULT_LAYOUT.axisColor),
        columnHeader:getColor(layout.columnHeaderColor,layout.axisColor||DEFAULT_LAYOUT.columnHeaderColor),
        rowLabel:getColor(layout.rowLabelColor,DEFAULT_LAYOUT.rowLabelColor),
        bar:getColor(layout.barColor,DEFAULT_LAYOUT.barColor),
        barLabel:getColor(layout.barLabelColor,DEFAULT_LAYOUT.barLabelColor),
      };
    }

    async function exportPDF(){
      const btn=document.getElementById('btnExport');
      if(btn.disabled) return;
      if(!lastModel){
        const t=document.getElementById('input').value.trim();
        if(!t) return;
        render(t);
        if(!lastModel) return;
      }
      if(!window.PDFLib){
        alert('PDF generator failed to load. Please refresh and try again.');
        return;
      }
      const originalLabel=btn.textContent;
      btn.disabled=true;
      btn.textContent='Exporting…';
      try{
        const {PDFDocument, rgb, StandardFonts}=window.PDFLib;
        const pdfDoc=await PDFDocument.create();
        const fontRegular=await pdfDoc.embedFont(StandardFonts.Helvetica);
        const fontBold=await pdfDoc.embedFont(StandardFonts.HelveticaBold);
        const margin=24;
        const pageSize=[842,595];
        const renderInfo=lastRenderDetails || {};
        const layout=renderInfo.layout || currentLayout || DEFAULT_LAYOUT;
        const palette=buildPdfPalette(layout);
        const pageBg=parseCssColor(layout.pageBackground);
        const formattedDates=(renderInfo.formattedDates && renderInfo.formattedDates.length?renderInfo.formattedDates:lastModel.dayHeaders.map(formatFullDayLabel));
        const totalPages=renderInfo.totalPages || lastModel.dayHeaders.length;
        const dateRangeLabel=renderInfo.dateRangeLabel || layout.subtitleOverride || buildDateRangeLabel(lastModel);
        for(let i=0;i<lastModel.dayHeaders.length;i++){
          const label=lastModel.dayHeaders[i];
          const rowsForDay=Array.isArray(lastPerDay[i])?lastPerDay[i]:[];
          const resolvedCode=(layout.staticCode||STATIC_CODE||'').trim();
          const footerText=formatFooterText(layout.footerTemplate,{
            pageNumber:i+1,
            totalPages,
            formattedDate:formattedDates[i],
            label,
          });
          const footerNote=(layout.footerNote||'').trim();
          const plan=buildPdfSheetPlan(rowsForDay,layout,{
            title:layout.title||DEFAULT_LAYOUT.title,
            rangeLabel:dateRangeLabel,
            code:resolvedCode,
            date:formattedDates[i],
            footerText,
            footerNote,
          },palette);
          const page=pdfDoc.addPage(pageSize);
          const pageWidth=page.getWidth();
          const pageHeight=page.getHeight();
          if(pageBg){
            page.drawRectangle({x:0,y:0,width:pageWidth,height:pageHeight,color:rgb(pageBg.r,pageBg.g,pageBg.b)});
          }
          drawPdfSheet(page,plan,{
            fonts:{regular:fontRegular,bold:fontBold},
            palette,
            rgb,
            margin,
          });
        }
        const pdfBytes=await pdfDoc.save();
        const blob=new Blob([pdfBytes],{type:'application/pdf'});
        const url=URL.createObjectURL(blob);
        const link=document.createElement('a');
        link.href=url;
        link.download=`${sanitizeFileName(dateRangeLabel || 'schedule')}.pdf`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        setTimeout(()=>URL.revokeObjectURL(url),5000);
      }catch(err){
        console.error(err);
        alert(`Failed to export PDF: ${err.message}`);
      }finally{
        btn.disabled=false;
        btn.textContent=originalLabel;
      }
    }

    function handleLayoutControlChange(){
      if(lastSourceText){
        render(lastSourceText);
      }else{
        const layout=getLayoutSettings();
        applyLayoutToDocument(layout);
        currentLayout=layout;
      }
    }

    // ---------- Sample & Wire-up ----------
    document.getElementById('btnRender').addEventListener('click',()=>{
      const text=document.getElementById('input').value.trim();
      if(!text){ alert('Paste an export into the text area before rendering.'); return; }
      render(text);
    });
    document.getElementById('btnExport').addEventListener('click',()=>{ exportPDF(); });
    document.getElementById('chkFallback').addEventListener('change',()=>{
      const text=document.getElementById('input').value.trim();
      if(text) render(text);
    });
    document.getElementById('chkSplit').addEventListener('change',()=>{
      const text=document.getElementById('input').value.trim();
      if(text) render(text);
    });

    const layoutControlIds=[
      'inpTitle','inpSubtitle','inpStaticCode','inpFooter','inpFooterNote','inpRowHeight','inpChartWidth','inpNameWidth','inpHeaderHeight','inpPadding','inpTitleSize','inpRangeSize','inpCodeSize','inpDateSize','inpFooterSize','inpColumnHeaderSize','inpRowLabelSize','inpBarLabelSize','inpBarColor','inpBarLabelColor','inpHeaderBandColor','inpGridColor','inpMinorGridColor','inpAxisColor','inpColumnHeaderColor','inpRowLabelColor','inpSheetBgColor','inpSheetBorderColor','inpPageBgColor'
    ];
    layoutControlIds.forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener('input',handleLayoutControlChange);
      el.addEventListener('change',handleLayoutControlChange);
    });

    // First paint
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('input').value='';
      applyLayoutToDocument(currentLayout);
    });
  </script>
</body>
</html>
